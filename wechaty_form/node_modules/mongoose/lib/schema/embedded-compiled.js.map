{"version":3,"sources":["embedded.js"],"names":[],"mappings":"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","file":"embedded-compiled.js","sourcesContent":["'use strict';\n\n/*!\n * Module dependencies.\n */\n\nvar $exists = require('./operators/exists');\nvar EventEmitter = require('events').EventEmitter;\nvar SchemaType = require('../schematype');\nvar Subdocument = require('../types/subdocument');\nvar applyHooks = require('../services/model/applyHooks');\nvar castToNumber = require('./operators/helpers').castToNumber;\nvar geospatial = require('./operators/geospatial');\n\nmodule.exports = Embedded;\n\n/**\n * Sub-schema schematype constructor\n *\n * @param {Schema} schema\n * @param {String} key\n * @param {Object} options\n * @inherits SchemaType\n * @api public\n */\n\nfunction Embedded(schema, path, options) {\n  var _embedded = function SingleNested(value, path, parent) {\n    var _this = this;\n    Subdocument.apply(this, arguments);\n    this.$parent = parent;\n    if (parent) {\n      parent.on('save', function() {\n        _this.emit('save', _this);\n        _this.constructor.emit('save', _this);\n      });\n\n      parent.on('isNew', function(val) {\n        _this.isNew = val;\n        _this.emit('isNew', val);\n        _this.constructor.emit('isNew', val);\n      });\n    }\n  };\n  _embedded.prototype = Object.create(Subdocument.prototype);\n  _embedded.prototype.$__setSchema(schema);\n  _embedded.prototype.constructor = _embedded;\n  _embedded.schema = schema;\n  _embedded.$isSingleNested = true;\n  _embedded.prototype.$basePath = path;\n  _embedded.prototype.toBSON = function() {\n    return this.toObject({\n      transform: false,\n      retainKeyOrder: schema.options.retainKeyOrder,\n      virtuals: false,\n      _skipDepopulateTopLevel: true,\n      depopulate: true,\n      flattenDecimals: false\n    });\n  };\n\n  // apply methods\n  for (var i in schema.methods) {\n    _embedded.prototype[i] = schema.methods[i];\n  }\n\n  // apply statics\n  for (i in schema.statics) {\n    _embedded[i] = schema.statics[i];\n  }\n\n  for (i in EventEmitter.prototype) {\n    _embedded[i] = EventEmitter.prototype[i];\n  }\n\n  applyHooks(_embedded, schema);\n\n  this.caster = _embedded;\n  this.schema = schema;\n  this.$isSingleNested = true;\n  SchemaType.call(this, path, options, 'Embedded');\n}\n\nEmbedded.prototype = Object.create(SchemaType.prototype);\n\n/**\n * Special case for when users use a common location schema to represent\n * locations for use with $geoWithin.\n * https://docs.mongodb.org/manual/reference/operator/query/geoWithin/\n *\n * @param {Object} val\n * @api private\n */\n\nEmbedded.prototype.$conditionalHandlers.$geoWithin = function(val) {\n  return { $geometry: this.castForQuery(val.$geometry) };\n};\n\n/*!\n * ignore\n */\n\nEmbedded.prototype.$conditionalHandlers.$near =\nEmbedded.prototype.$conditionalHandlers.$nearSphere = geospatial.cast$near;\n\nEmbedded.prototype.$conditionalHandlers.$within =\nEmbedded.prototype.$conditionalHandlers.$geoWithin = geospatial.cast$within;\n\nEmbedded.prototype.$conditionalHandlers.$geoIntersects =\n  geospatial.cast$geoIntersects;\n\nEmbedded.prototype.$conditionalHandlers.$minDistance = castToNumber;\nEmbedded.prototype.$conditionalHandlers.$maxDistance = castToNumber;\n\nEmbedded.prototype.$conditionalHandlers.$exists = $exists;\n\n/**\n * Casts contents\n *\n * @param {Object} value\n * @api private\n */\n\nEmbedded.prototype.cast = function(val, doc, init) {\n  if (val && val.$isSingleNested) {\n    return val;\n  }\n  var subdoc = new this.caster(void 0, doc ? doc.$__.selected : void 0, doc);\n  if (init) {\n    subdoc.init(val);\n  } else {\n    subdoc.set(val, undefined, true);\n  }\n  return subdoc;\n};\n\n/**\n * Casts contents for query\n *\n * @param {string} [$conditional] optional query operator (like `$eq` or `$in`)\n * @param {any} value\n * @api private\n */\n\nEmbedded.prototype.castForQuery = function($conditional, val) {\n  var handler;\n  if (arguments.length === 2) {\n    handler = this.$conditionalHandlers[$conditional];\n    if (!handler) {\n      throw new Error('Can\\'t use ' + $conditional);\n    }\n    return handler.call(this, val);\n  }\n  val = $conditional;\n  if (val == null) {\n    return val;\n  }\n\n  return new this.caster(val);\n};\n\n/**\n * Async validation on this single nested doc.\n *\n * @api private\n */\n\nEmbedded.prototype.doValidate = function(value, fn, scope) {\n  var Constructor = this.caster;\n  SchemaType.prototype.doValidate.call(this, value, function(error) {\n    if (error) {\n      return fn(error);\n    }\n    if (!value) {\n      return fn(null);\n    }\n    if (!(value instanceof Constructor)) {\n      value = new Constructor(value);\n    }\n    value.validate({__noPromise: true}, fn);\n  }, scope);\n};\n\n/**\n * Synchronously validate this single nested doc\n *\n * @api private\n */\n\nEmbedded.prototype.doValidateSync = function(value, scope) {\n  var schemaTypeError = SchemaType.prototype.doValidateSync.call(this, value, scope);\n  if (schemaTypeError) {\n    return schemaTypeError;\n  }\n  if (!value) {\n    return;\n  }\n  return value.validateSync();\n};\n"]}