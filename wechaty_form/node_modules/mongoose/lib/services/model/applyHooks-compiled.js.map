{"version":3,"sources":["applyHooks.js"],"names":[],"mappings":"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","file":"applyHooks-compiled.js","sourcesContent":["'use strict';\n\nvar PromiseProvider = require('../../promise_provider');\nvar VersionError = require('../../error').VersionError;\n\nmodule.exports = applyHooks;\n\n/*!\n * Register hooks for this model\n *\n * @param {Model} model\n * @param {Schema} schema\n */\n\nfunction applyHooks(model, schema) {\n  var q = schema && schema.callQueue;\n  var toWrapEl;\n  var len;\n  var i;\n  var j;\n  var pointCut;\n  var keys;\n  var newName;\n  if (!q.length) {\n    return;\n  }\n\n  // we are only interested in 'pre' hooks, and group by point-cut\n  var toWrap = { post: [] };\n  var pair;\n\n  for (i = 0; i < q.length; ++i) {\n    pair = q[i];\n    if (pair[0] !== 'pre' && pair[0] !== 'post' && pair[0] !== 'on') {\n      continue;\n    }\n    var args = [].slice.call(pair[1]);\n    pointCut = pair[0] === 'on' ? 'post' : args[0];\n    if (!(pointCut in toWrap)) {\n      toWrap[pointCut] = {post: [], pre: []};\n    }\n    if (pair[0] === 'post') {\n      toWrap[pointCut].post.push(args);\n    } else if (pair[0] === 'on') {\n      toWrap[pointCut].push(args);\n    } else {\n      toWrap[pointCut].pre.push(args);\n    }\n  }\n\n  // 'post' hooks are simpler\n  len = toWrap.post.length;\n  toWrap.post.forEach(function(args) {\n    model.on.apply(model, args);\n  });\n  delete toWrap.post;\n\n  // 'init' should be synchronous on subdocuments\n  if (toWrap.init && (model.$isSingleNested || model.$isArraySubdocument)) {\n    if (toWrap.init.pre) {\n      toWrap.init.pre.forEach(function(args) {\n        model.prototype.$pre.apply(model.prototype, args);\n      });\n    }\n    if (toWrap.init.post) {\n      toWrap.init.post.forEach(function(args) {\n        model.prototype.$post.apply(model.prototype, args);\n      });\n    }\n    delete toWrap.init;\n  }\n  if (toWrap.set) {\n    // Set hooks also need to be sync re: gh-3479\n    newName = '$__original_set';\n    model.prototype[newName] = model.prototype.set;\n    if (toWrap.set.pre) {\n      toWrap.set.pre.forEach(function(args) {\n        model.prototype.$pre.apply(model.prototype, args);\n      });\n    }\n    if (toWrap.set.post) {\n      toWrap.set.post.forEach(function(args) {\n        model.prototype.$post.apply(model.prototype, args);\n      });\n    }\n    delete toWrap.set;\n  }\n\n  keys = Object.keys(toWrap);\n  len = keys.length;\n  for (i = 0; i < len; ++i) {\n    pointCut = keys[i];\n    // this is so we can wrap everything into a promise;\n    newName = ('$__original_' + pointCut);\n    if (!model.prototype[pointCut]) {\n      return;\n    }\n    if (!model.prototype[pointCut].$originalFunction) {\n      model.prototype[newName] = model.prototype[pointCut];\n    }\n    model.prototype[pointCut] = (function(_newName) {\n      return function wrappedPointCut() {\n        var Promise = PromiseProvider.get();\n\n        var _this = this;\n        var args = [].slice.call(arguments);\n        var lastArg = args.pop();\n        var fn;\n        var originalError = new Error();\n        var $results;\n        if (lastArg && typeof lastArg !== 'function') {\n          args.push(lastArg);\n        } else {\n          fn = lastArg;\n        }\n\n        var promise = new Promise.ES6(function(resolve, reject) {\n          args.push(function(error) {\n            if (error) {\n              // gh-2633: since VersionError is very generic, take the\n              // stack trace of the original save() function call rather\n              // than the async trace\n              if (error instanceof VersionError) {\n                error.stack = originalError.stack;\n              }\n              if (!fn) {\n                _this.$__handleReject(error);\n              }\n              reject(error);\n              return;\n            }\n\n            // There may be multiple results and promise libs other than\n            // mpromise don't support passing multiple values to `resolve()`\n            $results = Array.prototype.slice.call(arguments, 1);\n            resolve.apply(promise, $results);\n          });\n\n          _this[_newName].apply(_this, args);\n        });\n        if (fn) {\n          if (this.constructor.$wrapCallback) {\n            fn = this.constructor.$wrapCallback(fn);\n          }\n          promise.then(\n            function() {\n              process.nextTick(function() {\n                fn.apply(null, [null].concat($results));\n              });\n            },\n            function(error) {\n              process.nextTick(function() {\n                fn(error);\n              });\n            });\n        }\n        return promise;\n      };\n    })(newName);\n    model.prototype[pointCut].$originalFunction = newName;\n\n    toWrapEl = toWrap[pointCut];\n    var _len = toWrapEl.pre.length;\n    for (j = 0; j < _len; ++j) {\n      args = toWrapEl.pre[j];\n      args[0] = newName;\n      model.prototype.$pre.apply(model.prototype, args);\n    }\n\n    _len = toWrapEl.post.length;\n    for (j = 0; j < _len; ++j) {\n      args = toWrapEl.post[j];\n      args[0] = newName;\n      model.prototype.$post.apply(model.prototype, args);\n    }\n  }\n}\n"]}