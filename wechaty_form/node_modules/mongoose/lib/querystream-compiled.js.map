{"version":3,"sources":["querystream.js"],"names":[],"mappings":"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","file":"querystream-compiled.js","sourcesContent":["/* eslint no-empty: 1 */\n\n/*!\n * Module dependencies.\n */\n\nvar Stream = require('stream').Stream;\nvar utils = require('./utils');\nvar helpers = require('./queryhelpers');\nvar K = function(k) {\n  return k;\n};\n\n/**\n * Provides a Node.js 0.8 style [ReadStream](http://nodejs.org/docs/v0.8.21/api/stream.html#stream_readable_stream) interface for Queries.\n *\n *     var stream = Model.find().stream();\n *\n *     stream.on('data', function (doc) {\n *       // do something with the mongoose document\n *     }).on('error', function (err) {\n *       // handle the error\n *     }).on('close', function () {\n *       // the stream is closed\n *     });\n *\n *\n * The stream interface allows us to simply \"plug-in\" to other _Node.js 0.8_ style write streams.\n *\n *     Model.where('created').gte(twoWeeksAgo).stream().pipe(writeStream);\n *\n * ####Valid options\n *\n *   - `transform`: optional function which accepts a mongoose document. The return value of the function will be emitted on `data`.\n *\n * ####Example\n *\n *     // JSON.stringify all documents before emitting\n *     var stream = Thing.find().stream({ transform: JSON.stringify });\n *     stream.pipe(writeStream);\n *\n * _NOTE: plugging into an HTTP response will *not* work out of the box. Those streams expect only strings or buffers to be emitted, so first formatting our documents as strings/buffers is necessary._\n *\n * _NOTE: these streams are Node.js 0.8 style read streams which differ from Node.js 0.10 style. Node.js 0.10 streams are not well tested yet and are not guaranteed to work._\n *\n * @param {Query} query\n * @param {Object} [options]\n * @inherits NodeJS Stream http://nodejs.org/docs/v0.8.21/api/stream.html#stream_readable_stream\n * @event `data`: emits a single Mongoose document\n * @event `error`: emits when an error occurs during streaming. This will emit _before_ the `close` event.\n * @event `close`: emits when the stream reaches the end of the cursor or an error occurs, or the stream is manually `destroy`ed. After this event, no more events are emitted.\n * @api public\n */\n\nfunction QueryStream(query, options) {\n  Stream.call(this);\n\n  this.query = query;\n  this.readable = true;\n  this.paused = false;\n  this._cursor = null;\n  this._destroyed = null;\n  this._fields = null;\n  this._buffer = null;\n  this._inline = T_INIT;\n  this._running = false;\n  this._transform = options && typeof options.transform === 'function'\n      ? options.transform\n      : K;\n\n  // give time to hook up events\n  var _this = this;\n  process.nextTick(function() {\n    _this._init();\n  });\n}\n\n/*!\n * Inherit from Stream\n */\n\nQueryStream.prototype.__proto__ = Stream.prototype;\n\n/**\n * Flag stating whether or not this stream is readable.\n *\n * @property readable\n * @api public\n */\n\nQueryStream.prototype.readable;\n\n/**\n * Flag stating whether or not this stream is paused.\n *\n * @property paused\n * @api public\n */\n\nQueryStream.prototype.paused;\n\n// trampoline flags\nvar T_INIT = 0;\nvar T_IDLE = 1;\nvar T_CONT = 2;\n\n/**\n * Initializes the query.\n *\n * @api private\n */\n\nQueryStream.prototype._init = function() {\n  if (this._destroyed) {\n    return;\n  }\n\n  var query = this.query,\n      model = query.model,\n      options = query._optionsForExec(model),\n      _this = this;\n\n  try {\n    query.cast(model);\n  } catch (err) {\n    return _this.destroy(err);\n  }\n\n  _this._fields = utils.clone(query._fields);\n  options.fields = query._castFields(_this._fields);\n\n  model.collection.find(query._conditions, options, function(err, cursor) {\n    if (err) {\n      return _this.destroy(err);\n    }\n    _this._cursor = cursor;\n    _this._next();\n  });\n};\n\n/**\n * Trampoline for pulling the next doc from cursor.\n *\n * @see QueryStream#__next #querystream_QueryStream-__next\n * @api private\n */\n\nQueryStream.prototype._next = function _next() {\n  if (this.paused || this._destroyed) {\n    this._running = false;\n    return this._running;\n  }\n\n  this._running = true;\n\n  if (this._buffer && this._buffer.length) {\n    var arg;\n    while (!this.paused && !this._destroyed && (arg = this._buffer.shift())) { // eslint-disable-line no-cond-assign\n      this._onNextObject.apply(this, arg);\n    }\n  }\n\n  // avoid stack overflows with large result sets.\n  // trampoline instead of recursion.\n  while (this.__next()) {\n  }\n};\n\n/**\n * Pulls the next doc from the cursor.\n *\n * @see QueryStream#_next #querystream_QueryStream-_next\n * @api private\n */\n\nQueryStream.prototype.__next = function() {\n  if (this.paused || this._destroyed) {\n    this._running = false;\n    return this._running;\n  }\n\n  var _this = this;\n  _this._inline = T_INIT;\n\n  _this._cursor.nextObject(function cursorcb(err, doc) {\n    _this._onNextObject(err, doc);\n  });\n\n  // if onNextObject() was already called in this tick\n  // return ourselves to the trampoline.\n  if (T_CONT === this._inline) {\n    return true;\n  }\n  // onNextObject() hasn't fired yet. tell onNextObject\n  // that its ok to call _next b/c we are not within\n  // the trampoline anymore.\n  this._inline = T_IDLE;\n};\n\n/**\n * Transforms raw `doc`s returned from the cursor into a model instance.\n *\n * @param {Error|null} err\n * @param {Object} doc\n * @api private\n */\n\nQueryStream.prototype._onNextObject = function _onNextObject(err, doc) {\n  if (this._destroyed) {\n    return;\n  }\n\n  if (this.paused) {\n    this._buffer || (this._buffer = []);\n    this._buffer.push([err, doc]);\n    this._running = false;\n    return this._running;\n  }\n\n  if (err) {\n    return this.destroy(err);\n  }\n\n  // when doc is null we hit the end of the cursor\n  if (!doc) {\n    this.emit('end');\n    return this.destroy();\n  }\n\n  var opts = this.query._mongooseOptions;\n\n  if (!opts.populate) {\n    return opts.lean === true ?\n        emit(this, doc) :\n        createAndEmit(this, null, doc);\n  }\n\n  var _this = this;\n  var pop = helpers.preparePopulationOptionsMQ(_this.query, _this.query._mongooseOptions);\n\n  // Hack to work around gh-3108\n  pop.forEach(function(option) {\n    delete option.model;\n  });\n\n  pop.__noPromise = true;\n  _this.query.model.populate(doc, pop, function(err, doc) {\n    if (err) {\n      return _this.destroy(err);\n    }\n    return opts.lean === true ?\n        emit(_this, doc) :\n        createAndEmit(_this, pop, doc);\n  });\n};\n\nfunction createAndEmit(self, populatedIds, doc) {\n  var instance = helpers.createModel(self.query.model, doc, self._fields);\n  var opts = populatedIds ?\n    {populated: populatedIds} :\n    undefined;\n\n  instance.init(doc, opts, function(err) {\n    if (err) {\n      return self.destroy(err);\n    }\n    emit(self, instance);\n  });\n}\n\n/*!\n * Emit a data event and manage the trampoline state\n */\n\nfunction emit(self, doc) {\n  self.emit('data', self._transform(doc));\n\n  // trampoline management\n  if (T_IDLE === self._inline) {\n    // no longer in trampoline. restart it.\n    self._next();\n  } else {\n    // in a trampoline. tell __next that its\n    // ok to continue jumping.\n    self._inline = T_CONT;\n  }\n}\n\n/**\n * Pauses this stream.\n *\n * @api public\n */\n\nQueryStream.prototype.pause = function() {\n  this.paused = true;\n};\n\n/**\n * Resumes this stream.\n *\n * @api public\n */\n\nQueryStream.prototype.resume = function() {\n  this.paused = false;\n\n  if (!this._cursor) {\n    // cannot start if not initialized\n    return;\n  }\n\n  // are we within the trampoline?\n  if (T_INIT === this._inline) {\n    return;\n  }\n\n  if (!this._running) {\n    // outside QueryStream control, need manual restart\n    return this._next();\n  }\n};\n\n/**\n * Destroys the stream, closing the underlying cursor, which emits the close event. No more events will be emitted after the close event.\n *\n * @param {Error} [err]\n * @api public\n */\n\nQueryStream.prototype.destroy = function(err) {\n  if (this._destroyed) {\n    return;\n  }\n  this._destroyed = true;\n  this._running = false;\n  this.readable = false;\n\n  if (this._cursor) {\n    this._cursor.close();\n  }\n\n  if (err) {\n    this.emit('error', err);\n  }\n\n  this.emit('close');\n};\n\n/**\n * Pipes this query stream into another stream. This method is inherited from NodeJS Streams.\n *\n * ####Example:\n *\n *     query.stream().pipe(writeStream [, options])\n *\n * @method pipe\n * @memberOf QueryStream\n * @see NodeJS http://nodejs.org/api/stream.html\n * @api public\n */\n\n/*!\n * Module exports\n */\n\nmodule.exports = exports = QueryStream;\n"]}