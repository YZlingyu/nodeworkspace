{"version":3,"sources":["subdocument.js"],"names":[],"mappings":"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","file":"subdocument-compiled.js","sourcesContent":["var Document = require('../document');\nvar PromiseProvider = require('../promise_provider');\n\nmodule.exports = Subdocument;\n\n/**\n * Subdocument constructor.\n *\n * @inherits Document\n * @api private\n */\n\nfunction Subdocument(value, fields) {\n  this.$isSingleNested = true;\n  Document.call(this, value, fields);\n}\n\nSubdocument.prototype = Object.create(Document.prototype);\n\nSubdocument.prototype.toBSON = function() {\n  return this.toObject({\n    transform: false,\n    virtuals: false,\n    _skipDepopulateTopLevel: true,\n    depopulate: true,\n    flattenDecimals: false\n  });\n};\n\n/**\n * Used as a stub for [hooks.js](https://github.com/bnoguchi/hooks-js/tree/31ec571cef0332e21121ee7157e0cf9728572cc3)\n *\n * ####NOTE:\n *\n * _This is a no-op. Does not actually save the doc to the db._\n *\n * @param {Function} [fn]\n * @return {Promise} resolved Promise\n * @api private\n */\n\nSubdocument.prototype.save = function(fn) {\n  var Promise = PromiseProvider.get();\n  return new Promise.ES6(function(resolve) {\n    fn && fn();\n    resolve();\n  });\n};\n\nSubdocument.prototype.$isValid = function(path) {\n  if (this.$parent) {\n    return this.$parent.$isValid([this.$basePath, path].join('.'));\n  }\n};\n\nSubdocument.prototype.markModified = function(path) {\n  Document.prototype.markModified.call(this, path);\n  if (this.$parent) {\n    if (this.$parent.isDirectModified(this.$basePath)) {\n      return;\n    }\n    this.$parent.markModified([this.$basePath, path].join('.'));\n  }\n};\n\nSubdocument.prototype.$markValid = function(path) {\n  Document.prototype.$markValid.call(this, path);\n  if (this.$parent) {\n    this.$parent.$markValid([this.$basePath, path].join('.'));\n  }\n};\n\nSubdocument.prototype.invalidate = function(path, err, val) {\n  // Hack: array subdocuments' validationError is equal to the owner doc's,\n  // so validating an array subdoc gives the top-level doc back. Temporary\n  // workaround for #5208 so we don't have circular errors.\n  if (err !== this.ownerDocument().$__.validationError) {\n    Document.prototype.invalidate.call(this, path, err, val);\n  }\n\n  if (this.$parent) {\n    this.$parent.invalidate([this.$basePath, path].join('.'), err, val);\n  } else if (err.kind === 'cast' || err.name === 'CastError') {\n    throw err;\n  }\n};\n\n/**\n * Returns the top level document of this sub-document.\n *\n * @return {Document}\n */\n\nSubdocument.prototype.ownerDocument = function() {\n  if (this.$__.ownerDocument) {\n    return this.$__.ownerDocument;\n  }\n\n  var parent = this.$parent;\n  if (!parent) {\n    return this;\n  }\n\n  while (parent.$parent || parent.__parent) {\n    parent = parent.$parent || parent.__parent;\n  }\n  this.$__.ownerDocument = parent;\n  return this.$__.ownerDocument;\n};\n\n/**\n * Returns this sub-documents parent document.\n *\n * @api public\n */\n\nSubdocument.prototype.parent = function() {\n  return this.$parent;\n};\n\n/**\n * Null-out this subdoc\n *\n * @param {Object} [options]\n * @param {Function} [callback] optional callback for compatibility with Document.prototype.remove\n */\n\nSubdocument.prototype.remove = function(options, callback) {\n  if (typeof options === 'function') {\n    callback = options;\n    options = null;\n  }\n\n  // If removing entire doc, no need to remove subdoc\n  if (!options || !options.noop) {\n    this.$parent.set(this.$basePath, null);\n    registerRemoveListener(this);\n  }\n\n  if (typeof callback === 'function') {\n    callback(null);\n  }\n};\n\n/*!\n * ignore\n */\n\nSubdocument.prototype.populate = function() {\n  throw new Error('Mongoose does not support calling populate() on nested ' +\n    'docs. Instead of `doc.nested.populate(\"path\")`, use ' +\n    '`doc.populate(\"nested.path\")`');\n};\n\n/*!\n * Registers remove event listeners for triggering\n * on subdocuments.\n *\n * @param {EmbeddedDocument} sub\n * @api private\n */\n\nfunction registerRemoveListener(sub) {\n  var owner = sub.ownerDocument();\n\n  function emitRemove() {\n    owner.removeListener('save', emitRemove);\n    owner.removeListener('remove', emitRemove);\n    sub.emit('remove', sub);\n    sub.constructor.emit('remove', sub);\n    owner = sub = null;\n  }\n\n  owner.on('save', emitRemove);\n  owner.on('remove', emitRemove);\n}\n"]}