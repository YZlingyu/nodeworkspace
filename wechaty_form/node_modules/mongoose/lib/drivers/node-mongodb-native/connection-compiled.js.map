{"version":3,"sources":["connection.js"],"names":[],"mappings":"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","file":"connection-compiled.js","sourcesContent":["/*!\n * Module dependencies.\n */\n\nvar MongooseConnection = require('../../connection');\nvar mongo = require('mongodb');\nvar Db = mongo.Db;\nvar Server = mongo.Server;\nvar Mongos = mongo.Mongos;\nvar STATES = require('../../connectionstate');\nvar ReplSetServers = mongo.ReplSet;\nvar DisconnectedError = require('../../error/disconnected');\n\n/**\n * A [node-mongodb-native](https://github.com/mongodb/node-mongodb-native) connection implementation.\n *\n * @inherits Connection\n * @api private\n */\n\nfunction NativeConnection() {\n  MongooseConnection.apply(this, arguments);\n  this._listening = false;\n}\n\n/**\n * Expose the possible connection states.\n * @api public\n */\n\nNativeConnection.STATES = STATES;\n\n/*!\n * Inherits from Connection.\n */\n\nNativeConnection.prototype.__proto__ = MongooseConnection.prototype;\n\n/**\n * Opens the connection to MongoDB.\n *\n * @param {Function} fn\n * @return {Connection} this\n * @api private\n */\n\nNativeConnection.prototype.doOpen = function(fn) {\n  var _this = this;\n  var server = new Server(this.host, this.port, this.options.server);\n\n  if (this.options && this.options.mongos) {\n    var mongos = new Mongos([server], this.options.mongos);\n    this.db = new Db(this.name, mongos, this.options.db);\n  } else {\n    this.db = new Db(this.name, server, this.options.db);\n  }\n\n  this.db.open(function(err) {\n    listen(_this);\n\n    if (!mongos) {\n      server.s.server.on('error', function(error) {\n        if (/after \\d+ attempts/.test(error.message)) {\n          _this.emit('error', new DisconnectedError(server.s.server.name));\n        }\n      });\n    }\n\n    if (err) return fn(err);\n\n    fn();\n  });\n\n  return this;\n};\n\n/**\n * Switches to a different database using the same connection pool.\n *\n * Returns a new connection object, with the new db.\n *\n * @param {String} name The database name\n * @return {Connection} New Connection Object\n * @api public\n */\n\nNativeConnection.prototype.useDb = function(name) {\n  // we have to manually copy all of the attributes...\n  var newConn = new this.constructor();\n  newConn.name = name;\n  newConn.base = this.base;\n  newConn.collections = {};\n  newConn.models = {};\n  newConn.replica = this.replica;\n  newConn.hosts = this.hosts;\n  newConn.host = this.host;\n  newConn.port = this.port;\n  newConn.user = this.user;\n  newConn.pass = this.pass;\n  newConn.options = this.options;\n  newConn._readyState = this._readyState;\n  newConn._closeCalled = this._closeCalled;\n  newConn._hasOpened = this._hasOpened;\n  newConn._listening = false;\n\n  // First, when we create another db object, we are not guaranteed to have a\n  // db object to work with. So, in the case where we have a db object and it\n  // is connected, we can just proceed with setting everything up. However, if\n  // we do not have a db or the state is not connected, then we need to wait on\n  // the 'open' event of the connection before doing the rest of the setup\n  // the 'connected' event is the first time we'll have access to the db object\n\n  var _this = this;\n\n  if (this.db && this._readyState === STATES.connected) {\n    wireup();\n  } else {\n    this.once('connected', wireup);\n  }\n\n  function wireup() {\n    newConn.db = _this.db.db(name);\n    newConn.onOpen();\n    // setup the events appropriately\n    listen(newConn);\n  }\n\n  newConn.name = name;\n\n  // push onto the otherDbs stack, this is used when state changes\n  this.otherDbs.push(newConn);\n  newConn.otherDbs.push(this);\n\n  return newConn;\n};\n\n/*!\n * Register listeners for important events and bubble appropriately.\n */\n\nfunction listen(conn) {\n  if (conn.db._listening) {\n    return;\n  }\n  conn.db._listening = true;\n\n  conn.db.on('close', function() {\n    if (conn._closeCalled) return;\n\n    // the driver never emits an `open` event. auto_reconnect still\n    // emits a `close` event but since we never get another\n    // `open` we can't emit close\n    if (conn.db.serverConfig.autoReconnect) {\n      conn.readyState = STATES.disconnected;\n      conn.emit('close');\n      return;\n    }\n    conn.onClose();\n  });\n  conn.db.on('error', function(err) {\n    conn.emit('error', err);\n  });\n  conn.db.on('reconnect', function() {\n    conn.readyState = STATES.connected;\n    conn.emit('reconnected');\n    conn.onOpen();\n  });\n  conn.db.on('timeout', function(err) {\n    conn.emit('timeout', err);\n  });\n  conn.db.on('open', function(err, db) {\n    if (STATES.disconnected === conn.readyState && db && db.databaseName) {\n      conn.readyState = STATES.connected;\n      conn.emit('reconnected');\n    }\n  });\n  conn.db.on('parseError', function(err) {\n    conn.emit('parseError', err);\n  });\n}\n\n/**\n * Opens a connection to a MongoDB ReplicaSet.\n *\n * See description of [doOpen](#NativeConnection-doOpen) for server options. In this case `options.replset` is also passed to ReplSetServers.\n *\n * @param {Function} fn\n * @api private\n * @return {Connection} this\n */\n\nNativeConnection.prototype.doOpenSet = function(fn) {\n  var servers = [],\n      _this = this;\n\n  this.hosts.forEach(function(server) {\n    var host = server.host || server.ipc;\n    var port = server.port || 27017;\n    servers.push(new Server(host, port, _this.options.server));\n  });\n\n  var server = this.options.mongos\n    ? new Mongos(servers, this.options.mongos)\n    : new ReplSetServers(servers, this.options.replset || this.options.replSet);\n  this.db = new Db(this.name, server, this.options.db);\n\n  this.db.on('fullsetup', function() {\n    _this.emit('fullsetup');\n  });\n\n  this.db.on('all', function() {\n    _this.emit('all');\n  });\n\n  this.db.open(function(err) {\n    if (err) return fn(err);\n    fn();\n    listen(_this);\n  });\n\n  return this;\n};\n\n/**\n * Closes the connection\n *\n * @param {Function} fn\n * @return {Connection} this\n * @api private\n */\n\nNativeConnection.prototype.doClose = function(fn) {\n  this.db.close(fn);\n  return this;\n};\n\n/**\n * Prepares default connection options for the node-mongodb-native driver.\n *\n * _NOTE: `passed` options take precedence over connection string options._\n *\n * @param {Object} passed options that were passed directly during connection\n * @param {Object} [connStrOptions] options that were passed in the connection string\n * @api private\n */\n\nNativeConnection.prototype.parseOptions = function(passed, connStrOpts) {\n  var o = passed || {};\n  o.db || (o.db = {});\n  o.auth || (o.auth = {});\n  o.server || (o.server = {});\n  o.replset || (o.replset = o.replSet) || (o.replset = {});\n  o.server.socketOptions || (o.server.socketOptions = {});\n  o.replset.socketOptions || (o.replset.socketOptions = {});\n  o.mongos || (o.mongos = (connStrOpts && connStrOpts.mongos));\n  (o.mongos === true) && (o.mongos = {});\n\n  var opts = connStrOpts || {};\n  Object.keys(opts).forEach(function(name) {\n    switch (name) {\n      case 'ssl':\n        o.server.ssl = opts.ssl;\n        o.replset.ssl = opts.ssl;\n        o.mongos && (o.mongos.ssl = opts.ssl);\n        break;\n      case 'poolSize':\n        if (typeof o.server[name] === 'undefined') {\n          o.server[name] = o.replset[name] = opts[name];\n        }\n        break;\n      case 'slaveOk':\n        if (typeof o.server.slave_ok === 'undefined') {\n          o.server.slave_ok = opts[name];\n        }\n        break;\n      case 'autoReconnect':\n        if (typeof o.server.auto_reconnect === 'undefined') {\n          o.server.auto_reconnect = opts[name];\n        }\n        break;\n      case 'socketTimeoutMS':\n      case 'connectTimeoutMS':\n        if (typeof o.server.socketOptions[name] === 'undefined') {\n          o.server.socketOptions[name] = o.replset.socketOptions[name] = opts[name];\n        }\n        break;\n      case 'authdb':\n        if (typeof o.auth.authdb === 'undefined') {\n          o.auth.authdb = opts[name];\n        }\n        break;\n      case 'authSource':\n        if (typeof o.auth.authSource === 'undefined') {\n          o.auth.authSource = opts[name];\n        }\n        break;\n      case 'authMechanism':\n        if (typeof o.auth.authMechanism === 'undefined') {\n          o.auth.authMechanism = opts[name];\n        }\n        break;\n      case 'retries':\n      case 'reconnectWait':\n      case 'rs_name':\n        if (typeof o.replset[name] === 'undefined') {\n          o.replset[name] = opts[name];\n        }\n        break;\n      case 'replicaSet':\n        if (typeof o.replset.rs_name === 'undefined') {\n          o.replset.rs_name = opts[name];\n        }\n        break;\n      case 'readSecondary':\n        if (typeof o.replset.read_secondary === 'undefined') {\n          o.replset.read_secondary = opts[name];\n        }\n        break;\n      case 'nativeParser':\n        if (typeof o.db.native_parser === 'undefined') {\n          o.db.native_parser = opts[name];\n        }\n        break;\n      case 'w':\n      case 'safe':\n      case 'fsync':\n      case 'journal':\n      case 'wtimeoutMS':\n        if (typeof o.db[name] === 'undefined') {\n          o.db[name] = opts[name];\n        }\n        break;\n      case 'readPreference':\n        if (typeof o.db.readPreference === 'undefined') {\n          o.db.readPreference = opts[name];\n        }\n        break;\n      case 'readPreferenceTags':\n        if (typeof o.db.read_preference_tags === 'undefined') {\n          o.db.read_preference_tags = opts[name];\n        }\n        break;\n      case 'sslValidate':\n        o.server.sslValidate = opts.sslValidate;\n        o.replset.sslValidate = opts.sslValidate;\n        o.mongos && (o.mongos.sslValidate = opts.sslValidate);\n    }\n  });\n\n  if (!('auto_reconnect' in o.server)) {\n    o.server.auto_reconnect = true;\n  }\n\n  // mongoose creates its own ObjectIds\n  o.db.forceServerObjectId = false;\n\n  // default safe using new nomenclature\n  if (!('journal' in o.db || 'j' in o.db ||\n        'fsync' in o.db || 'safe' in o.db || 'w' in o.db)) {\n    o.db.w = 1;\n  }\n\n  if (o.promiseLibrary) {\n    o.db.promiseLibrary = o.promiseLibrary;\n  }\n\n  validate(o);\n  return o;\n};\n\n/*!\n * Validates the driver db options.\n *\n * @param {Object} o\n */\n\nfunction validate(o) {\n  if (o.db.w === -1 || o.db.w === 0) {\n    if (o.db.journal || o.db.fsync || o.db.safe) {\n      throw new Error(\n          'Invalid writeConcern: '\n        + 'w set to -1 or 0 cannot be combined with safe|fsync|journal');\n    }\n  }\n}\n\n/*!\n * Module exports.\n */\n\nmodule.exports = NativeConnection;\n"]}