{"version":3,"sources":["collection.js"],"names":[],"mappings":"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","file":"collection-compiled.js","sourcesContent":["/*!\n * Module dependencies.\n */\n\nvar MongooseCollection = require('../../collection'),\n    Collection = require('mongodb').Collection,\n    utils = require('../../utils');\n\n/**\n * A [node-mongodb-native](https://github.com/mongodb/node-mongodb-native) collection implementation.\n *\n * All methods methods from the [node-mongodb-native](https://github.com/mongodb/node-mongodb-native) driver are copied and wrapped in queue management.\n *\n * @inherits Collection\n * @api private\n */\n\nfunction NativeCollection() {\n  this.collection = null;\n  MongooseCollection.apply(this, arguments);\n}\n\n/*!\n * Inherit from abstract Collection.\n */\n\nNativeCollection.prototype.__proto__ = MongooseCollection.prototype;\n\n/**\n * Called when the connection opens.\n *\n * @api private\n */\n\nNativeCollection.prototype.onOpen = function() {\n  var _this = this;\n\n  // always get a new collection in case the user changed host:port\n  // of parent db instance when re-opening the connection.\n\n  if (!_this.opts.capped.size) {\n    // non-capped\n    callback(null, _this.conn.db.collection(_this.name));\n    return _this.collection;\n  }\n\n  // capped\n  return _this.conn.db.collection(_this.name, function(err, c) {\n    if (err) return callback(err);\n\n    // discover if this collection exists and if it is capped\n    _this.conn.db.listCollections({name: _this.name}).toArray(function(err, docs) {\n      if (err) {\n        return callback(err);\n      }\n      var doc = docs[0];\n      var exists = !!doc;\n\n      if (exists) {\n        if (doc.options && doc.options.capped) {\n          callback(null, c);\n        } else {\n          var msg = 'A non-capped collection exists with the name: ' + _this.name + '\\n\\n'\n              + ' To use this collection as a capped collection, please '\n              + 'first convert it.\\n'\n              + ' http://www.mongodb.org/display/DOCS/Capped+Collections#CappedCollections-Convertingacollectiontocapped';\n          err = new Error(msg);\n          callback(err);\n        }\n      } else {\n        // create\n        var opts = utils.clone(_this.opts.capped);\n        opts.capped = true;\n        _this.conn.db.createCollection(_this.name, opts, callback);\n      }\n    });\n  });\n\n  function callback(err, collection) {\n    if (err) {\n      // likely a strict mode error\n      _this.conn.emit('error', err);\n    } else {\n      _this.collection = collection;\n      MongooseCollection.prototype.onOpen.call(_this);\n    }\n  }\n};\n\n/**\n * Called when the connection closes\n *\n * @api private\n */\n\nNativeCollection.prototype.onClose = function() {\n  MongooseCollection.prototype.onClose.call(this);\n};\n\n/*!\n * Copy the collection methods and make them subject to queues\n */\n\nfunction iter(i) {\n  NativeCollection.prototype[i] = function() {\n    if (this.buffer) {\n      this.addQueue(i, arguments);\n      return;\n    }\n\n    var collection = this.collection;\n    var args = arguments;\n    var _this = this;\n    var debug = _this.conn.base.options.debug;\n\n    if (debug) {\n      if (typeof debug === 'function') {\n        debug.apply(_this,\n          [_this.name, i].concat(utils.args(args, 0, args.length - 1)));\n      } else {\n        this.$print(_this.name, i, args);\n      }\n    }\n\n    try {\n      return collection[i].apply(collection, args);\n    } catch (error) {\n      // Collection operation may throw because of max bson size, catch it here\n      // See gh-3906\n      if (args.length > 0 &&\n          typeof args[args.length - 1] === 'function') {\n        args[args.length - 1](error);\n      } else {\n        throw error;\n      }\n    }\n  };\n}\n\nfor (var i in Collection.prototype) {\n  // Janky hack to work around gh-3005 until we can get rid of the mongoose\n  // collection abstraction\n  try {\n    if (typeof Collection.prototype[i] !== 'function') {\n      continue;\n    }\n  } catch (e) {\n    continue;\n  }\n\n  iter(i);\n}\n\n/**\n * Debug print helper\n *\n * @api public\n * @method $print\n */\n\nNativeCollection.prototype.$print = function(name, i, args) {\n  var moduleName = '\\x1B[0;36mMongoose:\\x1B[0m ';\n  var functionCall = [name, i].join('.');\n  var _args = [];\n  for (var j = args.length - 1; j >= 0; --j) {\n    if (this.$format(args[j]) || _args.length) {\n      _args.unshift(this.$format(args[j]));\n    }\n  }\n  var params = '(' + _args.join(', ') + ')';\n\n  console.error(moduleName + functionCall + params);\n};\n\n/**\n * Formatter for debug print args\n *\n * @api public\n * @method $format\n */\n\nNativeCollection.prototype.$format = function(arg) {\n  var type = typeof arg;\n  if (type === 'function' || type === 'undefined') return '';\n  return format(arg);\n};\n\n/*!\n * Debug print helper\n */\n\nfunction map(o) {\n  return format(o, true);\n}\nfunction formatObjectId(x, key) {\n  var representation = 'ObjectId(\"' + x[key].toHexString() + '\")';\n  x[key] = {inspect: function() { return representation; }};\n}\nfunction formatDate(x, key) {\n  var representation = 'new Date(\"' + x[key].toUTCString() + '\")';\n  x[key] = {inspect: function() { return representation; }};\n}\nfunction format(obj, sub) {\n  if (obj && typeof obj.toBSON === 'function') {\n    obj = obj.toBSON();\n  }\n  var x = utils.clone(obj, {retainKeyOrder: 1, transform: false});\n  var representation;\n\n  if (x != null) {\n    if (x.constructor.name === 'Binary') {\n      x = 'BinData(' + x.sub_type + ', \"' + x.toString('base64') + '\")';\n    } else if (x.constructor.name === 'ObjectID') {\n      representation = 'ObjectId(\"' + x.toHexString() + '\")';\n      x = {inspect: function() { return representation; }};\n    } else if (x.constructor.name === 'Date') {\n      representation = 'new Date(\"' + x.toUTCString() + '\")';\n      x = {inspect: function() { return representation; }};\n    } else if (x.constructor.name === 'Object') {\n      var keys = Object.keys(x);\n      var numKeys = keys.length;\n      var key;\n      for (var i = 0; i < numKeys; ++i) {\n        key = keys[i];\n        if (x[key]) {\n          if (typeof x[key].toBSON === 'function') {\n            x[key] = x[key].toBSON();\n          }\n          if (x[key].constructor.name === 'Binary') {\n            x[key] = 'BinData(' + x[key].sub_type + ', \"' +\n              x[key].buffer.toString('base64') + '\")';\n          } else if (x[key].constructor.name === 'Object') {\n            x[key] = format(x[key], true);\n          } else if (x[key].constructor.name === 'ObjectID') {\n            formatObjectId(x, key);\n          } else if (x[key].constructor.name === 'Date') {\n            formatDate(x, key);\n          } else if (Array.isArray(x[key])) {\n            x[key] = x[key].map(map);\n          }\n        }\n      }\n    }\n    if (sub) return x;\n  }\n\n  return require('util')\n  .inspect(x, false, 10, true)\n  .replace(/\\n/g, '')\n  .replace(/\\s{2,}/g, ' ');\n}\n\n/**\n * Retreives information about this collections indexes.\n *\n * @param {Function} callback\n * @method getIndexes\n * @api public\n */\n\nNativeCollection.prototype.getIndexes = NativeCollection.prototype.indexInformation;\n\n/*!\n * Module exports.\n */\n\nmodule.exports = NativeCollection;\n"]}