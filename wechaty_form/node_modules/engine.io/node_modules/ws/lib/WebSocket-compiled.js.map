{"version":3,"sources":["WebSocket.js"],"names":[],"mappings":"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","file":"WebSocket-compiled.js","sourcesContent":["'use strict';\n\n/*!\n * ws: a node.js websocket client\n * Copyright(c) 2011 Einar Otto Stangvik <einaros@gmail.com>\n * MIT Licensed\n */\n\nvar url = require('url')\n  , util = require('util')\n  , http = require('http')\n  , https = require('https')\n  , crypto = require('crypto')\n  , stream = require('stream')\n  , Ultron = require('ultron')\n  , Options = require('options')\n  , Sender = require('./Sender')\n  , Receiver = require('./Receiver')\n  , SenderHixie = require('./Sender.hixie')\n  , ReceiverHixie = require('./Receiver.hixie')\n  , Extensions = require('./Extensions')\n  , PerMessageDeflate = require('./PerMessageDeflate')\n  , EventEmitter = require('events').EventEmitter;\n\n/**\n * Constants\n */\n\n// Default protocol version\n\nvar protocolVersion = 13;\n\n// Close timeout\n\nvar closeTimeout = 30 * 1000; // Allow 30 seconds to terminate the connection cleanly\n\n/**\n * WebSocket implementation\n *\n * @constructor\n * @param {String} address Connection address.\n * @param {String|Array} protocols WebSocket protocols.\n * @param {Object} options Additional connection options.\n * @api public\n */\nfunction WebSocket(address, protocols, options) {\n  if (this instanceof WebSocket === false) {\n    return new WebSocket(address, protocols, options);\n  }\n\n  EventEmitter.call(this);\n\n  if (protocols && !Array.isArray(protocols) && 'object' === typeof protocols) {\n    // accept the \"options\" Object as the 2nd argument\n    options = protocols;\n    protocols = null;\n  }\n\n  if ('string' === typeof protocols) {\n    protocols = [ protocols ];\n  }\n\n  if (!Array.isArray(protocols)) {\n    protocols = [];\n  }\n\n  this._socket = null;\n  this._ultron = null;\n  this._closeReceived = false;\n  this.bytesReceived = 0;\n  this.readyState = null;\n  this.supports = {};\n  this.extensions = {};\n  this._binaryType = 'nodebuffer';\n\n  if (Array.isArray(address)) {\n    initAsServerClient.apply(this, address.concat(options));\n  } else {\n    initAsClient.apply(this, [address, protocols, options]);\n  }\n}\n\n/**\n * Inherits from EventEmitter.\n */\nutil.inherits(WebSocket, EventEmitter);\n\n/**\n * Ready States\n */\n[\"CONNECTING\", \"OPEN\", \"CLOSING\", \"CLOSED\"].forEach(function each(state, index) {\n    WebSocket.prototype[state] = WebSocket[state] = index;\n});\n\n/**\n * Gracefully closes the connection, after sending a description message to the server\n *\n * @param {Object} data to be sent to the server\n * @api public\n */\nWebSocket.prototype.close = function close(code, data) {\n  if (this.readyState === WebSocket.CLOSED) return;\n\n  if (this.readyState === WebSocket.CONNECTING) {\n    this.readyState = WebSocket.CLOSED;\n    return;\n  }\n\n  if (this.readyState === WebSocket.CLOSING) {\n    if (this._closeReceived && this._isServer) {\n      this.terminate();\n    }\n    return;\n  }\n\n  var self = this;\n  try {\n    this.readyState = WebSocket.CLOSING;\n    this._closeCode = code;\n    this._closeMessage = data;\n    var mask = !this._isServer;\n    this._sender.close(code, data, mask, function(err) {\n      if (err) self.emit('error', err);\n\n      if (self._closeReceived && self._isServer) {\n        self.terminate();\n      } else {\n        // ensure that the connection is cleaned up even when no response of closing handshake.\n        clearTimeout(self._closeTimer);\n        self._closeTimer = setTimeout(cleanupWebsocketResources.bind(self, true), closeTimeout);\n      }\n    });\n  } catch (e) {\n    this.emit('error', e);\n  }\n};\n\n/**\n * Pause the client stream\n *\n * @api public\n */\nWebSocket.prototype.pause = function pauser() {\n  if (this.readyState !== WebSocket.OPEN) throw new Error('not opened');\n\n  return this._socket.pause();\n};\n\n/**\n * Sends a ping\n *\n * @param {Object} data to be sent to the server\n * @param {Object} Members - mask: boolean, binary: boolean\n * @param {boolean} dontFailWhenClosed indicates whether or not to throw if the connection isnt open\n * @api public\n */\nWebSocket.prototype.ping = function ping(data, options, dontFailWhenClosed) {\n  if (this.readyState !== WebSocket.OPEN) {\n    if (dontFailWhenClosed === true) return;\n    throw new Error('not opened');\n  }\n\n  options = options || {};\n\n  if (typeof options.mask === 'undefined') options.mask = !this._isServer;\n\n  this._sender.ping(data, options);\n};\n\n/**\n * Sends a pong\n *\n * @param {Object} data to be sent to the server\n * @param {Object} Members - mask: boolean, binary: boolean\n * @param {boolean} dontFailWhenClosed indicates whether or not to throw if the connection isnt open\n * @api public\n */\nWebSocket.prototype.pong = function(data, options, dontFailWhenClosed) {\n  if (this.readyState !== WebSocket.OPEN) {\n    if (dontFailWhenClosed === true) return;\n    throw new Error('not opened');\n  }\n\n  options = options || {};\n\n  if (typeof options.mask === 'undefined') options.mask = !this._isServer;\n\n  this._sender.pong(data, options);\n};\n\n/**\n * Resume the client stream\n *\n * @api public\n */\nWebSocket.prototype.resume = function resume() {\n  if (this.readyState !== WebSocket.OPEN) throw new Error('not opened');\n\n  return this._socket.resume();\n};\n\n/**\n * Sends a piece of data\n *\n * @param {Object} data to be sent to the server\n * @param {Object} Members - mask: boolean, binary: boolean, compress: boolean\n * @param {function} Optional callback which is executed after the send completes\n * @api public\n */\n\nWebSocket.prototype.send = function send(data, options, cb) {\n  if (typeof options === 'function') {\n    cb = options;\n    options = {};\n  }\n\n  if (this.readyState !== WebSocket.OPEN) {\n    if (typeof cb === 'function') cb(new Error('not opened'));\n    else throw new Error('not opened');\n    return;\n  }\n\n  if (!data) data = '';\n  if (this._queue) {\n    var self = this;\n    this._queue.push(function() { self.send(data, options, cb); });\n    return;\n  }\n\n  options = options || {};\n  options.fin = true;\n\n  if (typeof options.binary === 'undefined') {\n    options.binary = (data instanceof ArrayBuffer || data instanceof Buffer ||\n      data instanceof Uint8Array ||\n      data instanceof Uint16Array ||\n      data instanceof Uint32Array ||\n      data instanceof Int8Array ||\n      data instanceof Int16Array ||\n      data instanceof Int32Array ||\n      data instanceof Float32Array ||\n      data instanceof Float64Array);\n  }\n\n  if (typeof options.mask === 'undefined') options.mask = !this._isServer;\n  if (typeof options.compress === 'undefined') options.compress = true;\n  if (!this.extensions[PerMessageDeflate.extensionName]) {\n    options.compress = false;\n  }\n\n  var readable = typeof stream.Readable === 'function'\n    ? stream.Readable\n    : stream.Stream;\n\n  if (data instanceof readable) {\n    startQueue(this);\n    var self = this;\n\n    sendStream(this, data, options, function send(error) {\n      process.nextTick(function tock() {\n        executeQueueSends(self);\n      });\n\n      if (typeof cb === 'function') cb(error);\n    });\n  } else {\n    this._sender.send(data, options, cb);\n  }\n};\n\n/**\n * Streams data through calls to a user supplied function\n *\n * @param {Object} Members - mask: boolean, binary: boolean, compress: boolean\n * @param {function} 'function (error, send)' which is executed on successive ticks of which send is 'function (data, final)'.\n * @api public\n */\nWebSocket.prototype.stream = function stream(options, cb) {\n  if (typeof options === 'function') {\n    cb = options;\n    options = {};\n  }\n\n  var self = this;\n\n  if (typeof cb !== 'function') throw new Error('callback must be provided');\n\n  if (this.readyState !== WebSocket.OPEN) {\n    if (typeof cb === 'function') cb(new Error('not opened'));\n    else throw new Error('not opened');\n    return;\n  }\n\n  if (this._queue) {\n    this._queue.push(function () { self.stream(options, cb); });\n    return;\n  }\n\n  options = options || {};\n\n  if (typeof options.mask === 'undefined') options.mask = !this._isServer;\n  if (typeof options.compress === 'undefined') options.compress = true;\n  if (!this.extensions[PerMessageDeflate.extensionName]) {\n    options.compress = false;\n  }\n\n  startQueue(this);\n\n  function send(data, final) {\n    try {\n      if (self.readyState !== WebSocket.OPEN) throw new Error('not opened');\n      options.fin = final === true;\n      self._sender.send(data, options);\n      if (!final) process.nextTick(cb.bind(null, null, send));\n      else executeQueueSends(self);\n    } catch (e) {\n      if (typeof cb === 'function') cb(e);\n      else {\n        delete self._queue;\n        self.emit('error', e);\n      }\n    }\n  }\n\n  process.nextTick(cb.bind(null, null, send));\n};\n\n/**\n * Immediately shuts down the connection\n *\n * @api public\n */\nWebSocket.prototype.terminate = function terminate() {\n  if (this.readyState === WebSocket.CLOSED) return;\n\n  if (this._socket) {\n    this.readyState = WebSocket.CLOSING;\n\n    // End the connection\n    try { this._socket.end(); }\n    catch (e) {\n      // Socket error during end() call, so just destroy it right now\n      cleanupWebsocketResources.call(this, true);\n      return;\n    }\n\n    // Add a timeout to ensure that the connection is completely\n    // cleaned up within 30 seconds, even if the clean close procedure\n    // fails for whatever reason\n    // First cleanup any pre-existing timeout from an earlier \"terminate\" call,\n    // if one exists.  Otherwise terminate calls in quick succession will leak timeouts\n    // and hold the program open for `closeTimout` time.\n    if (this._closeTimer) { clearTimeout(this._closeTimer); }\n    this._closeTimer = setTimeout(cleanupWebsocketResources.bind(this, true), closeTimeout);\n  } else if (this.readyState === WebSocket.CONNECTING) {\n    cleanupWebsocketResources.call(this, true);\n  }\n};\n\n/**\n * Expose bufferedAmount\n *\n * @api public\n */\nObject.defineProperty(WebSocket.prototype, 'bufferedAmount', {\n  get: function get() {\n    var amount = 0;\n    if (this._socket) {\n      amount = this._socket.bufferSize || 0;\n    }\n    return amount;\n  }\n});\n\n/**\n * Expose binaryType\n *\n * This deviates from the W3C interface since ws doesn't support the required\n * default \"blob\" type (instead we define a custom \"nodebuffer\" type).\n *\n * @see http://dev.w3.org/html5/websockets/#the-websocket-interface\n * @api public\n */\nObject.defineProperty(WebSocket.prototype, 'binaryType', {\n  get: function get() {\n    return this._binaryType;\n  },\n  set: function set(type) {\n    if (type === 'arraybuffer' || type === 'nodebuffer')\n      this._binaryType = type;\n    else\n      throw new SyntaxError('unsupported binaryType: must be either \"nodebuffer\" or \"arraybuffer\"');\n  }\n});\n\n/**\n * Emulates the W3C Browser based WebSocket interface using function members.\n *\n * @see http://dev.w3.org/html5/websockets/#the-websocket-interface\n * @api public\n */\n['open', 'error', 'close', 'message'].forEach(function(method) {\n  Object.defineProperty(WebSocket.prototype, 'on' + method, {\n    /**\n     * Returns the current listener\n     *\n     * @returns {Mixed} the set function or undefined\n     * @api public\n     */\n    get: function get() {\n      var listener = this.listeners(method)[0];\n      return listener ? (listener._listener ? listener._listener : listener) : undefined;\n    },\n\n    /**\n     * Start listening for events\n     *\n     * @param {Function} listener the listener\n     * @returns {Mixed} the set function or undefined\n     * @api public\n     */\n    set: function set(listener) {\n      this.removeAllListeners(method);\n      this.addEventListener(method, listener);\n    }\n  });\n});\n\n/**\n * Emulates the W3C Browser based WebSocket interface using addEventListener.\n *\n * @see https://developer.mozilla.org/en/DOM/element.addEventListener\n * @see http://dev.w3.org/html5/websockets/#the-websocket-interface\n * @api public\n */\nWebSocket.prototype.addEventListener = function(method, listener) {\n  var target = this;\n\n  function onMessage (data, flags) {\n    if (flags.binary && this.binaryType === 'arraybuffer')\n        data = new Uint8Array(data).buffer;\n    listener.call(target, new MessageEvent(data, !!flags.binary, target));\n  }\n\n  function onClose (code, message) {\n    listener.call(target, new CloseEvent(code, message, target));\n  }\n\n  function onError (event) {\n    event.type = 'error';\n    event.target = target;\n    listener.call(target, event);\n  }\n\n  function onOpen () {\n    listener.call(target, new OpenEvent(target));\n  }\n\n  if (typeof listener === 'function') {\n    if (method === 'message') {\n      // store a reference so we can return the original function from the\n      // addEventListener hook\n      onMessage._listener = listener;\n      this.on(method, onMessage);\n    } else if (method === 'close') {\n      // store a reference so we can return the original function from the\n      // addEventListener hook\n      onClose._listener = listener;\n      this.on(method, onClose);\n    } else if (method === 'error') {\n      // store a reference so we can return the original function from the\n      // addEventListener hook\n      onError._listener = listener;\n      this.on(method, onError);\n    } else if (method === 'open') {\n      // store a reference so we can return the original function from the\n      // addEventListener hook\n      onOpen._listener = listener;\n      this.on(method, onOpen);\n    } else {\n      this.on(method, listener);\n    }\n  }\n};\n\nmodule.exports = WebSocket;\nmodule.exports.buildHostHeader = buildHostHeader\n\n/**\n * W3C MessageEvent\n *\n * @see http://www.w3.org/TR/html5/comms.html\n * @constructor\n * @api private\n */\nfunction MessageEvent(dataArg, isBinary, target) {\n  this.type = 'message';\n  this.data = dataArg;\n  this.target = target;\n  this.binary = isBinary; // non-standard.\n}\n\n/**\n * W3C CloseEvent\n *\n * @see http://www.w3.org/TR/html5/comms.html\n * @constructor\n * @api private\n */\nfunction CloseEvent(code, reason, target) {\n  this.type = 'close';\n  this.wasClean = (typeof code === 'undefined' || code === 1000);\n  this.code = code;\n  this.reason = reason;\n  this.target = target;\n}\n\n/**\n * W3C OpenEvent\n *\n * @see http://www.w3.org/TR/html5/comms.html\n * @constructor\n * @api private\n */\nfunction OpenEvent(target) {\n  this.type = 'open';\n  this.target = target;\n}\n\n// Append port number to Host header, only if specified in the url\n// and non-default\nfunction buildHostHeader(isSecure, hostname, port) {\n  var headerHost = hostname;\n  if (hostname) {\n    if ((isSecure && (port != 443)) || (!isSecure && (port != 80))){\n      headerHost = headerHost + ':' + port;\n    }\n  }\n  return headerHost;\n}\n\n/**\n * Entirely private apis,\n * which may or may not be bound to a sepcific WebSocket instance.\n */\nfunction initAsServerClient(req, socket, upgradeHead, options) {\n  options = new Options({\n    protocolVersion: protocolVersion,\n    protocol: null,\n    extensions: {},\n    maxPayload: 0\n  }).merge(options);\n\n  // expose state properties\n  this.protocol = options.value.protocol;\n  this.protocolVersion = options.value.protocolVersion;\n  this.extensions = options.value.extensions;\n  this.supports.binary = (this.protocolVersion !== 'hixie-76');\n  this.upgradeReq = req;\n  this.readyState = WebSocket.CONNECTING;\n  this._isServer = true;\n  this.maxPayload = options.value.maxPayload;\n  // establish connection\n  if (options.value.protocolVersion === 'hixie-76') {\n    establishConnection.call(this, ReceiverHixie, SenderHixie, socket, upgradeHead);\n  } else {\n    establishConnection.call(this, Receiver, Sender, socket, upgradeHead);\n  }\n}\n\nfunction initAsClient(address, protocols, options) {\n  options = new Options({\n    origin: null,\n    protocolVersion: protocolVersion,\n    host: null,\n    headers: null,\n    protocol: protocols.join(','),\n    agent: null,\n\n    // ssl-related options\n    pfx: null,\n    key: null,\n    passphrase: null,\n    cert: null,\n    ca: null,\n    ciphers: null,\n    rejectUnauthorized: null,\n    perMessageDeflate: true,\n    localAddress: null\n  }).merge(options);\n\n  if (options.value.protocolVersion !== 8 && options.value.protocolVersion !== 13) {\n    throw new Error('unsupported protocol version');\n  }\n\n  // verify URL and establish http class\n  var serverUrl = url.parse(address);\n  var isUnixSocket = serverUrl.protocol === 'ws+unix:';\n  if (!serverUrl.host && !isUnixSocket) throw new Error('invalid url');\n  var isSecure = serverUrl.protocol === 'wss:' || serverUrl.protocol === 'https:';\n  var httpObj = isSecure ? https : http;\n  var port = serverUrl.port || (isSecure ? 443 : 80);\n  var auth = serverUrl.auth;\n\n  // prepare extensions\n  var extensionsOffer = {};\n  var perMessageDeflate;\n  if (options.value.perMessageDeflate) {\n    perMessageDeflate = new PerMessageDeflate(typeof options.value.perMessageDeflate !== true ? options.value.perMessageDeflate : {}, false);\n    extensionsOffer[PerMessageDeflate.extensionName] = perMessageDeflate.offer();\n  }\n\n  // expose state properties\n  this._isServer = false;\n  this.url = address;\n  this.protocolVersion = options.value.protocolVersion;\n  this.supports.binary = (this.protocolVersion !== 'hixie-76');\n\n  // begin handshake\n  var key = new Buffer(options.value.protocolVersion + '-' + Date.now()).toString('base64');\n  var shasum = crypto.createHash('sha1');\n  shasum.update(key + '258EAFA5-E914-47DA-95CA-C5AB0DC85B11');\n  var expectedServerKey = shasum.digest('base64');\n\n  var agent = options.value.agent;\n\n  var headerHost = buildHostHeader(isSecure, serverUrl.hostname, port)\n\n  var requestOptions = {\n    port: port,\n    host: serverUrl.hostname,\n    headers: {\n      'Connection': 'Upgrade',\n      'Upgrade': 'websocket',\n      'Host': headerHost,\n      'Sec-WebSocket-Version': options.value.protocolVersion,\n      'Sec-WebSocket-Key': key\n    }\n  };\n\n  // If we have basic auth.\n  if (auth) {\n    requestOptions.headers.Authorization = 'Basic ' + new Buffer(auth).toString('base64');\n  }\n\n  if (options.value.protocol) {\n    requestOptions.headers['Sec-WebSocket-Protocol'] = options.value.protocol;\n  }\n\n  if (options.value.host) {\n    requestOptions.headers.Host = options.value.host;\n  }\n\n  if (options.value.headers) {\n    for (var header in options.value.headers) {\n       if (options.value.headers.hasOwnProperty(header)) {\n        requestOptions.headers[header] = options.value.headers[header];\n       }\n    }\n  }\n\n  if (Object.keys(extensionsOffer).length) {\n    requestOptions.headers['Sec-WebSocket-Extensions'] = Extensions.format(extensionsOffer);\n  }\n\n  if (options.isDefinedAndNonNull('pfx')\n   || options.isDefinedAndNonNull('key')\n   || options.isDefinedAndNonNull('passphrase')\n   || options.isDefinedAndNonNull('cert')\n   || options.isDefinedAndNonNull('ca')\n   || options.isDefinedAndNonNull('ciphers')\n   || options.isDefinedAndNonNull('rejectUnauthorized')) {\n\n    if (options.isDefinedAndNonNull('pfx')) requestOptions.pfx = options.value.pfx;\n    if (options.isDefinedAndNonNull('key')) requestOptions.key = options.value.key;\n    if (options.isDefinedAndNonNull('passphrase')) requestOptions.passphrase = options.value.passphrase;\n    if (options.isDefinedAndNonNull('cert')) requestOptions.cert = options.value.cert;\n    if (options.isDefinedAndNonNull('ca')) requestOptions.ca = options.value.ca;\n    if (options.isDefinedAndNonNull('ciphers')) requestOptions.ciphers = options.value.ciphers;\n    if (options.isDefinedAndNonNull('rejectUnauthorized')) requestOptions.rejectUnauthorized = options.value.rejectUnauthorized;\n\n    if (!agent) {\n        // global agent ignores client side certificates\n        agent = new httpObj.Agent(requestOptions);\n    }\n  }\n\n  requestOptions.path = serverUrl.path || '/';\n\n  if (agent) {\n    requestOptions.agent = agent;\n  }\n\n  if (isUnixSocket) {\n    requestOptions.socketPath = serverUrl.pathname;\n  }\n\n  if (options.value.localAddress) {\n    requestOptions.localAddress = options.value.localAddress;\n  }\n\n  if (options.value.origin) {\n    if (options.value.protocolVersion < 13) requestOptions.headers['Sec-WebSocket-Origin'] = options.value.origin;\n    else requestOptions.headers.Origin = options.value.origin;\n  }\n\n  var self = this;\n  var req = httpObj.request(requestOptions);\n\n  req.on('error', function onerror(error) {\n    self.emit('error', error);\n    cleanupWebsocketResources.call(self, error);\n  });\n\n  req.once('response', function response(res) {\n    var error;\n\n    if (!self.emit('unexpected-response', req, res)) {\n      error = new Error('unexpected server response (' + res.statusCode + ')');\n      req.abort();\n      self.emit('error', error);\n    }\n\n    cleanupWebsocketResources.call(self, error);\n  });\n\n  req.once('upgrade', function upgrade(res, socket, upgradeHead) {\n    if (self.readyState === WebSocket.CLOSED) {\n      // client closed before server accepted connection\n      self.emit('close');\n      self.removeAllListeners();\n      socket.end();\n      return;\n    }\n\n    var serverKey = res.headers['sec-websocket-accept'];\n    if (typeof serverKey === 'undefined' || serverKey !== expectedServerKey) {\n      self.emit('error', 'invalid server key');\n      self.removeAllListeners();\n      socket.end();\n      return;\n    }\n\n    var serverProt = res.headers['sec-websocket-protocol'];\n    var protList = (options.value.protocol || \"\").split(/, */);\n    var protError = null;\n\n    if (!options.value.protocol && serverProt) {\n      protError = 'server sent a subprotocol even though none requested';\n    } else if (options.value.protocol && !serverProt) {\n      protError = 'server sent no subprotocol even though requested';\n    } else if (serverProt && protList.indexOf(serverProt) === -1) {\n      protError = 'server responded with an invalid protocol';\n    }\n\n    if (protError) {\n      self.emit('error', protError);\n      self.removeAllListeners();\n      socket.end();\n      return;\n    } else if (serverProt) {\n      self.protocol = serverProt;\n    }\n\n    var serverExtensions = Extensions.parse(res.headers['sec-websocket-extensions']);\n    if (perMessageDeflate && serverExtensions[PerMessageDeflate.extensionName]) {\n      try {\n        perMessageDeflate.accept(serverExtensions[PerMessageDeflate.extensionName]);\n      } catch (err) {\n        self.emit('error', 'invalid extension parameter');\n        self.removeAllListeners();\n        socket.end();\n        return;\n      }\n      self.extensions[PerMessageDeflate.extensionName] = perMessageDeflate;\n    }\n\n    establishConnection.call(self, Receiver, Sender, socket, upgradeHead);\n\n    // perform cleanup on http resources\n    req.removeAllListeners();\n    req = null;\n    agent = null;\n  });\n\n  req.end();\n  this.readyState = WebSocket.CONNECTING;\n}\n\nfunction establishConnection(ReceiverClass, SenderClass, socket, upgradeHead) {\n  var ultron = this._ultron = new Ultron(socket)\n    , called = false\n    , self = this;\n\n  socket.setTimeout(0);\n  socket.setNoDelay(true);\n\n  this._receiver = new ReceiverClass(this.extensions,this.maxPayload);\n  this._socket = socket;\n\n  // socket cleanup handlers\n  ultron.on('end', cleanupWebsocketResources.bind(this));\n  ultron.on('close', cleanupWebsocketResources.bind(this));\n  ultron.on('error', cleanupWebsocketResources.bind(this));\n\n  // ensure that the upgradeHead is added to the receiver\n  function firstHandler(data) {\n    if (called || self.readyState === WebSocket.CLOSED) return;\n\n    called = true;\n    socket.removeListener('data', firstHandler);\n    ultron.on('data', realHandler);\n\n    if (upgradeHead && upgradeHead.length > 0) {\n      realHandler(upgradeHead);\n      upgradeHead = null;\n    }\n\n    if (data) realHandler(data);\n  }\n\n  // subsequent packets are pushed straight to the receiver\n  function realHandler(data) {\n    self.bytesReceived += data.length;\n    self._receiver.add(data);\n  }\n\n  ultron.on('data', firstHandler);\n\n  // if data was passed along with the http upgrade,\n  // this will schedule a push of that on to the receiver.\n  // this has to be done on next tick, since the caller\n  // hasn't had a chance to set event handlers on this client\n  // object yet.\n  process.nextTick(firstHandler);\n\n  // receiver event handlers\n  self._receiver.ontext = function ontext(data, flags) {\n    flags = flags || {};\n\n    self.emit('message', data, flags);\n  };\n\n  self._receiver.onbinary = function onbinary(data, flags) {\n    flags = flags || {};\n\n    flags.binary = true;\n    self.emit('message', data, flags);\n  };\n\n  self._receiver.onping = function onping(data, flags) {\n    flags = flags || {};\n\n    self.pong(data, {\n      mask: !self._isServer,\n      binary: flags.binary === true\n    }, true);\n\n    self.emit('ping', data, flags);\n  };\n\n  self._receiver.onpong = function onpong(data, flags) {\n    self.emit('pong', data, flags || {});\n  };\n\n  self._receiver.onclose = function onclose(code, data, flags) {\n    flags = flags || {};\n\n    self._closeReceived = true;\n    self.close(code, data);\n  };\n\n  self._receiver.onerror = function onerror(reason, errorCode) {\n    // close the connection when the receiver reports a HyBi error code\n    self.close(typeof errorCode !== 'undefined' ? errorCode : 1002, '');\n    self.emit('error', (reason instanceof Error) ? reason : (new Error(reason)));\n  };\n\n  // finalize the client\n  this._sender = new SenderClass(socket, this.extensions);\n  this._sender.on('error', function onerror(error) {\n    self.close(1002, '');\n    self.emit('error', error);\n  });\n\n  this.readyState = WebSocket.OPEN;\n  this.emit('open');\n}\n\nfunction startQueue(instance) {\n  instance._queue = instance._queue || [];\n}\n\nfunction executeQueueSends(instance) {\n  var queue = instance._queue;\n  if (typeof queue === 'undefined') return;\n\n  delete instance._queue;\n  for (var i = 0, l = queue.length; i < l; ++i) {\n    queue[i]();\n  }\n}\n\nfunction sendStream(instance, stream, options, cb) {\n  stream.on('data', function incoming(data) {\n    if (instance.readyState !== WebSocket.OPEN) {\n      if (typeof cb === 'function') cb(new Error('not opened'));\n      else {\n        delete instance._queue;\n        instance.emit('error', new Error('not opened'));\n      }\n      return;\n    }\n\n    options.fin = false;\n    instance._sender.send(data, options);\n  });\n\n  stream.on('end', function end() {\n    if (instance.readyState !== WebSocket.OPEN) {\n      if (typeof cb === 'function') cb(new Error('not opened'));\n      else {\n        delete instance._queue;\n        instance.emit('error', new Error('not opened'));\n      }\n      return;\n    }\n\n    options.fin = true;\n    instance._sender.send(null, options);\n\n    if (typeof cb === 'function') cb(null);\n  });\n}\n\nfunction cleanupWebsocketResources(error) {\n  if (this.readyState === WebSocket.CLOSED) return;\n\n  this.readyState = WebSocket.CLOSED;\n\n  clearTimeout(this._closeTimer);\n  this._closeTimer = null;\n\n  // If the connection was closed abnormally (with an error), or if\n  // the close control frame was not received then the close code\n  // must default to 1006.\n  if (error || !this._closeReceived) {\n    this._closeCode = 1006;\n  }\n  this.emit('close', this._closeCode || 1000, this._closeMessage || '');\n\n  if (this._socket) {\n    if (this._ultron) this._ultron.destroy();\n    this._socket.on('error', function onerror() {\n      try { this.destroy(); }\n      catch (e) {}\n    });\n\n    try {\n      if (!error) this._socket.end();\n      else this._socket.destroy();\n    } catch (e) { /* Ignore termination errors */ }\n\n    this._socket = null;\n    this._ultron = null;\n  }\n\n  if (this._sender) {\n    this._sender.removeAllListeners();\n    this._sender = null;\n  }\n\n  if (this._receiver) {\n    this._receiver.cleanup();\n    this._receiver = null;\n  }\n\n  if (this.extensions[PerMessageDeflate.extensionName]) {\n    this.extensions[PerMessageDeflate.extensionName].cleanup();\n  }\n\n  this.extensions = null;\n\n  this.removeAllListeners();\n  this.on('error', function onerror() {}); // catch all errors after this\n  delete this._queue;\n}\n"]}