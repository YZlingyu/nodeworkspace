{"version":3,"sources":["Sender.js"],"names":[],"mappings":"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","file":"Sender-compiled.js","sourcesContent":["/*!\n * ws: a node.js websocket client\n * Copyright(c) 2011 Einar Otto Stangvik <einaros@gmail.com>\n * MIT Licensed\n */\n\nvar events = require('events')\n  , util = require('util')\n  , crypto = require('crypto')\n  , EventEmitter = events.EventEmitter\n  , ErrorCodes = require('./ErrorCodes')\n  , bufferUtil = require('./BufferUtil')\n  , PerMessageDeflate = require('./PerMessageDeflate');\n\n/**\n * HyBi Sender implementation\n */\n\nfunction Sender(socket, extensions) {\n  if (this instanceof Sender === false) {\n    throw new TypeError(\"Classes can't be function-called\");\n  }\n\n  events.EventEmitter.call(this);\n\n  this._socket = socket;\n  this.extensions = extensions || {};\n  this.firstFragment = true;\n  this.compress = false;\n  this.messageHandlers = [];\n  this.processing = false;\n}\n\n/**\n * Inherits from EventEmitter.\n */\n\nutil.inherits(Sender, events.EventEmitter);\n\n/**\n * Sends a close instruction to the remote party.\n *\n * @api public\n */\n\nSender.prototype.close = function(code, data, mask, cb) {\n  if (typeof code !== 'undefined') {\n    if (typeof code !== 'number' ||\n      !ErrorCodes.isValidErrorCode(code)) throw new Error('first argument must be a valid error code number');\n  }\n  code = code || 1000;\n  var dataBuffer = new Buffer(2 + (data ? Buffer.byteLength(data) : 0));\n  writeUInt16BE.call(dataBuffer, code, 0);\n  if (dataBuffer.length > 2) dataBuffer.write(data, 2);\n\n  var self = this;\n  this.messageHandlers.push(function() {\n    self.frameAndSend(0x8, dataBuffer, true, mask);\n    if (typeof cb == 'function') cb();\n  });\n  this.flush();\n};\n\n/**\n * Sends a ping message to the remote party.\n *\n * @api public\n */\n\nSender.prototype.ping = function(data, options) {\n  var mask = options && options.mask;\n  var self = this;\n  this.messageHandlers.push(function() {\n    self.frameAndSend(0x9, data || '', true, mask);\n  });\n  this.flush();\n};\n\n/**\n * Sends a pong message to the remote party.\n *\n * @api public\n */\n\nSender.prototype.pong = function(data, options) {\n  var mask = options && options.mask;\n  var self = this;\n  this.messageHandlers.push(function() {\n    self.frameAndSend(0xa, data || '', true, mask);\n  });\n  this.flush();\n};\n\n/**\n * Sends text or binary data to the remote party.\n *\n * @api public\n */\n\nSender.prototype.send = function(data, options, cb) {\n  var finalFragment = options && options.fin === false ? false : true;\n  var mask = options && options.mask;\n  var compress = options && options.compress;\n  var opcode = options && options.binary ? 2 : 1;\n  if (this.firstFragment === false) {\n    opcode = 0;\n    compress = false;\n  } else {\n    this.firstFragment = false;\n    this.compress = compress;\n  }\n  if (finalFragment) this.firstFragment = true\n\n  var compressFragment = this.compress;\n\n  var self = this;\n  this.messageHandlers.push(function() {\n    if (!data || !compressFragment) {\n      self.frameAndSend(opcode, data, finalFragment, mask, compress, cb);\n      return;\n    }\n\n    self.processing = true;\n    self.applyExtensions(data, finalFragment, compressFragment, function(err, data) {\n      if (err) {\n        if (typeof cb == 'function') cb(err);\n        else self.emit('error', err);\n        return;\n      }\n      self.frameAndSend(opcode, data, finalFragment, mask, compress, cb);\n      self.processing = false;\n      self.flush();\n    });\n  });\n  this.flush();\n};\n\n/**\n * Frames and sends a piece of data according to the HyBi WebSocket protocol.\n *\n * @api private\n */\n\nSender.prototype.frameAndSend = function(opcode, data, finalFragment, maskData, compressed, cb) {\n  var canModifyData = false;\n\n  if (!data) {\n    try {\n      this._socket.write(new Buffer([opcode | (finalFragment ? 0x80 : 0), 0 | (maskData ? 0x80 : 0)].concat(maskData ? [0, 0, 0, 0] : [])), 'binary', cb);\n    }\n    catch (e) {\n      if (typeof cb == 'function') cb(e);\n      else this.emit('error', e);\n    }\n    return;\n  }\n\n  if (!Buffer.isBuffer(data)) {\n    canModifyData = true;\n    if (data && (typeof data.byteLength !== 'undefined' || typeof data.buffer !== 'undefined')) {\n      data = getArrayBuffer(data);\n    } else {\n      //\n      // If people want to send a number, this would allocate the number in\n      // bytes as memory size instead of storing the number as buffer value. So\n      // we need to transform it to string in order to prevent possible\n      // vulnerabilities / memory attacks.\n      //\n      if (typeof data === 'number') data = data.toString();\n\n      data = new Buffer(data);\n    }\n  }\n\n  var dataLength = data.length\n    , dataOffset = maskData ? 6 : 2\n    , secondByte = dataLength;\n\n  if (dataLength >= 65536) {\n    dataOffset += 8;\n    secondByte = 127;\n  }\n  else if (dataLength > 125) {\n    dataOffset += 2;\n    secondByte = 126;\n  }\n\n  var mergeBuffers = dataLength < 32768 || (maskData && !canModifyData);\n  var totalLength = mergeBuffers ? dataLength + dataOffset : dataOffset;\n  var outputBuffer = new Buffer(totalLength);\n  outputBuffer[0] = finalFragment ? opcode | 0x80 : opcode;\n  if (compressed) outputBuffer[0] |= 0x40;\n\n  switch (secondByte) {\n    case 126:\n      writeUInt16BE.call(outputBuffer, dataLength, 2);\n      break;\n    case 127:\n      writeUInt32BE.call(outputBuffer, 0, 2);\n      writeUInt32BE.call(outputBuffer, dataLength, 6);\n  }\n\n  if (maskData) {\n    outputBuffer[1] = secondByte | 0x80;\n    var mask = getRandomMask();\n    outputBuffer[dataOffset - 4] = mask[0];\n    outputBuffer[dataOffset - 3] = mask[1];\n    outputBuffer[dataOffset - 2] = mask[2];\n    outputBuffer[dataOffset - 1] = mask[3];\n    if (mergeBuffers) {\n      bufferUtil.mask(data, mask, outputBuffer, dataOffset, dataLength);\n      try {\n        this._socket.write(outputBuffer, 'binary', cb);\n      }\n      catch (e) {\n        if (typeof cb == 'function') cb(e);\n        else this.emit('error', e);\n      }\n    }\n    else {\n      bufferUtil.mask(data, mask, data, 0, dataLength);\n      try {\n        this._socket.write(outputBuffer, 'binary');\n        this._socket.write(data, 'binary', cb);\n      }\n      catch (e) {\n        if (typeof cb == 'function') cb(e);\n        else this.emit('error', e);\n      }\n    }\n  }\n  else {\n    outputBuffer[1] = secondByte;\n    if (mergeBuffers) {\n      data.copy(outputBuffer, dataOffset);\n      try {\n        this._socket.write(outputBuffer, 'binary', cb);\n      }\n      catch (e) {\n        if (typeof cb == 'function') cb(e);\n        else this.emit('error', e);\n      }\n    }\n    else {\n      try {\n        this._socket.write(outputBuffer, 'binary');\n        this._socket.write(data, 'binary', cb);\n      }\n      catch (e) {\n        if (typeof cb == 'function') cb(e);\n        else this.emit('error', e);\n      }\n    }\n  }\n};\n\n/**\n * Execute message handler buffers\n *\n * @api private\n */\n\nSender.prototype.flush = function() {\n  while (!this.processing && this.messageHandlers.length) {\n    this.messageHandlers.shift()();\n  }\n};\n\n/**\n * Apply extensions to message\n *\n * @api private\n */\n\nSender.prototype.applyExtensions = function(data, fin, compress, callback) {\n  if ((data.buffer || data) instanceof ArrayBuffer) {\n    data = getArrayBuffer(data);\n  }\n  this.extensions[PerMessageDeflate.extensionName].compress(data, fin, callback);\n};\n\nmodule.exports = Sender;\n\nfunction writeUInt16BE(value, offset) {\n  this[offset] = (value & 0xff00)>>8;\n  this[offset+1] = value & 0xff;\n}\n\nfunction writeUInt32BE(value, offset) {\n  this[offset] = (value & 0xff000000)>>24;\n  this[offset+1] = (value & 0xff0000)>>16;\n  this[offset+2] = (value & 0xff00)>>8;\n  this[offset+3] = value & 0xff;\n}\n\nfunction getArrayBuffer(data) {\n  // data is either an ArrayBuffer or ArrayBufferView.\n  var array = new Uint8Array(data.buffer || data)\n    , l = data.byteLength || data.length\n    , o = data.byteOffset || 0\n    , buffer = new Buffer(l);\n  for (var i = 0; i < l; ++i) {\n    buffer[i] = array[o+i];\n  }\n  return buffer;\n}\n\nfunction getRandomMask() {\n  return crypto.randomBytes(4);\n}\n"]}