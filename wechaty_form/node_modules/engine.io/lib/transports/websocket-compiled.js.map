{"version":3,"sources":["websocket.js"],"names":[],"mappings":"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","file":"websocket-compiled.js","sourcesContent":["\n/**\n * Module dependencies.\n */\n\nvar Transport = require('../transport');\nvar parser = require('engine.io-parser');\nvar util = require('util');\nvar debug = require('debug')('engine:ws');\n\n/**\n * Export the constructor.\n */\n\nmodule.exports = WebSocket;\n\n/**\n * WebSocket transport\n *\n * @param {http.IncomingMessage}\n * @api public\n */\n\nfunction WebSocket (req) {\n  Transport.call(this, req);\n  var self = this;\n  this.socket = req.websocket;\n  this.socket.on('message', this.onData.bind(this));\n  this.socket.once('close', this.onClose.bind(this));\n  this.socket.on('error', this.onError.bind(this));\n  this.socket.on('headers', onHeaders);\n  this.writable = true;\n  this.perMessageDeflate = null;\n\n  function onHeaders (headers) {\n    self.emit('headers', headers);\n  }\n}\n\n/**\n * Inherits from Transport.\n */\n\nutil.inherits(WebSocket, Transport);\n\n/**\n * Transport name\n *\n * @api public\n */\n\nWebSocket.prototype.name = 'websocket';\n\n/**\n * Advertise upgrade support.\n *\n * @api public\n */\n\nWebSocket.prototype.handlesUpgrades = true;\n\n/**\n * Advertise framing support.\n *\n * @api public\n */\n\nWebSocket.prototype.supportsFraming = true;\n\n/**\n * Processes the incoming data.\n *\n * @param {String} encoded packet\n * @api private\n */\n\nWebSocket.prototype.onData = function (data) {\n  debug('received \"%s\"', data);\n  Transport.prototype.onData.call(this, data);\n};\n\n/**\n * Writes a packet payload.\n *\n * @param {Array} packets\n * @api private\n */\n\nWebSocket.prototype.send = function (packets) {\n  var self = this;\n\n  for (var i = 0; i < packets.length; i++) {\n    var packet = packets[i];\n    parser.encodePacket(packet, self.supportsBinary, send);\n  }\n\n  function send (data) {\n    debug('writing \"%s\"', data);\n\n    // always creates a new object since ws modifies it\n    var opts = {};\n    if (packet.options) {\n      opts.compress = packet.options.compress;\n    }\n\n    if (self.perMessageDeflate) {\n      var len = 'string' === typeof data ? Buffer.byteLength(data) : data.length;\n      if (len < self.perMessageDeflate.threshold) {\n        opts.compress = false;\n      }\n    }\n\n    self.writable = false;\n    self.socket.send(data, opts, onEnd);\n  }\n\n  function onEnd (err) {\n    if (err) return self.onError('write error', err.stack);\n    self.writable = true;\n    self.emit('drain');\n  }\n};\n\n/**\n * Closes the transport.\n *\n * @api private\n */\n\nWebSocket.prototype.doClose = function (fn) {\n  debug('closing');\n  this.socket.close();\n  fn && fn();\n};\n"]}