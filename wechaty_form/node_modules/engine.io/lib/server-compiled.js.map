{"version":3,"sources":["server.js"],"names":[],"mappings":"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","file":"server-compiled.js","sourcesContent":["\n/**\n * Module dependencies.\n */\n\nvar qs = require('querystring');\nvar parse = require('url').parse;\nvar base64id = require('base64id');\nvar transports = require('./transports');\nvar EventEmitter = require('events').EventEmitter;\nvar Socket = require('./socket');\nvar util = require('util');\nvar debug = require('debug')('engine');\nvar cookieMod = require('cookie');\n\n/**\n * Module exports.\n */\n\nmodule.exports = Server;\n\n/**\n * Server constructor.\n *\n * @param {Object} options\n * @api public\n */\n\nfunction Server (opts) {\n  if (!(this instanceof Server)) {\n    return new Server(opts);\n  }\n\n  this.clients = {};\n  this.clientsCount = 0;\n\n  opts = opts || {};\n\n  this.wsEngine = opts.wsEngine || process.env.EIO_WS_ENGINE;\n  this.pingTimeout = opts.pingTimeout || 60000;\n  this.pingInterval = opts.pingInterval || 25000;\n  this.upgradeTimeout = opts.upgradeTimeout || 10000;\n  this.maxHttpBufferSize = opts.maxHttpBufferSize || 10E7;\n  this.transports = opts.transports || Object.keys(transports);\n  this.allowUpgrades = false !== opts.allowUpgrades;\n  this.allowRequest = opts.allowRequest;\n  this.cookie = false !== opts.cookie ? (opts.cookie || 'io') : false;\n  this.cookiePath = false !== opts.cookiePath ? (opts.cookiePath || '/') : false;\n  this.cookieHttpOnly = false !== opts.cookieHttpOnly;\n  this.perMessageDeflate = false !== opts.perMessageDeflate ? (opts.perMessageDeflate || true) : false;\n  this.httpCompression = false !== opts.httpCompression ? (opts.httpCompression || {}) : false;\n\n  var self = this;\n\n  // initialize compression options\n  ['perMessageDeflate', 'httpCompression'].forEach(function (type) {\n    var compression = self[type];\n    if (true === compression) self[type] = compression = {};\n    if (compression && null == compression.threshold) {\n      compression.threshold = 1024;\n    }\n  });\n\n  // initialize websocket server\n  if (~this.transports.indexOf('websocket')) {\n    // keep require('ws') as separate expression for packers (browserify, etc)\n    var WebSocketServer = (this.wsEngine ? require(this.wsEngine) : require('ws')).Server;\n    this.ws = new WebSocketServer({\n      noServer: true,\n      clientTracking: false,\n      perMessageDeflate: this.perMessageDeflate,\n      maxPayload: this.maxHttpBufferSize\n    });\n  }\n}\n\n/**\n * Protocol errors mappings.\n */\n\nServer.errors = {\n  UNKNOWN_TRANSPORT: 0,\n  UNKNOWN_SID: 1,\n  BAD_HANDSHAKE_METHOD: 2,\n  BAD_REQUEST: 3\n};\n\nServer.errorMessages = {\n  0: 'Transport unknown',\n  1: 'Session ID unknown',\n  2: 'Bad handshake method',\n  3: 'Bad request'\n};\n\n/**\n * Inherits from EventEmitter.\n */\n\nutil.inherits(Server, EventEmitter);\n\n/**\n * Hash of open clients.\n *\n * @api public\n */\n\nServer.prototype.clients;\n\n/**\n * Returns a list of available transports for upgrade given a certain transport.\n *\n * @return {Array}\n * @api public\n */\n\nServer.prototype.upgrades = function (transport) {\n  if (!this.allowUpgrades) return [];\n  return transports[transport].upgradesTo || [];\n};\n\n/**\n * Verifies a request.\n *\n * @param {http.IncomingMessage}\n * @return {Boolean} whether the request is valid\n * @api private\n */\n\nServer.prototype.verify = function (req, upgrade, fn) {\n  // transport check\n  var transport = req._query.transport;\n  if (!~this.transports.indexOf(transport)) {\n    debug('unknown transport \"%s\"', transport);\n    return fn(Server.errors.UNKNOWN_TRANSPORT, false);\n  }\n\n  // sid check\n  var sid = req._query.sid;\n  if (sid) {\n    if (!this.clients.hasOwnProperty(sid)) {\n      return fn(Server.errors.UNKNOWN_SID, false);\n    }\n    if (!upgrade && this.clients[sid].transport.name !== transport) {\n      debug('bad request: unexpected transport without upgrade');\n      return fn(Server.errors.BAD_REQUEST, false);\n    }\n  } else {\n    // handshake is GET only\n    if ('GET' !== req.method) return fn(Server.errors.BAD_HANDSHAKE_METHOD, false);\n    if (!this.allowRequest) return fn(null, true);\n    return this.allowRequest(req, fn);\n  }\n\n  fn(null, true);\n};\n\n/**\n * Prepares a request by processing the query string.\n *\n * @api private\n */\n\nServer.prototype.prepare = function (req) {\n  // try to leverage pre-existing `req._query` (e.g: from connect)\n  if (!req._query) {\n    req._query = ~req.url.indexOf('?') ? qs.parse(parse(req.url).query) : {};\n  }\n};\n\n/**\n * Closes all clients.\n *\n * @api public\n */\n\nServer.prototype.close = function () {\n  debug('closing all open clients');\n  for (var i in this.clients) {\n    if (this.clients.hasOwnProperty(i)) {\n      this.clients[i].close(true);\n    }\n  }\n  if (this.ws) {\n    debug('closing webSocketServer');\n    this.ws.close();\n    // don't delete this.ws because it can be used again if the http server starts listening again\n  }\n  return this;\n};\n\n/**\n * Handles an Engine.IO HTTP request.\n *\n * @param {http.IncomingMessage} request\n * @param {http.ServerResponse|http.OutgoingMessage} response\n * @api public\n */\n\nServer.prototype.handleRequest = function (req, res) {\n  debug('handling \"%s\" http request \"%s\"', req.method, req.url);\n  this.prepare(req);\n  req.res = res;\n\n  var self = this;\n  this.verify(req, false, function (err, success) {\n    if (!success) {\n      sendErrorMessage(req, res, err);\n      return;\n    }\n\n    if (req._query.sid) {\n      debug('setting new request for existing client');\n      self.clients[req._query.sid].transport.onRequest(req);\n    } else {\n      self.handshake(req._query.transport, req);\n    }\n  });\n};\n\n/**\n * Sends an Engine.IO Error Message\n *\n * @param {http.ServerResponse} response\n * @param {code} error code\n * @api private\n */\n\nfunction sendErrorMessage (req, res, code) {\n  var headers = { 'Content-Type': 'application/json' };\n\n  if (req.headers.origin) {\n    headers['Access-Control-Allow-Credentials'] = 'true';\n    headers['Access-Control-Allow-Origin'] = req.headers.origin;\n  } else {\n    headers['Access-Control-Allow-Origin'] = '*';\n  }\n  res.writeHead(400, headers);\n  res.end(JSON.stringify({\n    code: code,\n    message: Server.errorMessages[code]\n  }));\n}\n\n/**\n * generate a socket id.\n * Overwrite this method to generate your custom socket id\n *\n * @param {Object} request object\n * @api public\n */\n\nServer.prototype.generateId = function (req) {\n  return base64id.generateId();\n};\n\n/**\n * Handshakes a new client.\n *\n * @param {String} transport name\n * @param {Object} request object\n * @api private\n */\n\nServer.prototype.handshake = function (transportName, req) {\n  var id = this.generateId(req);\n\n  debug('handshaking client \"%s\"', id);\n\n  try {\n    var transport = new transports[transportName](req);\n    if ('polling' === transportName) {\n      transport.maxHttpBufferSize = this.maxHttpBufferSize;\n      transport.httpCompression = this.httpCompression;\n    } else if ('websocket' === transportName) {\n      transport.perMessageDeflate = this.perMessageDeflate;\n    }\n\n    if (req._query && req._query.b64) {\n      transport.supportsBinary = false;\n    } else {\n      transport.supportsBinary = true;\n    }\n  } catch (e) {\n    sendErrorMessage(req, req.res, Server.errors.BAD_REQUEST);\n    return;\n  }\n  var socket = new Socket(id, this, transport, req);\n  var self = this;\n\n  if (false !== this.cookie) {\n    transport.on('headers', function (headers) {\n      headers['Set-Cookie'] = cookieMod.serialize(self.cookie, id,\n        {\n          path: self.cookiePath,\n          httpOnly: self.cookiePath ? self.cookieHttpOnly : false\n        });\n    });\n  }\n\n  transport.onRequest(req);\n\n  this.clients[id] = socket;\n  this.clientsCount++;\n\n  socket.once('close', function () {\n    delete self.clients[id];\n    self.clientsCount--;\n  });\n\n  this.emit('connection', socket);\n};\n\n/**\n * Handles an Engine.IO HTTP Upgrade.\n *\n * @api public\n */\n\nServer.prototype.handleUpgrade = function (req, socket, upgradeHead) {\n  this.prepare(req);\n\n  var self = this;\n  this.verify(req, true, function (err, success) {\n    if (!success) {\n      abortConnection(socket, err);\n      return;\n    }\n\n    var head = new Buffer(upgradeHead.length);\n    upgradeHead.copy(head);\n    upgradeHead = null;\n\n    // delegate to ws\n    self.ws.handleUpgrade(req, socket, head, function (conn) {\n      self.onWebSocket(req, conn);\n    });\n  });\n};\n\n/**\n * Called upon a ws.io connection.\n *\n * @param {ws.Socket} websocket\n * @api private\n */\n\nServer.prototype.onWebSocket = function (req, socket) {\n  socket.on('error', onUpgradeError);\n\n  if (!transports[req._query.transport].prototype.handlesUpgrades) {\n    debug('transport doesnt handle upgraded requests');\n    socket.close();\n    return;\n  }\n\n  // get client id\n  var id = req._query.sid;\n\n  // keep a reference to the ws.Socket\n  req.websocket = socket;\n\n  if (id) {\n    var client = this.clients[id];\n    if (!client) {\n      debug('upgrade attempt for closed client');\n      socket.close();\n    } else if (client.upgrading) {\n      debug('transport has already been trying to upgrade');\n      socket.close();\n    } else if (client.upgraded) {\n      debug('transport had already been upgraded');\n      socket.close();\n    } else {\n      debug('upgrading existing transport');\n\n      // transport error handling takes over\n      socket.removeListener('error', onUpgradeError);\n\n      var transport = new transports[req._query.transport](req);\n      if (req._query && req._query.b64) {\n        transport.supportsBinary = false;\n      } else {\n        transport.supportsBinary = true;\n      }\n      transport.perMessageDeflate = this.perMessageDeflate;\n      client.maybeUpgrade(transport);\n    }\n  } else {\n    // transport error handling takes over\n    socket.removeListener('error', onUpgradeError);\n\n    this.handshake(req._query.transport, req);\n  }\n\n  function onUpgradeError () {\n    debug('websocket error before upgrade');\n    // socket.close() not needed\n  }\n};\n\n/**\n * Captures upgrade requests for a http.Server.\n *\n * @param {http.Server} server\n * @param {Object} options\n * @api public\n */\n\nServer.prototype.attach = function (server, options) {\n  var self = this;\n  options = options || {};\n  var path = (options.path || '/engine.io').replace(/\\/$/, '');\n\n  var destroyUpgradeTimeout = options.destroyUpgradeTimeout || 1000;\n\n  // normalize path\n  path += '/';\n\n  function check (req) {\n    return path === req.url.substr(0, path.length);\n  }\n\n  // cache and clean up listeners\n  var listeners = server.listeners('request').slice(0);\n  server.removeAllListeners('request');\n  server.on('close', self.close.bind(self));\n\n  // add request handler\n  server.on('request', function (req, res) {\n    if (check(req)) {\n      debug('intercepting request for path \"%s\"', path);\n      self.handleRequest(req, res);\n    } else {\n      for (var i = 0, l = listeners.length; i < l; i++) {\n        listeners[i].call(server, req, res);\n      }\n    }\n  });\n\n  if (~self.transports.indexOf('websocket')) {\n    server.on('upgrade', function (req, socket, head) {\n      if (check(req)) {\n        self.handleUpgrade(req, socket, head);\n      } else if (false !== options.destroyUpgrade) {\n        // default node behavior is to disconnect when no handlers\n        // but by adding a handler, we prevent that\n        // and if no eio thing handles the upgrade\n        // then the socket needs to die!\n        setTimeout(function () {\n          if (socket.writable && socket.bytesWritten <= 0) {\n            return socket.end();\n          }\n        }, destroyUpgradeTimeout);\n      }\n    });\n  }\n};\n\n/**\n * Closes the connection\n *\n * @param {net.Socket} socket\n * @param {code} error code\n * @api private\n */\n\nfunction abortConnection (socket, code) {\n  if (socket.writable) {\n    var message = Server.errorMessages.hasOwnProperty(code) ? Server.errorMessages[code] : (code || '');\n    var length = Buffer.byteLength(message);\n    socket.write(\n      'HTTP/1.1 400 Bad Request\\r\\n' +\n      'Connection: close\\r\\n' +\n      'Content-type: text/html\\r\\n' +\n      'Content-Length: ' + length + '\\r\\n' +\n      '\\r\\n' +\n      message\n    );\n  }\n  socket.destroy();\n}\n"]}