{"version":3,"sources":["WebSocketServer.js"],"names":[],"mappings":"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","file":"WebSocketServer-compiled.js","sourcesContent":["/*!\n * ws: a node.js websocket client\n * Copyright(c) 2011 Einar Otto Stangvik <einaros@gmail.com>\n * MIT Licensed\n */\n\nvar util = require('util')\n  , events = require('events')\n  , http = require('http')\n  , crypto = require('crypto')\n  , Options = require('options')\n  , WebSocket = require('./WebSocket')\n  , Extensions = require('./Extensions')\n  , PerMessageDeflate = require('./PerMessageDeflate')\n  , tls = require('tls')\n  , url = require('url');\n\n/**\n * WebSocket Server implementation\n */\n\nfunction WebSocketServer(options, callback) {\n  if (this instanceof WebSocketServer === false) {\n    return new WebSocketServer(options, callback);\n  }\n\n  events.EventEmitter.call(this);\n\n  options = new Options({\n    host: '0.0.0.0',\n    port: null,\n    server: null,\n    verifyClient: null,\n    handleProtocols: null,\n    path: null,\n    noServer: false,\n    disableHixie: false,\n    clientTracking: true,\n    perMessageDeflate: true,\n    maxPayload: 100 * 1024 * 1024\n  }).merge(options);\n\n  if (!options.isDefinedAndNonNull('port') && !options.isDefinedAndNonNull('server') && !options.value.noServer) {\n    throw new TypeError('`port` or a `server` must be provided');\n  }\n\n  var self = this;\n\n  if (options.isDefinedAndNonNull('port')) {\n    this._server = http.createServer(function (req, res) {\n      var body = http.STATUS_CODES[426];\n      res.writeHead(426, {\n        'Content-Length': body.length,\n        'Content-Type': 'text/plain'\n      });\n      res.end(body);\n    });\n    this._server.allowHalfOpen = false;\n    this._server.listen(options.value.port, options.value.host, callback);\n    this._closeServer = function() { if (self._server) self._server.close(); };\n  }\n  else if (options.value.server) {\n    this._server = options.value.server;\n    if (options.value.path) {\n      // take note of the path, to avoid collisions when multiple websocket servers are\n      // listening on the same http server\n      if (this._server._webSocketPaths && options.value.server._webSocketPaths[options.value.path]) {\n        throw new Error('two instances of WebSocketServer cannot listen on the same http server path');\n      }\n      if (typeof this._server._webSocketPaths !== 'object') {\n        this._server._webSocketPaths = {};\n      }\n      this._server._webSocketPaths[options.value.path] = 1;\n    }\n  }\n  if (this._server) {\n    this._onceServerListening = function() { self.emit('listening'); };\n    this._server.once('listening', this._onceServerListening);\n  }\n\n  if (typeof this._server != 'undefined') {\n    this._onServerError = function(error) { self.emit('error', error) };\n    this._server.on('error', this._onServerError);\n    this._onServerUpgrade = function(req, socket, upgradeHead) {\n      //copy upgradeHead to avoid retention of large slab buffers used in node core\n      var head = new Buffer(upgradeHead.length);\n      upgradeHead.copy(head);\n\n      self.handleUpgrade(req, socket, head, function(client) {\n        self.emit('connection'+req.url, client);\n        self.emit('connection', client);\n      });\n    };\n    this._server.on('upgrade', this._onServerUpgrade);\n  }\n\n  this.options = options.value;\n  this.path = options.value.path;\n  this.clients = [];\n}\n\n/**\n * Inherits from EventEmitter.\n */\n\nutil.inherits(WebSocketServer, events.EventEmitter);\n\n/**\n * Immediately shuts down the connection.\n *\n * @api public\n */\n\nWebSocketServer.prototype.close = function(callback) {\n  // terminate all associated clients\n  var error = null;\n  try {\n    for (var i = 0, l = this.clients.length; i < l; ++i) {\n      this.clients[i].terminate();\n    }\n  }\n  catch (e) {\n    error = e;\n  }\n\n  // remove path descriptor, if any\n  if (this.path && this._server._webSocketPaths) {\n    delete this._server._webSocketPaths[this.path];\n    if (Object.keys(this._server._webSocketPaths).length == 0) {\n      delete this._server._webSocketPaths;\n    }\n  }\n\n  // close the http server if it was internally created\n  try {\n    if (typeof this._closeServer !== 'undefined') {\n      this._closeServer();\n    }\n  }\n  finally {\n    if (this._server) {\n      this._server.removeListener('listening', this._onceServerListening);\n      this._server.removeListener('error', this._onServerError);\n      this._server.removeListener('upgrade', this._onServerUpgrade);\n    }\n    delete this._server;\n  }\n  if(callback)\n    callback(error);\n  else if(error)\n    throw error;\n}\n\n/**\n * Handle a HTTP Upgrade request.\n *\n * @api public\n */\n\nWebSocketServer.prototype.handleUpgrade = function(req, socket, upgradeHead, cb) {\n  // check for wrong path\n  if (this.options.path) {\n    var u = url.parse(req.url);\n    if (u && u.pathname !== this.options.path) return;\n  }\n\n  if (typeof req.headers.upgrade === 'undefined' || req.headers.upgrade.toLowerCase() !== 'websocket') {\n    abortConnection(socket, 400, 'Bad Request');\n    return;\n  }\n\n  if (req.headers['sec-websocket-key1']) handleHixieUpgrade.apply(this, arguments);\n  else handleHybiUpgrade.apply(this, arguments);\n}\n\nmodule.exports = WebSocketServer;\n\n/**\n * Entirely private apis,\n * which may or may not be bound to a sepcific WebSocket instance.\n */\n\nfunction handleHybiUpgrade(req, socket, upgradeHead, cb) {\n  // handle premature socket errors\n  var errorHandler = function() {\n    try { socket.destroy(); } catch (e) {}\n  }\n  socket.on('error', errorHandler);\n\n  // verify key presence\n  if (!req.headers['sec-websocket-key']) {\n    abortConnection(socket, 400, 'Bad Request');\n    return;\n  }\n\n  // verify version\n  var version = parseInt(req.headers['sec-websocket-version']);\n  if ([8, 13].indexOf(version) === -1) {\n    abortConnection(socket, 400, 'Bad Request');\n    return;\n  }\n\n  // verify protocol\n  var protocols = req.headers['sec-websocket-protocol'];\n\n  // verify client\n  var origin = version < 13 ?\n    req.headers['sec-websocket-origin'] :\n    req.headers['origin'];\n\n  // handle extensions offer\n  var extensionsOffer = Extensions.parse(req.headers['sec-websocket-extensions']);\n\n  // handler to call when the connection sequence completes\n  var self = this;\n  var completeHybiUpgrade2 = function(protocol) {\n\n    // calc key\n    var key = req.headers['sec-websocket-key'];\n    var shasum = crypto.createHash('sha1');\n    shasum.update(key + \"258EAFA5-E914-47DA-95CA-C5AB0DC85B11\");\n    key = shasum.digest('base64');\n\n    var headers = [\n        'HTTP/1.1 101 Switching Protocols'\n      , 'Upgrade: websocket'\n      , 'Connection: Upgrade'\n      , 'Sec-WebSocket-Accept: ' + key\n    ];\n\n    if (typeof protocol != 'undefined') {\n      headers.push('Sec-WebSocket-Protocol: ' + protocol);\n    }\n\n    var extensions = {};\n    try {\n      extensions = acceptExtensions.call(self, extensionsOffer);\n    } catch (err) {\n      abortConnection(socket, 400, 'Bad Request');\n      return;\n    }\n\n    if (Object.keys(extensions).length) {\n      var serverExtensions = {};\n      Object.keys(extensions).forEach(function(token) {\n        serverExtensions[token] = [extensions[token].params]\n      });\n      headers.push('Sec-WebSocket-Extensions: ' + Extensions.format(serverExtensions));\n    }\n\n    // allows external modification/inspection of handshake headers\n    self.emit('headers', headers);\n\n    socket.setTimeout(0);\n    socket.setNoDelay(true);\n    try {\n      socket.write(headers.concat('', '').join('\\r\\n'));\n    }\n    catch (e) {\n      // if the upgrade write fails, shut the connection down hard\n      try { socket.destroy(); } catch (e) {}\n      return;\n    }\n\n    var client = new WebSocket([req, socket, upgradeHead], {\n      protocolVersion: version,\n      protocol: protocol,\n      extensions: extensions,\n      maxPayload: self.options.maxPayload\n    });\n\n    if (self.options.clientTracking) {\n      self.clients.push(client);\n      client.on('close', function() {\n        var index = self.clients.indexOf(client);\n        if (index != -1) {\n          self.clients.splice(index, 1);\n        }\n      });\n    }\n\n    // signal upgrade complete\n    socket.removeListener('error', errorHandler);\n    cb(client);\n  }\n\n  // optionally call external protocol selection handler before\n  // calling completeHybiUpgrade2\n  var completeHybiUpgrade1 = function() {\n    // choose from the sub-protocols\n    if (typeof self.options.handleProtocols == 'function') {\n        var protList = (protocols || \"\").split(/, */);\n        var callbackCalled = false;\n        var res = self.options.handleProtocols(protList, function(result, protocol) {\n          callbackCalled = true;\n          if (!result) abortConnection(socket, 401, 'Unauthorized');\n          else completeHybiUpgrade2(protocol);\n        });\n        if (!callbackCalled) {\n            // the handleProtocols handler never called our callback\n            abortConnection(socket, 501, 'Could not process protocols');\n        }\n        return;\n    } else {\n        if (typeof protocols !== 'undefined') {\n            completeHybiUpgrade2(protocols.split(/, */)[0]);\n        }\n        else {\n            completeHybiUpgrade2();\n        }\n    }\n  }\n\n  // optionally call external client verification handler\n  if (typeof this.options.verifyClient == 'function') {\n    var info = {\n      origin: origin,\n      secure: typeof req.connection.authorized !== 'undefined' || typeof req.connection.encrypted !== 'undefined',\n      req: req\n    };\n    if (this.options.verifyClient.length == 2) {\n      this.options.verifyClient(info, function(result, code, name) {\n        if (typeof code === 'undefined') code = 401;\n        if (typeof name === 'undefined') name = http.STATUS_CODES[code];\n\n        if (!result) abortConnection(socket, code, name);\n        else completeHybiUpgrade1();\n      });\n      return;\n    }\n    else if (!this.options.verifyClient(info)) {\n      abortConnection(socket, 401, 'Unauthorized');\n      return;\n    }\n  }\n\n  completeHybiUpgrade1();\n}\n\nfunction handleHixieUpgrade(req, socket, upgradeHead, cb) {\n  // handle premature socket errors\n  var errorHandler = function() {\n    try { socket.destroy(); } catch (e) {}\n  }\n  socket.on('error', errorHandler);\n\n  // bail if options prevent hixie\n  if (this.options.disableHixie) {\n    abortConnection(socket, 401, 'Hixie support disabled');\n    return;\n  }\n\n  // verify key presence\n  if (!req.headers['sec-websocket-key2']) {\n    abortConnection(socket, 400, 'Bad Request');\n    return;\n  }\n\n  var origin = req.headers['origin']\n    , self = this;\n\n  // setup handshake completion to run after client has been verified\n  var onClientVerified = function() {\n    var wshost;\n    if (!req.headers['x-forwarded-host'])\n        wshost = req.headers.host;\n    else\n        wshost = req.headers['x-forwarded-host'];\n    var location = ((req.headers['x-forwarded-proto'] === 'https' || socket.encrypted) ? 'wss' : 'ws') + '://' + wshost + req.url\n      , protocol = req.headers['sec-websocket-protocol'];\n\n    // build the response header and return a Buffer\n    var buildResponseHeader = function() {\n      var headers = [\n          'HTTP/1.1 101 Switching Protocols'\n        , 'Upgrade: WebSocket'\n        , 'Connection: Upgrade'\n        , 'Sec-WebSocket-Location: ' + location\n      ];\n      if (typeof protocol != 'undefined') headers.push('Sec-WebSocket-Protocol: ' + protocol);\n      if (typeof origin != 'undefined') headers.push('Sec-WebSocket-Origin: ' + origin);\n\n      return new Buffer(headers.concat('', '').join('\\r\\n'));\n    };\n\n    // send handshake response before receiving the nonce\n    var handshakeResponse = function() {\n\n      socket.setTimeout(0);\n      socket.setNoDelay(true);\n\n      var headerBuffer = buildResponseHeader();\n\n      try {\n        socket.write(headerBuffer, 'binary', function(err) {\n          // remove listener if there was an error\n          if (err) socket.removeListener('data', handler);\n          return;\n        });\n      } catch (e) {\n        try { socket.destroy(); } catch (e) {}\n        return;\n      };\n    };\n\n    // handshake completion code to run once nonce has been successfully retrieved\n    var completeHandshake = function(nonce, rest, headerBuffer) {\n      // calculate key\n      var k1 = req.headers['sec-websocket-key1']\n        , k2 = req.headers['sec-websocket-key2']\n        , md5 = crypto.createHash('md5');\n\n      [k1, k2].forEach(function (k) {\n        var n = parseInt(k.replace(/[^\\d]/g, ''))\n          , spaces = k.replace(/[^ ]/g, '').length;\n        if (spaces === 0 || n % spaces !== 0){\n          abortConnection(socket, 400, 'Bad Request');\n          return;\n        }\n        n /= spaces;\n        md5.update(String.fromCharCode(\n          n >> 24 & 0xFF,\n          n >> 16 & 0xFF,\n          n >> 8  & 0xFF,\n          n       & 0xFF));\n      });\n      md5.update(nonce.toString('binary'));\n\n      socket.setTimeout(0);\n      socket.setNoDelay(true);\n\n      try {\n        var hashBuffer = new Buffer(md5.digest('binary'), 'binary');\n        var handshakeBuffer = new Buffer(headerBuffer.length + hashBuffer.length);\n        headerBuffer.copy(handshakeBuffer, 0);\n        hashBuffer.copy(handshakeBuffer, headerBuffer.length);\n\n        // do a single write, which - upon success - causes a new client websocket to be setup\n        socket.write(handshakeBuffer, 'binary', function(err) {\n          if (err) return; // do not create client if an error happens\n          var client = new WebSocket([req, socket, rest], {\n            protocolVersion: 'hixie-76',\n            protocol: protocol\n          });\n          if (self.options.clientTracking) {\n            self.clients.push(client);\n            client.on('close', function() {\n              var index = self.clients.indexOf(client);\n              if (index != -1) {\n                self.clients.splice(index, 1);\n              }\n            });\n          }\n\n          // signal upgrade complete\n          socket.removeListener('error', errorHandler);\n          cb(client);\n        });\n      }\n      catch (e) {\n        try { socket.destroy(); } catch (e) {}\n        return;\n      }\n    }\n\n    // retrieve nonce\n    var nonceLength = 8;\n    if (upgradeHead && upgradeHead.length >= nonceLength) {\n      var nonce = upgradeHead.slice(0, nonceLength);\n      var rest = upgradeHead.length > nonceLength ? upgradeHead.slice(nonceLength) : null;\n      completeHandshake.call(self, nonce, rest, buildResponseHeader());\n    }\n    else {\n      // nonce not present in upgradeHead\n      var nonce = new Buffer(nonceLength);\n      upgradeHead.copy(nonce, 0);\n      var received = upgradeHead.length;\n      var rest = null;\n      var handler = function (data) {\n        var toRead = Math.min(data.length, nonceLength - received);\n        if (toRead === 0) return;\n        data.copy(nonce, received, 0, toRead);\n        received += toRead;\n        if (received == nonceLength) {\n          socket.removeListener('data', handler);\n          if (toRead < data.length) rest = data.slice(toRead);\n\n          // complete the handshake but send empty buffer for headers since they have already been sent\n          completeHandshake.call(self, nonce, rest, new Buffer(0));\n        }\n      }\n\n      // handle additional data as we receive it\n      socket.on('data', handler);\n\n      // send header response before we have the nonce to fix haproxy buffering\n      handshakeResponse();\n    }\n  }\n\n  // verify client\n  if (typeof this.options.verifyClient == 'function') {\n    var info = {\n      origin: origin,\n      secure: typeof req.connection.authorized !== 'undefined' || typeof req.connection.encrypted !== 'undefined',\n      req: req\n    };\n    if (this.options.verifyClient.length == 2) {\n      var self = this;\n      this.options.verifyClient(info, function(result, code, name) {\n        if (typeof code === 'undefined') code = 401;\n        if (typeof name === 'undefined') name = http.STATUS_CODES[code];\n\n        if (!result) abortConnection(socket, code, name);\n        else onClientVerified.apply(self);\n      });\n      return;\n    }\n    else if (!this.options.verifyClient(info)) {\n      abortConnection(socket, 401, 'Unauthorized');\n      return;\n    }\n  }\n\n  // no client verification required\n  onClientVerified();\n}\n\nfunction acceptExtensions(offer) {\n  var extensions = {};\n  var options = this.options.perMessageDeflate;\n  var maxPayload = this.options.maxPayload;\n  if (options && offer[PerMessageDeflate.extensionName]) {\n    var perMessageDeflate = new PerMessageDeflate(options !== true ? options : {}, true, maxPayload);\n    perMessageDeflate.accept(offer[PerMessageDeflate.extensionName]);\n    extensions[PerMessageDeflate.extensionName] = perMessageDeflate;\n  }\n  return extensions;\n}\n\nfunction abortConnection(socket, code, name) {\n  try {\n    var response = [\n      'HTTP/1.1 ' + code + ' ' + name,\n      'Content-type: text/html'\n    ];\n    socket.write(response.concat('', '').join('\\r\\n'));\n  }\n  catch (e) { /* ignore errors - we've aborted this connection */ }\n  finally {\n    // ensure that an early aborted connection is shut down completely\n    try { socket.destroy(); } catch (e) {}\n  }\n}\n"]}