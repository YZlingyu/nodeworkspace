{"version":3,"sources":["PerMessageDeflate.js"],"names":[],"mappings":"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","file":"PerMessageDeflate-compiled.js","sourcesContent":["\nvar zlib = require('zlib');\n\nvar AVAILABLE_WINDOW_BITS = [8, 9, 10, 11, 12, 13, 14, 15];\nvar DEFAULT_WINDOW_BITS = 15;\nvar DEFAULT_MEM_LEVEL = 8;\n\nPerMessageDeflate.extensionName = 'permessage-deflate';\n\n/**\n * Per-message Compression Extensions implementation\n */\n\nfunction PerMessageDeflate(options, isServer,maxPayload) {\n  if (this instanceof PerMessageDeflate === false) {\n    throw new TypeError(\"Classes can't be function-called\");\n  }\n\n  this._options = options || {};\n  this._isServer = !!isServer;\n  this._inflate = null;\n  this._deflate = null;\n  this.params = null;\n  this._maxPayload = maxPayload || 0;\n}\n\n/**\n * Create extension parameters offer\n *\n * @api public\n */\n\nPerMessageDeflate.prototype.offer = function() {\n  var params = {};\n  if (this._options.serverNoContextTakeover) {\n    params.server_no_context_takeover = true;\n  }\n  if (this._options.clientNoContextTakeover) {\n    params.client_no_context_takeover = true;\n  }\n  if (this._options.serverMaxWindowBits) {\n    params.server_max_window_bits = this._options.serverMaxWindowBits;\n  }\n  if (this._options.clientMaxWindowBits) {\n    params.client_max_window_bits = this._options.clientMaxWindowBits;\n  } else if (this._options.clientMaxWindowBits == null) {\n    params.client_max_window_bits = true;\n  }\n  return params;\n};\n\n/**\n * Accept extension offer\n *\n * @api public\n */\n\nPerMessageDeflate.prototype.accept = function(paramsList) {\n  paramsList = this.normalizeParams(paramsList);\n\n  var params;\n  if (this._isServer) {\n    params = this.acceptAsServer(paramsList);\n  } else {\n    params = this.acceptAsClient(paramsList);\n  }\n\n  this.params = params;\n  return params;\n};\n\n/**\n * Releases all resources used by the extension\n *\n * @api public\n */\n\nPerMessageDeflate.prototype.cleanup = function() {\n  if (this._inflate) {\n    if (this._inflate.writeInProgress) {\n      this._inflate.pendingClose = true;\n    } else {\n      if (this._inflate.close) this._inflate.close();\n      this._inflate = null;\n    }\n  }\n  if (this._deflate) {\n    if (this._deflate.writeInProgress) {\n      this._deflate.pendingClose = true;\n    } else {\n      if (this._deflate.close) this._deflate.close();\n      this._deflate = null;\n    }\n  }\n};\n\n/**\n * Accept extension offer from client\n *\n * @api private\n */\n\nPerMessageDeflate.prototype.acceptAsServer = function(paramsList) {\n  var accepted = {};\n  var result = paramsList.some(function(params) {\n    accepted = {};\n    if (this._options.serverNoContextTakeover === false && params.server_no_context_takeover) {\n      return;\n    }\n    if (this._options.serverMaxWindowBits === false && params.server_max_window_bits) {\n      return;\n    }\n    if (typeof this._options.serverMaxWindowBits === 'number' &&\n        typeof params.server_max_window_bits === 'number' &&\n        this._options.serverMaxWindowBits > params.server_max_window_bits) {\n      return;\n    }\n    if (typeof this._options.clientMaxWindowBits === 'number' && !params.client_max_window_bits) {\n      return;\n    }\n\n    if (this._options.serverNoContextTakeover || params.server_no_context_takeover) {\n      accepted.server_no_context_takeover = true;\n    }\n    if (this._options.clientNoContextTakeover) {\n      accepted.client_no_context_takeover = true;\n    }\n    if (this._options.clientNoContextTakeover !== false && params.client_no_context_takeover) {\n      accepted.client_no_context_takeover = true;\n    }\n    if (typeof this._options.serverMaxWindowBits === 'number') {\n      accepted.server_max_window_bits = this._options.serverMaxWindowBits;\n    } else if (typeof params.server_max_window_bits === 'number') {\n      accepted.server_max_window_bits = params.server_max_window_bits;\n    }\n    if (typeof this._options.clientMaxWindowBits === 'number') {\n      accepted.client_max_window_bits = this._options.clientMaxWindowBits;\n    } else if (this._options.clientMaxWindowBits !== false && typeof params.client_max_window_bits === 'number') {\n      accepted.client_max_window_bits = params.client_max_window_bits;\n    }\n    return true;\n  }, this);\n\n  if (!result) {\n    throw new Error('Doesn\\'t support the offered configuration');\n  }\n\n  return accepted;\n};\n\n/**\n * Accept extension response from server\n *\n * @api privaye\n */\n\nPerMessageDeflate.prototype.acceptAsClient = function(paramsList) {\n  var params = paramsList[0];\n  if (this._options.clientNoContextTakeover != null) {\n    if (this._options.clientNoContextTakeover === false && params.client_no_context_takeover) {\n      throw new Error('Invalid value for \"client_no_context_takeover\"');\n    }\n  }\n  if (this._options.clientMaxWindowBits != null) {\n    if (this._options.clientMaxWindowBits === false && params.client_max_window_bits) {\n      throw new Error('Invalid value for \"client_max_window_bits\"');\n    }\n    if (typeof this._options.clientMaxWindowBits === 'number' &&\n        (!params.client_max_window_bits || params.client_max_window_bits > this._options.clientMaxWindowBits)) {\n      throw new Error('Invalid value for \"client_max_window_bits\"');\n    }\n  }\n  return params;\n};\n\n/**\n * Normalize extensions parameters\n *\n * @api private\n */\n\nPerMessageDeflate.prototype.normalizeParams = function(paramsList) {\n  return paramsList.map(function(params) {\n    Object.keys(params).forEach(function(key) {\n      var value = params[key];\n      if (value.length > 1) {\n        throw new Error('Multiple extension parameters for ' + key);\n      }\n\n      value = value[0];\n\n      switch (key) {\n      case 'server_no_context_takeover':\n      case 'client_no_context_takeover':\n        if (value !== true) {\n          throw new Error('invalid extension parameter value for ' + key + ' (' + value + ')');\n        }\n        params[key] = true;\n        break;\n      case 'server_max_window_bits':\n      case 'client_max_window_bits':\n        if (typeof value === 'string') {\n          value = parseInt(value, 10);\n          if (!~AVAILABLE_WINDOW_BITS.indexOf(value)) {\n            throw new Error('invalid extension parameter value for ' + key + ' (' + value + ')');\n          }\n        }\n        if (!this._isServer && value === true) {\n          throw new Error('Missing extension parameter value for ' + key);\n        }\n        params[key] = value;\n        break;\n      default:\n        throw new Error('Not defined extension parameter (' + key + ')');\n      }\n    }, this);\n    return params;\n  }, this);\n};\n\n/**\n * Decompress message\n *\n * @api public\n */\n\nPerMessageDeflate.prototype.decompress = function (data, fin, callback) {\n  var endpoint = this._isServer ? 'client' : 'server';\n\n  if (!this._inflate) {\n    var maxWindowBits = this.params[endpoint + '_max_window_bits'];\n    this._inflate = zlib.createInflateRaw({\n      windowBits: 'number' === typeof maxWindowBits ? maxWindowBits : DEFAULT_WINDOW_BITS\n    });\n  }\n  this._inflate.writeInProgress = true;\n\n  var self = this;\n  var buffers = [];\n  var cumulativeBufferLength=0;\n\n  this._inflate.on('error', onError).on('data', onData);\n  this._inflate.write(data);\n  if (fin) {\n    this._inflate.write(new Buffer([0x00, 0x00, 0xff, 0xff]));\n  }\n  this._inflate.flush(function() {\n    cleanup();\n    callback(null, Buffer.concat(buffers));\n  });\n\n  function onError(err) {\n    cleanup();\n    callback(err);\n  }\n\n  function onData(data) {\n      if(self._maxPayload!==undefined && self._maxPayload!==null && self._maxPayload>0){\n          cumulativeBufferLength+=data.length;\n          if(cumulativeBufferLength>self._maxPayload){\n            buffers=[];\n            cleanup();\n            var err={type:1009};\n            callback(err);\n            return;\n          }\n      }\n      buffers.push(data);\n  }\n\n  function cleanup() {\n    if (!self._inflate) return;\n    self._inflate.removeListener('error', onError);\n    self._inflate.removeListener('data', onData);\n    self._inflate.writeInProgress = false;\n    if ((fin && self.params[endpoint + '_no_context_takeover']) || self._inflate.pendingClose) {\n      if (self._inflate.close) self._inflate.close();\n      self._inflate = null;\n    }\n  }\n};\n\n/**\n * Compress message\n *\n * @api public\n */\n\nPerMessageDeflate.prototype.compress = function (data, fin, callback) {\n  var endpoint = this._isServer ? 'server' : 'client';\n\n  if (!this._deflate) {\n    var maxWindowBits = this.params[endpoint + '_max_window_bits'];\n    this._deflate = zlib.createDeflateRaw({\n      flush: zlib.Z_SYNC_FLUSH,\n      windowBits: 'number' === typeof maxWindowBits ? maxWindowBits : DEFAULT_WINDOW_BITS,\n      memLevel: this._options.memLevel || DEFAULT_MEM_LEVEL\n    });\n  }\n  this._deflate.writeInProgress = true;\n\n  var self = this;\n  var buffers = [];\n\n  this._deflate.on('error', onError).on('data', onData);\n  this._deflate.write(data);\n  this._deflate.flush(function() {\n    cleanup();\n    var data = Buffer.concat(buffers);\n    if (fin) {\n      data = data.slice(0, data.length - 4);\n    }\n    callback(null, data);\n  });\n\n  function onError(err) {\n    cleanup();\n    callback(err);\n  }\n\n  function onData(data) {\n    buffers.push(data);\n  }\n\n  function cleanup() {\n    if (!self._deflate) return;\n    self._deflate.removeListener('error', onError);\n    self._deflate.removeListener('data', onData);\n    self._deflate.writeInProgress = false;\n    if ((fin && self.params[endpoint + '_no_context_takeover']) || self._deflate.pendingClose) {\n      if (self._deflate.close) self._deflate.close();\n      self._deflate = null;\n    }\n  }\n};\n\nmodule.exports = PerMessageDeflate;\n"]}