{"version":3,"sources":["websocket.js"],"names":[],"mappings":"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","file":"websocket-compiled.js","sourcesContent":["/**\n * Module dependencies.\n */\n\nvar Transport = require('../transport');\nvar parser = require('engine.io-parser');\nvar parseqs = require('parseqs');\nvar inherit = require('component-inherit');\nvar yeast = require('yeast');\nvar debug = require('debug')('engine.io-client:websocket');\nvar BrowserWebSocket = global.WebSocket || global.MozWebSocket;\nvar NodeWebSocket;\nif (typeof window === 'undefined') {\n  try {\n    NodeWebSocket = require('ws');\n  } catch (e) { }\n}\n\n/**\n * Get either the `WebSocket` or `MozWebSocket` globals\n * in the browser or try to resolve WebSocket-compatible\n * interface exposed by `ws` for Node-like environment.\n */\n\nvar WebSocket = BrowserWebSocket;\nif (!WebSocket && typeof window === 'undefined') {\n  WebSocket = NodeWebSocket;\n}\n\n/**\n * Module exports.\n */\n\nmodule.exports = WS;\n\n/**\n * WebSocket transport constructor.\n *\n * @api {Object} connection options\n * @api public\n */\n\nfunction WS (opts) {\n  var forceBase64 = (opts && opts.forceBase64);\n  if (forceBase64) {\n    this.supportsBinary = false;\n  }\n  this.perMessageDeflate = opts.perMessageDeflate;\n  this.usingBrowserWebSocket = BrowserWebSocket && !opts.forceNode;\n  if (!this.usingBrowserWebSocket) {\n    WebSocket = NodeWebSocket;\n  }\n  Transport.call(this, opts);\n}\n\n/**\n * Inherits from Transport.\n */\n\ninherit(WS, Transport);\n\n/**\n * Transport name.\n *\n * @api public\n */\n\nWS.prototype.name = 'websocket';\n\n/*\n * WebSockets support binary\n */\n\nWS.prototype.supportsBinary = true;\n\n/**\n * Opens socket.\n *\n * @api private\n */\n\nWS.prototype.doOpen = function () {\n  if (!this.check()) {\n    // let probe timeout\n    return;\n  }\n\n  var uri = this.uri();\n  var protocols = void (0);\n  var opts = {\n    agent: this.agent,\n    perMessageDeflate: this.perMessageDeflate\n  };\n\n  // SSL options for Node.js client\n  opts.pfx = this.pfx;\n  opts.key = this.key;\n  opts.passphrase = this.passphrase;\n  opts.cert = this.cert;\n  opts.ca = this.ca;\n  opts.ciphers = this.ciphers;\n  opts.rejectUnauthorized = this.rejectUnauthorized;\n  if (this.extraHeaders) {\n    opts.headers = this.extraHeaders;\n  }\n  if (this.localAddress) {\n    opts.localAddress = this.localAddress;\n  }\n\n  try {\n    this.ws = this.usingBrowserWebSocket ? new WebSocket(uri) : new WebSocket(uri, protocols, opts);\n  } catch (err) {\n    return this.emit('error', err);\n  }\n\n  if (this.ws.binaryType === undefined) {\n    this.supportsBinary = false;\n  }\n\n  if (this.ws.supports && this.ws.supports.binary) {\n    this.supportsBinary = true;\n    this.ws.binaryType = 'nodebuffer';\n  } else {\n    this.ws.binaryType = 'arraybuffer';\n  }\n\n  this.addEventListeners();\n};\n\n/**\n * Adds event listeners to the socket\n *\n * @api private\n */\n\nWS.prototype.addEventListeners = function () {\n  var self = this;\n\n  this.ws.onopen = function () {\n    self.onOpen();\n  };\n  this.ws.onclose = function () {\n    self.onClose();\n  };\n  this.ws.onmessage = function (ev) {\n    self.onData(ev.data);\n  };\n  this.ws.onerror = function (e) {\n    self.onError('websocket error', e);\n  };\n};\n\n/**\n * Writes data to socket.\n *\n * @param {Array} array of packets.\n * @api private\n */\n\nWS.prototype.write = function (packets) {\n  var self = this;\n  this.writable = false;\n\n  // encodePacket efficient as it uses WS framing\n  // no need for encodePayload\n  var total = packets.length;\n  for (var i = 0, l = total; i < l; i++) {\n    (function (packet) {\n      parser.encodePacket(packet, self.supportsBinary, function (data) {\n        if (!self.usingBrowserWebSocket) {\n          // always create a new object (GH-437)\n          var opts = {};\n          if (packet.options) {\n            opts.compress = packet.options.compress;\n          }\n\n          if (self.perMessageDeflate) {\n            var len = 'string' === typeof data ? global.Buffer.byteLength(data) : data.length;\n            if (len < self.perMessageDeflate.threshold) {\n              opts.compress = false;\n            }\n          }\n        }\n\n        // Sometimes the websocket has already been closed but the browser didn't\n        // have a chance of informing us about it yet, in that case send will\n        // throw an error\n        try {\n          if (self.usingBrowserWebSocket) {\n            // TypeError is thrown when passing the second argument on Safari\n            self.ws.send(data);\n          } else {\n            self.ws.send(data, opts);\n          }\n        } catch (e) {\n          debug('websocket closed before onclose event');\n        }\n\n        --total || done();\n      });\n    })(packets[i]);\n  }\n\n  function done () {\n    self.emit('flush');\n\n    // fake drain\n    // defer to next tick to allow Socket to clear writeBuffer\n    setTimeout(function () {\n      self.writable = true;\n      self.emit('drain');\n    }, 0);\n  }\n};\n\n/**\n * Called upon close\n *\n * @api private\n */\n\nWS.prototype.onClose = function () {\n  Transport.prototype.onClose.call(this);\n};\n\n/**\n * Closes socket.\n *\n * @api private\n */\n\nWS.prototype.doClose = function () {\n  if (typeof this.ws !== 'undefined') {\n    this.ws.close();\n  }\n};\n\n/**\n * Generates uri for connection.\n *\n * @api private\n */\n\nWS.prototype.uri = function () {\n  var query = this.query || {};\n  var schema = this.secure ? 'wss' : 'ws';\n  var port = '';\n\n  // avoid port if default for schema\n  if (this.port && (('wss' === schema && Number(this.port) !== 443) ||\n    ('ws' === schema && Number(this.port) !== 80))) {\n    port = ':' + this.port;\n  }\n\n  // append timestamp to URI\n  if (this.timestampRequests) {\n    query[this.timestampParam] = yeast();\n  }\n\n  // communicate binary support capabilities\n  if (!this.supportsBinary) {\n    query.b64 = 1;\n  }\n\n  query = parseqs.encode(query);\n\n  // prepend ? to query\n  if (query.length) {\n    query = '?' + query;\n  }\n\n  var ipv6 = this.hostname.indexOf(':') !== -1;\n  return schema + '://' + (ipv6 ? '[' + this.hostname + ']' : this.hostname) + port + this.path + query;\n};\n\n/**\n * Feature detection for WebSocket.\n *\n * @return {Boolean} whether this transport is available.\n * @api public\n */\n\nWS.prototype.check = function () {\n  return !!WebSocket && !('__initialize' in WebSocket && this.name === WS.prototype.name);\n};\n"]}