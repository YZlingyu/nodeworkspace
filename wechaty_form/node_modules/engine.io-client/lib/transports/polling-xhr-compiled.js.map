{"version":3,"sources":["polling-xhr.js"],"names":[],"mappings":"AAAA;;;;AAIA,IAAI,iBAAiB,QAAQ,oBAAR,CAArB;AACA,IAAI,UAAU,QAAQ,WAAR,CAAd;AACA,IAAI,UAAU,QAAQ,mBAAR,CAAd;AACA,IAAI,UAAU,QAAQ,mBAAR,CAAd;AACA,IAAI,QAAQ,QAAQ,OAAR,EAAiB,8BAAjB,CAAZ;;AAEA;;;;AAIA,OAAO,OAAP,GAAiB,GAAjB;AACA,OAAO,OAAP,CAAe,OAAf,GAAyB,OAAzB;;AAEA;;;;AAIA,SAAS,KAAT,GAAkB,CAAE;;AAEpB;;;;;;;AAOA,SAAS,GAAT,CAAc,IAAd,EAAoB;AAClB,UAAQ,IAAR,CAAa,IAAb,EAAmB,IAAnB;AACA,OAAK,cAAL,GAAsB,KAAK,cAA3B;;AAEA,MAAI,OAAO,QAAX,EAAqB;AACnB,QAAI,QAAQ,aAAa,SAAS,QAAlC;AACA,QAAI,OAAO,SAAS,IAApB;;AAEA;AACA,QAAI,CAAC,IAAL,EAAW;AACT,aAAO,QAAQ,GAAR,GAAc,EAArB;AACD;;AAED,SAAK,EAAL,GAAU,KAAK,QAAL,KAAkB,OAAO,QAAP,CAAgB,QAAlC,IACR,SAAS,KAAK,IADhB;AAEA,SAAK,EAAL,GAAU,KAAK,MAAL,KAAgB,KAA1B;AACD,GAZD,MAYO;AACL,SAAK,YAAL,GAAoB,KAAK,YAAzB;AACD;AACF;;AAED;;;;AAIA,QAAQ,GAAR,EAAa,OAAb;;AAEA;;;;AAIA,IAAI,SAAJ,CAAc,cAAd,GAA+B,IAA/B;;AAEA;;;;;;;AAOA,IAAI,SAAJ,CAAc,OAAd,GAAwB,UAAU,IAAV,EAAgB;AACtC,SAAO,QAAQ,EAAf;AACA,OAAK,GAAL,GAAW,KAAK,GAAL,EAAX;AACA,OAAK,EAAL,GAAU,KAAK,EAAf;AACA,OAAK,EAAL,GAAU,KAAK,EAAf;AACA,OAAK,KAAL,GAAa,KAAK,KAAL,IAAc,KAA3B;AACA,OAAK,cAAL,GAAsB,KAAK,cAA3B;AACA,OAAK,UAAL,GAAkB,KAAK,UAAvB;;AAEA;AACA,OAAK,GAAL,GAAW,KAAK,GAAhB;AACA,OAAK,GAAL,GAAW,KAAK,GAAhB;AACA,OAAK,UAAL,GAAkB,KAAK,UAAvB;AACA,OAAK,IAAL,GAAY,KAAK,IAAjB;AACA,OAAK,EAAL,GAAU,KAAK,EAAf;AACA,OAAK,OAAL,GAAe,KAAK,OAApB;AACA,OAAK,kBAAL,GAA0B,KAAK,kBAA/B;AACA,OAAK,cAAL,GAAsB,KAAK,cAA3B;;AAEA;AACA,OAAK,YAAL,GAAoB,KAAK,YAAzB;;AAEA,SAAO,IAAI,OAAJ,CAAY,IAAZ,CAAP;AACD,CAvBD;;AAyBA;;;;;;;;AAQA,IAAI,SAAJ,CAAc,OAAd,GAAwB,UAAU,IAAV,EAAgB,EAAhB,EAAoB;AAC1C,MAAI,WAAW,OAAO,IAAP,KAAgB,QAAhB,IAA4B,SAAS,SAApD;AACA,MAAI,MAAM,KAAK,OAAL,CAAa,EAAE,QAAQ,MAAV,EAAkB,MAAM,IAAxB,EAA8B,UAAU,QAAxC,EAAb,CAAV;AACA,MAAI,OAAO,IAAX;AACA,MAAI,EAAJ,CAAO,SAAP,EAAkB,EAAlB;AACA,MAAI,EAAJ,CAAO,OAAP,EAAgB,UAAU,GAAV,EAAe;AAC7B,SAAK,OAAL,CAAa,gBAAb,EAA+B,GAA/B;AACD,GAFD;AAGA,OAAK,OAAL,GAAe,GAAf;AACD,CATD;;AAWA;;;;;;AAMA,IAAI,SAAJ,CAAc,MAAd,GAAuB,YAAY;AACjC,QAAM,UAAN;AACA,MAAI,MAAM,KAAK,OAAL,EAAV;AACA,MAAI,OAAO,IAAX;AACA,MAAI,EAAJ,CAAO,MAAP,EAAe,UAAU,IAAV,EAAgB;AAC7B,SAAK,MAAL,CAAY,IAAZ;AACD,GAFD;AAGA,MAAI,EAAJ,CAAO,OAAP,EAAgB,UAAU,GAAV,EAAe;AAC7B,SAAK,OAAL,CAAa,gBAAb,EAA+B,GAA/B;AACD,GAFD;AAGA,OAAK,OAAL,GAAe,GAAf;AACD,CAXD;;AAaA;;;;;;;AAOA,SAAS,OAAT,CAAkB,IAAlB,EAAwB;AACtB,OAAK,MAAL,GAAc,KAAK,MAAL,IAAe,KAA7B;AACA,OAAK,GAAL,GAAW,KAAK,GAAhB;AACA,OAAK,EAAL,GAAU,CAAC,CAAC,KAAK,EAAjB;AACA,OAAK,EAAL,GAAU,CAAC,CAAC,KAAK,EAAjB;AACA,OAAK,KAAL,GAAa,UAAU,KAAK,KAA5B;AACA,OAAK,IAAL,GAAY,cAAc,KAAK,IAAnB,GAA0B,KAAK,IAA/B,GAAsC,IAAlD;AACA,OAAK,KAAL,GAAa,KAAK,KAAlB;AACA,OAAK,QAAL,GAAgB,KAAK,QAArB;AACA,OAAK,cAAL,GAAsB,KAAK,cAA3B;AACA,OAAK,UAAL,GAAkB,KAAK,UAAvB;AACA,OAAK,cAAL,GAAsB,KAAK,cAA3B;;AAEA;AACA,OAAK,GAAL,GAAW,KAAK,GAAhB;AACA,OAAK,GAAL,GAAW,KAAK,GAAhB;AACA,OAAK,UAAL,GAAkB,KAAK,UAAvB;AACA,OAAK,IAAL,GAAY,KAAK,IAAjB;AACA,OAAK,EAAL,GAAU,KAAK,EAAf;AACA,OAAK,OAAL,GAAe,KAAK,OAApB;AACA,OAAK,kBAAL,GAA0B,KAAK,kBAA/B;;AAEA;AACA,OAAK,YAAL,GAAoB,KAAK,YAAzB;;AAEA,OAAK,MAAL;AACD;;AAED;;;;AAIA,QAAQ,QAAQ,SAAhB;;AAEA;;;;;;AAMA,QAAQ,SAAR,CAAkB,MAAlB,GAA2B,YAAY;AACrC,MAAI,OAAO,EAAE,OAAO,KAAK,KAAd,EAAqB,SAAS,KAAK,EAAnC,EAAuC,SAAS,KAAK,EAArD,EAAyD,YAAY,KAAK,UAA1E,EAAX;;AAEA;AACA,OAAK,GAAL,GAAW,KAAK,GAAhB;AACA,OAAK,GAAL,GAAW,KAAK,GAAhB;AACA,OAAK,UAAL,GAAkB,KAAK,UAAvB;AACA,OAAK,IAAL,GAAY,KAAK,IAAjB;AACA,OAAK,EAAL,GAAU,KAAK,EAAf;AACA,OAAK,OAAL,GAAe,KAAK,OAApB;AACA,OAAK,kBAAL,GAA0B,KAAK,kBAA/B;;AAEA,MAAI,MAAM,KAAK,GAAL,GAAW,IAAI,cAAJ,CAAmB,IAAnB,CAArB;AACA,MAAI,OAAO,IAAX;;AAEA,MAAI;AACF,UAAM,iBAAN,EAAyB,KAAK,MAA9B,EAAsC,KAAK,GAA3C;AACA,QAAI,IAAJ,CAAS,KAAK,MAAd,EAAsB,KAAK,GAA3B,EAAgC,KAAK,KAArC;AACA,QAAI;AACF,UAAI,KAAK,YAAT,EAAuB;AACrB,YAAI,qBAAJ,CAA0B,IAA1B;AACA,aAAK,IAAI,CAAT,IAAc,KAAK,YAAnB,EAAiC;AAC/B,cAAI,KAAK,YAAL,CAAkB,cAAlB,CAAiC,CAAjC,CAAJ,EAAyC;AACvC,gBAAI,gBAAJ,CAAqB,CAArB,EAAwB,KAAK,YAAL,CAAkB,CAAlB,CAAxB;AACD;AACF;AACF;AACF,KATD,CASE,OAAO,CAAP,EAAU,CAAE;AACd,QAAI,KAAK,cAAT,EAAyB;AACvB;AACA;AACA,UAAI,YAAJ,GAAmB,aAAnB;AACD;;AAED,QAAI,WAAW,KAAK,MAApB,EAA4B;AAC1B,UAAI;AACF,YAAI,KAAK,QAAT,EAAmB;AACjB,cAAI,gBAAJ,CAAqB,cAArB,EAAqC,0BAArC;AACD,SAFD,MAEO;AACL,cAAI,gBAAJ,CAAqB,cAArB,EAAqC,0BAArC;AACD;AACF,OAND,CAME,OAAO,CAAP,EAAU,CAAE;AACf;;AAED,QAAI;AACF,UAAI,gBAAJ,CAAqB,QAArB,EAA+B,KAA/B;AACD,KAFD,CAEE,OAAO,CAAP,EAAU,CAAE;;AAEd;AACA,QAAI,qBAAqB,GAAzB,EAA8B;AAC5B,UAAI,eAAJ,GAAsB,IAAtB;AACD;;AAED,QAAI,KAAK,cAAT,EAAyB;AACvB,UAAI,OAAJ,GAAc,KAAK,cAAnB;AACD;;AAED,QAAI,KAAK,MAAL,EAAJ,EAAmB;AACjB,UAAI,MAAJ,GAAa,YAAY;AACvB,aAAK,MAAL;AACD,OAFD;AAGA,UAAI,OAAJ,GAAc,YAAY;AACxB,aAAK,OAAL,CAAa,IAAI,YAAjB;AACD,OAFD;AAGD,KAPD,MAOO;AACL,UAAI,kBAAJ,GAAyB,YAAY;AACnC,YAAI,MAAM,IAAI,UAAd,EAA0B;AAC1B,YAAI,QAAQ,IAAI,MAAZ,IAAsB,SAAS,IAAI,MAAvC,EAA+C;AAC7C,eAAK,MAAL;AACD,SAFD,MAEO;AACL;AACA;AACA,qBAAW,YAAY;AACrB,iBAAK,OAAL,CAAa,IAAI,MAAjB;AACD,WAFD,EAEG,CAFH;AAGD;AACF,OAXD;AAYD;;AAED,UAAM,aAAN,EAAqB,KAAK,IAA1B;AACA,QAAI,IAAJ,CAAS,KAAK,IAAd;AACD,GAlED,CAkEE,OAAO,CAAP,EAAU;AACV;AACA;AACA;AACA,eAAW,YAAY;AACrB,WAAK,OAAL,CAAa,CAAb;AACD,KAFD,EAEG,CAFH;AAGA;AACD;;AAED,MAAI,OAAO,QAAX,EAAqB;AACnB,SAAK,KAAL,GAAa,QAAQ,aAAR,EAAb;AACA,YAAQ,QAAR,CAAiB,KAAK,KAAtB,IAA+B,IAA/B;AACD;AACF,CA/FD;;AAiGA;;;;;;AAMA,QAAQ,SAAR,CAAkB,SAAlB,GAA8B,YAAY;AACxC,OAAK,IAAL,CAAU,SAAV;AACA,OAAK,OAAL;AACD,CAHD;;AAKA;;;;;;AAMA,QAAQ,SAAR,CAAkB,MAAlB,GAA2B,UAAU,IAAV,EAAgB;AACzC,OAAK,IAAL,CAAU,MAAV,EAAkB,IAAlB;AACA,OAAK,SAAL;AACD,CAHD;;AAKA;;;;;;AAMA,QAAQ,SAAR,CAAkB,OAAlB,GAA4B,UAAU,GAAV,EAAe;AACzC,OAAK,IAAL,CAAU,OAAV,EAAmB,GAAnB;AACA,OAAK,OAAL,CAAa,IAAb;AACD,CAHD;;AAKA;;;;;;AAMA,QAAQ,SAAR,CAAkB,OAAlB,GAA4B,UAAU,SAAV,EAAqB;AAC/C,MAAI,gBAAgB,OAAO,KAAK,GAA5B,IAAmC,SAAS,KAAK,GAArD,EAA0D;AACxD;AACD;AACD;AACA,MAAI,KAAK,MAAL,EAAJ,EAAmB;AACjB,SAAK,GAAL,CAAS,MAAT,GAAkB,KAAK,GAAL,CAAS,OAAT,GAAmB,KAArC;AACD,GAFD,MAEO;AACL,SAAK,GAAL,CAAS,kBAAT,GAA8B,KAA9B;AACD;;AAED,MAAI,SAAJ,EAAe;AACb,QAAI;AACF,WAAK,GAAL,CAAS,KAAT;AACD,KAFD,CAEE,OAAO,CAAP,EAAU,CAAE;AACf;;AAED,MAAI,OAAO,QAAX,EAAqB;AACnB,WAAO,QAAQ,QAAR,CAAiB,KAAK,KAAtB,CAAP;AACD;;AAED,OAAK,GAAL,GAAW,IAAX;AACD,CAtBD;;AAwBA;;;;;;AAMA,QAAQ,SAAR,CAAkB,MAAlB,GAA2B,YAAY;AACrC,MAAI,IAAJ;AACA,MAAI;AACF,QAAI,WAAJ;AACA,QAAI;AACF,oBAAc,KAAK,GAAL,CAAS,iBAAT,CAA2B,cAA3B,EAA2C,KAA3C,CAAiD,GAAjD,EAAsD,CAAtD,CAAd;AACD,KAFD,CAEE,OAAO,CAAP,EAAU,CAAE;AACd,QAAI,gBAAgB,0BAApB,EAAgD;AAC9C,aAAO,KAAK,GAAL,CAAS,QAAT,IAAqB,KAAK,GAAL,CAAS,YAArC;AACD,KAFD,MAEO;AACL,UAAI,CAAC,KAAK,cAAV,EAA0B;AACxB,eAAO,KAAK,GAAL,CAAS,YAAhB;AACD,OAFD,MAEO;AACL,YAAI;AACF,iBAAO,OAAO,YAAP,CAAoB,KAApB,CAA0B,IAA1B,EAAgC,IAAI,UAAJ,CAAe,KAAK,GAAL,CAAS,QAAxB,CAAhC,CAAP;AACD,SAFD,CAEE,OAAO,CAAP,EAAU;AACV,cAAI,SAAS,IAAI,UAAJ,CAAe,KAAK,GAAL,CAAS,QAAxB,CAAb;AACA,cAAI,YAAY,EAAhB;AACA,eAAK,IAAI,MAAM,CAAV,EAAa,SAAS,OAAO,MAAlC,EAA0C,MAAM,MAAhD,EAAwD,KAAxD,EAA+D;AAC7D,sBAAU,IAAV,CAAe,OAAO,GAAP,CAAf;AACD;;AAED,iBAAO,OAAO,YAAP,CAAoB,KAApB,CAA0B,IAA1B,EAAgC,SAAhC,CAAP;AACD;AACF;AACF;AACF,GAxBD,CAwBE,OAAO,CAAP,EAAU;AACV,SAAK,OAAL,CAAa,CAAb;AACD;AACD,MAAI,QAAQ,IAAZ,EAAkB;AAChB,SAAK,MAAL,CAAY,IAAZ;AACD;AACF,CAhCD;;AAkCA;;;;;;AAMA,QAAQ,SAAR,CAAkB,MAAlB,GAA2B,YAAY;AACrC,SAAO,gBAAgB,OAAO,OAAO,cAA9B,IAAgD,CAAC,KAAK,EAAtD,IAA4D,KAAK,UAAxE;AACD,CAFD;;AAIA;;;;;;AAMA,QAAQ,SAAR,CAAkB,KAAlB,GAA0B,YAAY;AACpC,OAAK,OAAL;AACD,CAFD;;AAIA;;;;;;AAMA,QAAQ,aAAR,GAAwB,CAAxB;AACA,QAAQ,QAAR,GAAmB,EAAnB;;AAEA,IAAI,OAAO,QAAX,EAAqB;AACnB,MAAI,OAAO,WAAX,EAAwB;AACtB,WAAO,WAAP,CAAmB,UAAnB,EAA+B,aAA/B;AACD,GAFD,MAEO,IAAI,OAAO,gBAAX,EAA6B;AAClC,WAAO,gBAAP,CAAwB,cAAxB,EAAwC,aAAxC,EAAuD,KAAvD;AACD;AACF;;AAED,SAAS,aAAT,GAA0B;AACxB,OAAK,IAAI,CAAT,IAAc,QAAQ,QAAtB,EAAgC;AAC9B,QAAI,QAAQ,QAAR,CAAiB,cAAjB,CAAgC,CAAhC,CAAJ,EAAwC;AACtC,cAAQ,QAAR,CAAiB,CAAjB,EAAoB,KAApB;AACD;AACF;AACF","file":"polling-xhr-compiled.js","sourcesContent":["/**\n * Module requirements.\n */\n\nvar XMLHttpRequest = require('xmlhttprequest-ssl');\nvar Polling = require('./polling');\nvar Emitter = require('component-emitter');\nvar inherit = require('component-inherit');\nvar debug = require('debug')('engine.io-client:polling-xhr');\n\n/**\n * Module exports.\n */\n\nmodule.exports = XHR;\nmodule.exports.Request = Request;\n\n/**\n * Empty function\n */\n\nfunction empty () {}\n\n/**\n * XHR Polling constructor.\n *\n * @param {Object} opts\n * @api public\n */\n\nfunction XHR (opts) {\n  Polling.call(this, opts);\n  this.requestTimeout = opts.requestTimeout;\n\n  if (global.location) {\n    var isSSL = 'https:' === location.protocol;\n    var port = location.port;\n\n    // some user agents have empty `location.port`\n    if (!port) {\n      port = isSSL ? 443 : 80;\n    }\n\n    this.xd = opts.hostname !== global.location.hostname ||\n      port !== opts.port;\n    this.xs = opts.secure !== isSSL;\n  } else {\n    this.extraHeaders = opts.extraHeaders;\n  }\n}\n\n/**\n * Inherits from Polling.\n */\n\ninherit(XHR, Polling);\n\n/**\n * XHR supports binary\n */\n\nXHR.prototype.supportsBinary = true;\n\n/**\n * Creates a request.\n *\n * @param {String} method\n * @api private\n */\n\nXHR.prototype.request = function (opts) {\n  opts = opts || {};\n  opts.uri = this.uri();\n  opts.xd = this.xd;\n  opts.xs = this.xs;\n  opts.agent = this.agent || false;\n  opts.supportsBinary = this.supportsBinary;\n  opts.enablesXDR = this.enablesXDR;\n\n  // SSL options for Node.js client\n  opts.pfx = this.pfx;\n  opts.key = this.key;\n  opts.passphrase = this.passphrase;\n  opts.cert = this.cert;\n  opts.ca = this.ca;\n  opts.ciphers = this.ciphers;\n  opts.rejectUnauthorized = this.rejectUnauthorized;\n  opts.requestTimeout = this.requestTimeout;\n\n  // other options for Node.js client\n  opts.extraHeaders = this.extraHeaders;\n\n  return new Request(opts);\n};\n\n/**\n * Sends data.\n *\n * @param {String} data to send.\n * @param {Function} called upon flush.\n * @api private\n */\n\nXHR.prototype.doWrite = function (data, fn) {\n  var isBinary = typeof data !== 'string' && data !== undefined;\n  var req = this.request({ method: 'POST', data: data, isBinary: isBinary });\n  var self = this;\n  req.on('success', fn);\n  req.on('error', function (err) {\n    self.onError('xhr post error', err);\n  });\n  this.sendXhr = req;\n};\n\n/**\n * Starts a poll cycle.\n *\n * @api private\n */\n\nXHR.prototype.doPoll = function () {\n  debug('xhr poll');\n  var req = this.request();\n  var self = this;\n  req.on('data', function (data) {\n    self.onData(data);\n  });\n  req.on('error', function (err) {\n    self.onError('xhr poll error', err);\n  });\n  this.pollXhr = req;\n};\n\n/**\n * Request constructor\n *\n * @param {Object} options\n * @api public\n */\n\nfunction Request (opts) {\n  this.method = opts.method || 'GET';\n  this.uri = opts.uri;\n  this.xd = !!opts.xd;\n  this.xs = !!opts.xs;\n  this.async = false !== opts.async;\n  this.data = undefined !== opts.data ? opts.data : null;\n  this.agent = opts.agent;\n  this.isBinary = opts.isBinary;\n  this.supportsBinary = opts.supportsBinary;\n  this.enablesXDR = opts.enablesXDR;\n  this.requestTimeout = opts.requestTimeout;\n\n  // SSL options for Node.js client\n  this.pfx = opts.pfx;\n  this.key = opts.key;\n  this.passphrase = opts.passphrase;\n  this.cert = opts.cert;\n  this.ca = opts.ca;\n  this.ciphers = opts.ciphers;\n  this.rejectUnauthorized = opts.rejectUnauthorized;\n\n  // other options for Node.js client\n  this.extraHeaders = opts.extraHeaders;\n\n  this.create();\n}\n\n/**\n * Mix in `Emitter`.\n */\n\nEmitter(Request.prototype);\n\n/**\n * Creates the XHR object and sends the request.\n *\n * @api private\n */\n\nRequest.prototype.create = function () {\n  var opts = { agent: this.agent, xdomain: this.xd, xscheme: this.xs, enablesXDR: this.enablesXDR };\n\n  // SSL options for Node.js client\n  opts.pfx = this.pfx;\n  opts.key = this.key;\n  opts.passphrase = this.passphrase;\n  opts.cert = this.cert;\n  opts.ca = this.ca;\n  opts.ciphers = this.ciphers;\n  opts.rejectUnauthorized = this.rejectUnauthorized;\n\n  var xhr = this.xhr = new XMLHttpRequest(opts);\n  var self = this;\n\n  try {\n    debug('xhr open %s: %s', this.method, this.uri);\n    xhr.open(this.method, this.uri, this.async);\n    try {\n      if (this.extraHeaders) {\n        xhr.setDisableHeaderCheck(true);\n        for (var i in this.extraHeaders) {\n          if (this.extraHeaders.hasOwnProperty(i)) {\n            xhr.setRequestHeader(i, this.extraHeaders[i]);\n          }\n        }\n      }\n    } catch (e) {}\n    if (this.supportsBinary) {\n      // This has to be done after open because Firefox is stupid\n      // http://stackoverflow.com/questions/13216903/get-binary-data-with-xmlhttprequest-in-a-firefox-extension\n      xhr.responseType = 'arraybuffer';\n    }\n\n    if ('POST' === this.method) {\n      try {\n        if (this.isBinary) {\n          xhr.setRequestHeader('Content-type', 'application/octet-stream');\n        } else {\n          xhr.setRequestHeader('Content-type', 'text/plain;charset=UTF-8');\n        }\n      } catch (e) {}\n    }\n\n    try {\n      xhr.setRequestHeader('Accept', '*/*');\n    } catch (e) {}\n\n    // ie6 check\n    if ('withCredentials' in xhr) {\n      xhr.withCredentials = true;\n    }\n\n    if (this.requestTimeout) {\n      xhr.timeout = this.requestTimeout;\n    }\n\n    if (this.hasXDR()) {\n      xhr.onload = function () {\n        self.onLoad();\n      };\n      xhr.onerror = function () {\n        self.onError(xhr.responseText);\n      };\n    } else {\n      xhr.onreadystatechange = function () {\n        if (4 !== xhr.readyState) return;\n        if (200 === xhr.status || 1223 === xhr.status) {\n          self.onLoad();\n        } else {\n          // make sure the `error` event handler that's user-set\n          // does not throw in the same tick and gets caught here\n          setTimeout(function () {\n            self.onError(xhr.status);\n          }, 0);\n        }\n      };\n    }\n\n    debug('xhr data %s', this.data);\n    xhr.send(this.data);\n  } catch (e) {\n    // Need to defer since .create() is called directly fhrom the constructor\n    // and thus the 'error' event can only be only bound *after* this exception\n    // occurs.  Therefore, also, we cannot throw here at all.\n    setTimeout(function () {\n      self.onError(e);\n    }, 0);\n    return;\n  }\n\n  if (global.document) {\n    this.index = Request.requestsCount++;\n    Request.requests[this.index] = this;\n  }\n};\n\n/**\n * Called upon successful response.\n *\n * @api private\n */\n\nRequest.prototype.onSuccess = function () {\n  this.emit('success');\n  this.cleanup();\n};\n\n/**\n * Called if we have data.\n *\n * @api private\n */\n\nRequest.prototype.onData = function (data) {\n  this.emit('data', data);\n  this.onSuccess();\n};\n\n/**\n * Called upon error.\n *\n * @api private\n */\n\nRequest.prototype.onError = function (err) {\n  this.emit('error', err);\n  this.cleanup(true);\n};\n\n/**\n * Cleans up house.\n *\n * @api private\n */\n\nRequest.prototype.cleanup = function (fromError) {\n  if ('undefined' === typeof this.xhr || null === this.xhr) {\n    return;\n  }\n  // xmlhttprequest\n  if (this.hasXDR()) {\n    this.xhr.onload = this.xhr.onerror = empty;\n  } else {\n    this.xhr.onreadystatechange = empty;\n  }\n\n  if (fromError) {\n    try {\n      this.xhr.abort();\n    } catch (e) {}\n  }\n\n  if (global.document) {\n    delete Request.requests[this.index];\n  }\n\n  this.xhr = null;\n};\n\n/**\n * Called upon load.\n *\n * @api private\n */\n\nRequest.prototype.onLoad = function () {\n  var data;\n  try {\n    var contentType;\n    try {\n      contentType = this.xhr.getResponseHeader('Content-Type').split(';')[0];\n    } catch (e) {}\n    if (contentType === 'application/octet-stream') {\n      data = this.xhr.response || this.xhr.responseText;\n    } else {\n      if (!this.supportsBinary) {\n        data = this.xhr.responseText;\n      } else {\n        try {\n          data = String.fromCharCode.apply(null, new Uint8Array(this.xhr.response));\n        } catch (e) {\n          var ui8Arr = new Uint8Array(this.xhr.response);\n          var dataArray = [];\n          for (var idx = 0, length = ui8Arr.length; idx < length; idx++) {\n            dataArray.push(ui8Arr[idx]);\n          }\n\n          data = String.fromCharCode.apply(null, dataArray);\n        }\n      }\n    }\n  } catch (e) {\n    this.onError(e);\n  }\n  if (null != data) {\n    this.onData(data);\n  }\n};\n\n/**\n * Check if it has XDomainRequest.\n *\n * @api private\n */\n\nRequest.prototype.hasXDR = function () {\n  return 'undefined' !== typeof global.XDomainRequest && !this.xs && this.enablesXDR;\n};\n\n/**\n * Aborts the request.\n *\n * @api public\n */\n\nRequest.prototype.abort = function () {\n  this.cleanup();\n};\n\n/**\n * Aborts pending requests when unloading the window. This is needed to prevent\n * memory leaks (e.g. when using IE) and to ensure that no spurious error is\n * emitted.\n */\n\nRequest.requestsCount = 0;\nRequest.requests = {};\n\nif (global.document) {\n  if (global.attachEvent) {\n    global.attachEvent('onunload', unloadHandler);\n  } else if (global.addEventListener) {\n    global.addEventListener('beforeunload', unloadHandler, false);\n  }\n}\n\nfunction unloadHandler () {\n  for (var i in Request.requests) {\n    if (Request.requests.hasOwnProperty(i)) {\n      Request.requests[i].abort();\n    }\n  }\n}\n"]}