{"version":3,"sources":["cursor.js"],"names":[],"mappings":"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","file":"cursor-compiled.js","sourcesContent":["\"use strict\";\n\nvar Logger = require('./connection/logger')\n  , retrieveBSON = require('./connection/utils').retrieveBSON\n  , MongoError = require('./error')\n  , f = require('util').format;\n\nvar BSON = retrieveBSON(),\n  Long = BSON.Long;\n\n/**\n * This is a cursor results callback\n *\n * @callback resultCallback\n * @param {error} error An error object. Set to null if no error present\n * @param {object} document\n */\n\n/**\n * @fileOverview The **Cursor** class is an internal class that embodies a cursor on MongoDB\n * allowing for iteration over the results returned from the underlying query.\n *\n * **CURSORS Cannot directly be instantiated**\n * @example\n * var Server = require('mongodb-core').Server\n *   , ReadPreference = require('mongodb-core').ReadPreference\n *   , assert = require('assert');\n *\n * var server = new Server({host: 'localhost', port: 27017});\n * // Wait for the connection event\n * server.on('connect', function(server) {\n *   assert.equal(null, err);\n *\n *   // Execute the write\n *   var cursor = _server.cursor('integration_tests.inserts_example4', {\n *       find: 'integration_tests.example4'\n *     , query: {a:1}\n *   }, {\n *     readPreference: new ReadPreference('secondary');\n *   });\n *\n *   // Get the first document\n *   cursor.next(function(err, doc) {\n *     assert.equal(null, err);\n *     server.destroy();\n *   });\n * });\n *\n * // Start connecting\n * server.connect();\n */\n\n/**\n * Creates a new Cursor, not to be used directly\n * @class\n * @param {object} bson An instance of the BSON parser\n * @param {string} ns The MongoDB fully qualified namespace (ex: db1.collection1)\n * @param {{object}|Long} cmd The selector (can be a command or a cursorId)\n * @param {object} [options=null] Optional settings.\n * @param {object} [options.batchSize=1000] Batchsize for the operation\n * @param {array} [options.documents=[]] Initial documents list for cursor\n * @param {object} [options.transforms=null] Transform methods for the cursor results\n * @param {function} [options.transforms.query] Transform the value returned from the initial query\n * @param {function} [options.transforms.doc] Transform each document returned from Cursor.prototype.next\n * @param {object} topology The server topology instance.\n * @param {object} topologyOptions The server topology options.\n * @return {Cursor} A cursor instance\n * @property {number} cursorBatchSize The current cursorBatchSize for the cursor\n * @property {number} cursorLimit The current cursorLimit for the cursor\n * @property {number} cursorSkip The current cursorSkip for the cursor\n */\nvar Cursor = function(bson, ns, cmd, options, topology, topologyOptions) {\n  options = options || {};\n\n  // Cursor pool\n  this.pool = null;\n  // Cursor server\n  this.server = null;\n\n  // Do we have a not connected handler\n  this.disconnectHandler = options.disconnectHandler;\n\n  // Set local values\n  this.bson = bson;\n  this.ns = ns;\n  this.cmd = cmd;\n  this.options = options;\n  this.topology = topology;\n\n  // All internal state\n  this.cursorState = {\n      cursorId: null\n    , cmd: cmd\n    , documents: options.documents || []\n    , cursorIndex: 0\n    , dead: false\n    , killed: false\n    , init: false\n    , notified: false\n    , limit: options.limit || cmd.limit || 0\n    , skip: options.skip || cmd.skip || 0\n    , batchSize: options.batchSize || cmd.batchSize || 1000\n    , currentLimit: 0\n    // Result field name if not a cursor (contains the array of results)\n    , transforms: options.transforms\n  }\n\n  // Add promoteLong to cursor state\n  if(typeof topologyOptions.promoteLongs == 'boolean') {\n    this.cursorState.promoteLongs = topologyOptions.promoteLongs;\n  } else if(typeof options.promoteLongs == 'boolean') {\n    this.cursorState.promoteLongs = options.promoteLongs;\n  }\n\n  // Add promoteValues to cursor state\n  if(typeof topologyOptions.promoteValues == 'boolean') {\n    this.cursorState.promoteValues = topologyOptions.promoteValues;\n  } else if(typeof options.promoteValues == 'boolean') {\n    this.cursorState.promoteValues = options.promoteValues;\n  }\n\n  // Add promoteBuffers to cursor state\n  if(typeof topologyOptions.promoteBuffers == 'boolean') {\n    this.cursorState.promoteBuffers = topologyOptions.promoteBuffers;\n  } else if(typeof options.promoteBuffers == 'boolean') {\n    this.cursorState.promoteBuffers = options.promoteBuffers;\n  }\n\n  // Logger\n  this.logger = Logger('Cursor', topologyOptions);\n\n  //\n  // Did we pass in a cursor id\n  if(typeof cmd == 'number') {\n    this.cursorState.cursorId = Long.fromNumber(cmd);\n    this.cursorState.lastCursorId = this.cursorState.cursorId;\n  } else if(cmd instanceof Long) {\n    this.cursorState.cursorId = cmd;\n    this.cursorState.lastCursorId = cmd;\n  }\n}\n\nCursor.prototype.setCursorBatchSize = function(value) {\n  this.cursorState.batchSize = value;\n}\n\nCursor.prototype.cursorBatchSize = function() {\n  return this.cursorState.batchSize;\n}\n\nCursor.prototype.setCursorLimit = function(value) {\n  this.cursorState.limit = value;\n}\n\nCursor.prototype.cursorLimit = function() {\n  return this.cursorState.limit;\n}\n\nCursor.prototype.setCursorSkip = function(value) {\n  this.cursorState.skip = value;\n}\n\nCursor.prototype.cursorSkip = function() {\n  return this.cursorState.skip;\n}\n\n//\n// Handle callback (including any exceptions thrown)\nvar handleCallback = function(callback, err, result) {\n  try {\n    callback(err, result);\n  } catch(err) {\n    process.nextTick(function() {\n      throw err;\n    });\n  }\n}\n\n// Internal methods\nCursor.prototype._find = function(callback) {\n  var self = this;\n\n  if(self.logger.isDebug()) {\n    self.logger.debug(f('issue initial query [%s] with flags [%s]'\n      , JSON.stringify(self.cmd)\n      , JSON.stringify(self.query)));\n  }\n\n  var queryCallback = function(err, r) {\n    if(err) return callback(err);\n\n    // Get the raw message\n    var result = r.message;\n\n    // Query failure bit set\n    if(result.queryFailure) {\n      return callback(MongoError.create(result.documents[0]), null);\n    }\n\n    // Check if we have a command cursor\n    if(Array.isArray(result.documents) && result.documents.length == 1\n      && (!self.cmd.find || (self.cmd.find && self.cmd.virtual == false))\n      && (result.documents[0].cursor != 'string'\n        || result.documents[0]['$err']\n        || result.documents[0]['errmsg']\n        || Array.isArray(result.documents[0].result))\n      ) {\n\n      // We have a an error document return the error\n      if(result.documents[0]['$err']\n        || result.documents[0]['errmsg']) {\n        return callback(MongoError.create(result.documents[0]), null);\n      }\n\n      // We have a cursor document\n      if(result.documents[0].cursor != null\n        && typeof result.documents[0].cursor != 'string') {\n          var id = result.documents[0].cursor.id;\n          // If we have a namespace change set the new namespace for getmores\n          if(result.documents[0].cursor.ns) {\n            self.ns = result.documents[0].cursor.ns;\n          }\n          // Promote id to long if needed\n          self.cursorState.cursorId = typeof id == 'number' ? Long.fromNumber(id) : id;\n          self.cursorState.lastCursorId = self.cursorState.cursorId;\n          // If we have a firstBatch set it\n          if(Array.isArray(result.documents[0].cursor.firstBatch)) {\n            self.cursorState.documents = result.documents[0].cursor.firstBatch;//.reverse();\n          }\n\n          // Return after processing command cursor\n          return callback(null, null);\n      }\n\n      if(Array.isArray(result.documents[0].result)) {\n        self.cursorState.documents = result.documents[0].result;\n        self.cursorState.cursorId = Long.ZERO;\n        return callback(null, null);\n      }\n    }\n\n    // Otherwise fall back to regular find path\n    self.cursorState.cursorId = result.cursorId;\n    self.cursorState.documents = result.documents;\n    self.cursorState.lastCursorId = result.cursorId;\n\n    // Transform the results with passed in transformation method if provided\n    if(self.cursorState.transforms && typeof self.cursorState.transforms.query == 'function') {\n      self.cursorState.documents = self.cursorState.transforms.query(result);\n    }\n\n    // Return callback\n    callback(null, null);\n  }\n\n  // Options passed to the pool\n  var queryOptions = {};\n\n  // If we have a raw query decorate the function\n  if(self.options.raw || self.cmd.raw) {\n    // queryCallback.raw = self.options.raw || self.cmd.raw;\n    queryOptions.raw = self.options.raw || self.cmd.raw;\n  }\n\n  // Do we have documentsReturnedIn set on the query\n  if(typeof self.query.documentsReturnedIn == 'string') {\n    // queryCallback.documentsReturnedIn = self.query.documentsReturnedIn;\n    queryOptions.documentsReturnedIn = self.query.documentsReturnedIn;\n  }\n\n  // Add promote Long value if defined\n  if(typeof self.cursorState.promoteLongs == 'boolean') {\n    queryOptions.promoteLongs = self.cursorState.promoteLongs;\n  }\n\n  // Add promote values if defined\n  if(typeof self.cursorState.promoteValues == 'boolean') {\n    queryOptions.promoteValues = self.cursorState.promoteValues;\n  }\n\n  // Add promote values if defined\n  if(typeof self.cursorState.promoteBuffers == 'boolean') {\n    queryOptions.promoteBuffers = self.cursorState.promoteBuffers;\n  }\n  // Write the initial command out\n  self.server.s.pool.write(self.query, queryOptions, queryCallback);\n}\n\nCursor.prototype._getmore = function(callback) {\n  if(this.logger.isDebug()) this.logger.debug(f('schedule getMore call for query [%s]', JSON.stringify(this.query)))\n  // Determine if it's a raw query\n  var raw = this.options.raw || this.cmd.raw;\n\n  // Set the current batchSize\n  var batchSize = this.cursorState.batchSize;\n  if(this.cursorState.limit > 0\n    && ((this.cursorState.currentLimit + batchSize) > this.cursorState.limit)) {\n    batchSize = this.cursorState.limit - this.cursorState.currentLimit;\n  }\n\n  // Default pool\n  var pool = this.server.s.pool;\n\n  // We have a wire protocol handler\n  this.server.wireProtocolHandler.getMore(this.bson, this.ns, this.cursorState, batchSize, raw, pool, this.options, callback);\n}\n\nCursor.prototype._killcursor = function(callback) {\n  // Set cursor to dead\n  this.cursorState.dead = true;\n  this.cursorState.killed = true;\n  // Remove documents\n  this.cursorState.documents = [];\n\n  // If no cursor id just return\n  if(this.cursorState.cursorId == null || this.cursorState.cursorId.isZero() || this.cursorState.init == false) {\n    if(callback) callback(null, null);\n    return;\n  }\n\n  // Default pool\n  var pool = this.server.s.pool;\n  // Execute command\n  this.server.wireProtocolHandler.killCursor(this.bson, this.ns, this.cursorState.cursorId, pool, callback);\n}\n\n/**\n * Clone the cursor\n * @method\n * @return {Cursor}\n */\nCursor.prototype.clone = function() {\n  return this.topology.cursor(this.ns, this.cmd, this.options);\n}\n\n/**\n * Checks if the cursor is dead\n * @method\n * @return {boolean} A boolean signifying if the cursor is dead or not\n */\nCursor.prototype.isDead = function() {\n  return this.cursorState.dead == true;\n}\n\n/**\n * Checks if the cursor was killed by the application\n * @method\n * @return {boolean} A boolean signifying if the cursor was killed by the application\n */\nCursor.prototype.isKilled = function() {\n  return this.cursorState.killed == true;\n}\n\n/**\n * Checks if the cursor notified it's caller about it's death\n * @method\n * @return {boolean} A boolean signifying if the cursor notified the callback\n */\nCursor.prototype.isNotified = function() {\n  return this.cursorState.notified == true;\n}\n\n/**\n * Returns current buffered documents length\n * @method\n * @return {number} The number of items in the buffered documents\n */\nCursor.prototype.bufferedCount = function() {\n  return this.cursorState.documents.length - this.cursorState.cursorIndex;\n}\n\n/**\n * Returns current buffered documents\n * @method\n * @return {Array} An array of buffered documents\n */\nCursor.prototype.readBufferedDocuments = function(number) {\n  var unreadDocumentsLength = this.cursorState.documents.length - this.cursorState.cursorIndex;\n  var length = number < unreadDocumentsLength ? number : unreadDocumentsLength;\n  var elements = this.cursorState.documents.slice(this.cursorState.cursorIndex, this.cursorState.cursorIndex + length);\n\n  // Transform the doc with passed in transformation method if provided\n  if(this.cursorState.transforms && typeof this.cursorState.transforms.doc == 'function') {\n    // Transform all the elements\n    for(var i = 0; i < elements.length; i++) {\n      elements[i] = this.cursorState.transforms.doc(elements[i]);\n    }\n  }\n\n  // Ensure we do not return any more documents than the limit imposed\n  // Just return the number of elements up to the limit\n  if(this.cursorState.limit > 0 && (this.cursorState.currentLimit + elements.length) > this.cursorState.limit) {\n    elements = elements.slice(0, (this.cursorState.limit - this.cursorState.currentLimit));\n    this.kill();\n  }\n\n  // Adjust current limit\n  this.cursorState.currentLimit = this.cursorState.currentLimit + elements.length;\n  this.cursorState.cursorIndex = this.cursorState.cursorIndex + elements.length;\n\n  // Return elements\n  return elements;\n}\n\n/**\n * Kill the cursor\n * @method\n * @param {resultCallback} callback A callback function\n */\nCursor.prototype.kill = function(callback) {\n  this._killcursor(callback);\n}\n\n/**\n * Resets the cursor\n * @method\n * @return {null}\n */\nCursor.prototype.rewind = function() {\n  if(this.cursorState.init) {\n    if(!this.cursorState.dead) {\n      this.kill();\n    }\n\n    this.cursorState.currentLimit = 0;\n    this.cursorState.init = false;\n    this.cursorState.dead = false;\n    this.cursorState.killed = false;\n    this.cursorState.notified = false;\n    this.cursorState.documents = [];\n    this.cursorState.cursorId = null;\n    this.cursorState.cursorIndex = 0;\n  }\n}\n\n/**\n * Validate if the pool is dead and return error\n */\nvar isConnectionDead = function(self, callback) {\n  if(self.pool\n    && self.pool.isDestroyed()) {\n    self.cursorState.notified = true;\n    self.cursorState.killed = true;\n    self.cursorState.documents = [];\n    self.cursorState.cursorIndex = 0;\n    callback(MongoError.create(f('connection to host %s:%s was destroyed', self.pool.host, self.pool.port)))\n    return true;\n  }\n\n  return false;\n}\n\n/**\n * Validate if the cursor is dead but was not explicitly killed by user\n */\nvar isCursorDeadButNotkilled = function(self, callback) {\n  // Cursor is dead but not marked killed, return null\n  if(self.cursorState.dead && !self.cursorState.killed) {\n    self.cursorState.notified = true;\n    self.cursorState.killed = true;\n    self.cursorState.documents = [];\n    self.cursorState.cursorIndex = 0;\n    handleCallback(callback, null, null);\n    return true;\n  }\n\n  return false;\n}\n\n/**\n * Validate if the cursor is dead and was killed by user\n */\nvar isCursorDeadAndKilled = function(self, callback) {\n  if(self.cursorState.dead && self.cursorState.killed) {\n    handleCallback(callback, MongoError.create('cursor is dead'));\n    return true;\n  }\n\n  return false;\n}\n\n/**\n * Validate if the cursor was killed by the user\n */\nvar isCursorKilled = function(self, callback) {\n  if(self.cursorState.killed) {\n    self.cursorState.notified = true;\n    self.cursorState.documents = [];\n    self.cursorState.cursorIndex = 0;\n    handleCallback(callback, null, null);\n    return true;\n  }\n\n  return false;\n}\n\n/**\n * Mark cursor as being dead and notified\n */\nvar setCursorDeadAndNotified = function(self, callback) {\n  self.cursorState.dead = true;\n  self.cursorState.notified = true;\n  self.cursorState.documents = [];\n  self.cursorState.cursorIndex = 0;\n  handleCallback(callback, null, null);\n}\n\n/**\n * Mark cursor as being notified\n */\nvar setCursorNotified = function(self, callback) {\n  self.cursorState.notified = true;\n  self.cursorState.documents = [];\n  self.cursorState.cursorIndex = 0;\n  handleCallback(callback, null, null);\n}\n\nvar nextFunction = function(self, callback) {\n  // We have notified about it\n  if(self.cursorState.notified) {\n    return callback(new Error('cursor is exhausted'));\n  }\n\n  // Cursor is killed return null\n  if(isCursorKilled(self, callback)) return;\n\n  // Cursor is dead but not marked killed, return null\n  if(isCursorDeadButNotkilled(self, callback)) return;\n\n  // We have a dead and killed cursor, attempting to call next should error\n  if(isCursorDeadAndKilled(self, callback)) return;\n\n  // We have just started the cursor\n  if(!self.cursorState.init) {\n    // Topology is not connected, save the call in the provided store to be\n    // Executed at some point when the handler deems it's reconnected\n    if(!self.topology.isConnected(self.options) && self.disconnectHandler != null) {\n      if (self.topology.isDestroyed()) {\n        // Topology was destroyed, so don't try to wait for it to reconnect\n        return callback(new MongoError('Topology was destroyed'));\n      }\n      return self.disconnectHandler.addObjectAndMethod('cursor', self, 'next', [callback], callback);\n    }\n\n    try {\n      self.server = self.topology.getServer(self.options);\n    } catch(err) {\n      // Handle the error and add object to next method call\n      if(self.disconnectHandler != null) {\n        return self.disconnectHandler.addObjectAndMethod('cursor', self, 'next', [callback], callback);\n      }\n\n      // Otherwise return the error\n      return callback(err);\n    }\n\n    // Set as init\n    self.cursorState.init = true;\n\n    // Server does not support server\n    if(self.cmd\n      && self.cmd.collation\n      && self.server.ismaster.maxWireVersion < 5) {\n      return callback(new MongoError(f('server %s does not support collation', self.server.name)));\n    }\n\n    try {\n      self.query = self.server.wireProtocolHandler.command(self.bson, self.ns, self.cmd, self.cursorState, self.topology, self.options);\n    } catch(err) {\n      return callback(err);\n    }\n  }\n\n  // If we don't have a cursorId execute the first query\n  if(self.cursorState.cursorId == null) {\n    // Check if pool is dead and return if not possible to\n    // execute the query against the db\n    if(isConnectionDead(self, callback)) return;\n\n    // Check if topology is destroyed\n    if(self.topology.isDestroyed()) return callback(new MongoError('connection destroyed, not possible to instantiate cursor'));\n\n    // query, cmd, options, cursorState, callback\n    self._find(function(err) {\n      if(err) return handleCallback(callback, err, null);\n\n      if(self.cursorState.documents.length == 0\n        && self.cursorState.cursorId && self.cursorState.cursorId.isZero()\n        && !self.cmd.tailable && !self.cmd.awaitData) {\n        return setCursorNotified(self, callback);\n      }\n\n      nextFunction(self, callback);\n    });\n  } else if(self.cursorState.limit > 0 && self.cursorState.currentLimit >= self.cursorState.limit) {\n    // Ensure we kill the cursor on the server\n    self.kill();\n    // Set cursor in dead and notified state\n    return setCursorDeadAndNotified(self, callback);\n  } else if(self.cursorState.cursorIndex == self.cursorState.documents.length\n      && !Long.ZERO.equals(self.cursorState.cursorId)) {\n      // Ensure an empty cursor state\n      self.cursorState.documents = [];\n      self.cursorState.cursorIndex = 0;\n\n      // Check if topology is destroyed\n      if(self.topology.isDestroyed()) return callback(new MongoError('connection destroyed, not possible to instantiate cursor'));\n\n      // Check if connection is dead and return if not possible to\n      // execute a getmore on this connection\n      if(isConnectionDead(self, callback)) return;\n\n      // Execute the next get more\n      self._getmore(function(err, doc, connection) {\n        if(err) return handleCallback(callback, err);\n\n        // Save the returned connection to ensure all getMore's fire over the same connection\n        self.connection = connection;\n\n        // Tailable cursor getMore result, notify owner about it\n        // No attempt is made here to retry, this is left to the user of the\n        // core module to handle to keep core simple\n        if(self.cursorState.documents.length == 0\n          && self.cmd.tailable && Long.ZERO.equals(self.cursorState.cursorId)) {\n          // No more documents in the tailed cursor\n          return handleCallback(callback, MongoError.create({\n              message: 'No more documents in tailed cursor'\n            , tailable: self.cmd.tailable\n            , awaitData: self.cmd.awaitData\n          }));\n        } else if(self.cursorState.documents.length == 0\n          && self.cmd.tailable && !Long.ZERO.equals(self.cursorState.cursorId)) {\n          return nextFunction(self, callback);\n        }\n\n        if(self.cursorState.limit > 0 && self.cursorState.currentLimit >= self.cursorState.limit) {\n          return setCursorDeadAndNotified(self, callback);\n        }\n\n        nextFunction(self, callback);\n      });\n  } else if(self.cursorState.documents.length == self.cursorState.cursorIndex\n    && self.cmd.tailable && Long.ZERO.equals(self.cursorState.cursorId)) {\n      return handleCallback(callback, MongoError.create({\n          message: 'No more documents in tailed cursor'\n        , tailable: self.cmd.tailable\n        , awaitData: self.cmd.awaitData\n      }));\n  } else if(self.cursorState.documents.length == self.cursorState.cursorIndex\n      && Long.ZERO.equals(self.cursorState.cursorId)) {\n      setCursorDeadAndNotified(self, callback);\n  } else {\n    if(self.cursorState.limit > 0 && self.cursorState.currentLimit >= self.cursorState.limit) {\n      // Ensure we kill the cursor on the server\n      self.kill();\n      // Set cursor in dead and notified state\n      return setCursorDeadAndNotified(self, callback);\n    }\n\n    // Increment the current cursor limit\n    self.cursorState.currentLimit += 1;\n\n    // Get the document\n    var doc = self.cursorState.documents[self.cursorState.cursorIndex++];\n\n    // Doc overflow\n    if(!doc || doc.$err) {\n      // Ensure we kill the cursor on the server\n      self.kill();\n      // Set cursor in dead and notified state\n      return setCursorDeadAndNotified(self, function() {\n        handleCallback(callback, new MongoError(doc ? doc.$err : undefined));\n      });\n    }\n\n    // Transform the doc with passed in transformation method if provided\n    if(self.cursorState.transforms && typeof self.cursorState.transforms.doc == 'function') {\n      doc = self.cursorState.transforms.doc(doc);\n    }\n\n    // Return the document\n    handleCallback(callback, null, doc);\n  }\n}\n\n/**\n * Retrieve the next document from the cursor\n * @method\n * @param {resultCallback} callback A callback function\n */\nCursor.prototype.next = function(callback) {\n  nextFunction(this, callback);\n}\n\nmodule.exports = Cursor;\n"]}