{"version":3,"sources":["install.js"],"names":[],"mappings":"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","file":"install-compiled.js","sourcesContent":["'use strict';\n\nvar AdmZip = require('adm-zip');\nvar fs = require('fs');\nvar helper = require('./lib/chromedriver');\nvar http = require('http');\nvar https = require('https');\nvar kew = require('kew');\nvar mkdirp = require('mkdirp');\nvar path = require('path');\nvar rimraf = require('rimraf').sync;\nvar url = require('url');\nvar util = require('util');\n\nvar libPath = path.join(__dirname, 'lib', 'chromedriver');\nvar cdnUrl = process.env.npm_config_chromedriver_cdnurl || process.env.CHROMEDRIVER_CDNURL || 'https://chromedriver.storage.googleapis.com';\nvar configuredfilePath = process.env.npm_config_chromedriver_filepath || process.env.CHROMEDRIVER_FILEPATH;\n\n// adapt http://chromedriver.storage.googleapis.com/\ncdnUrl = cdnUrl.replace(/\\/+$/, '');\nvar downloadUrl = cdnUrl + '/%s/chromedriver_%s.zip';\nvar platform = process.platform;\n\nvar chromedriver_version = process.env.npm_config_chromedriver_version || process.env.CHROMEDRIVER_VERSION || helper.version;\nif (platform === 'linux') {\n  if (process.arch === 'x64') {\n    platform += '64';\n  } else {\n    platform += '32';\n  }\n} else if (platform === 'darwin') {\n  if (process.arch === 'x64') {\n    platform = 'mac64';\n  } else {\n    console.log('Only Mac 64 bits supported.');\n    process.exit(1);\n  }\n} else if (platform === 'freebsd') {\n  if (process.arch === 'x64') {\n    platform = 'mac64';\n  } else {\n    platform = 'mac32';\n  }\n} else if (platform !== 'win32') {\n  console.log('Unexpected platform or architecture:', process.platform, process.arch);\n  process.exit(1);\n}\n\nvar tmpPath = findSuitableTempDirectory();\nvar downloadedFile = '';\nvar promise = kew.resolve(true);\n\npromise = promise.then(function () {\n  if (chromedriver_version === 'LATEST')\n    return getLatestVersion(getRequestOptions(cdnUrl + '/LATEST_RELEASE'));\n});\n\n// Start the install.\npromise = promise.then(function () {\n  if (configuredfilePath) {\n    console.log('Using file: ', configuredfilePath);\n    downloadedFile = configuredfilePath;\n  } else {\n    downloadUrl = util.format(downloadUrl, chromedriver_version, platform);\n    var fileName = downloadUrl.split('/').pop();\n    downloadedFile = path.join(tmpPath, fileName);\n    console.log('Downloading', downloadUrl);\n    console.log('Saving to', downloadedFile);\n    return requestBinary(getRequestOptions(downloadUrl), downloadedFile);\n  }\n});\n\npromise.then(function () {\n  return extractDownload(downloadedFile, tmpPath);\n})\n  .then(function () {\n    return copyIntoPlace(tmpPath, libPath);\n  })\n  .then(function () {\n    return fixFilePermissions();\n  })\n  .then(function () {\n    console.log('Done. ChromeDriver binary available at', helper.path);\n  })\n  .fail(function (err) {\n    console.error('ChromeDriver installation failed', err);\n    process.exit(1);\n  });\n\n\nfunction findSuitableTempDirectory() {\n  var now = Date.now();\n  var candidateTmpDirs = [\n    process.env.TMPDIR || process.env.TMP || process.env.npm_config_tmp,\n    '/tmp',\n    path.join(process.cwd(), 'tmp')\n  ];\n\n  for (var i = 0; i < candidateTmpDirs.length; i++) {\n    if (!candidateTmpDirs[i]) continue;\n    var candidatePath = path.join(candidateTmpDirs[i], 'chromedriver');\n    try {\n      mkdirp.sync(candidatePath, '0777');\n      var testFile = path.join(candidatePath, now + '.tmp');\n      fs.writeFileSync(testFile, 'test');\n      fs.unlinkSync(testFile);\n      return candidatePath;\n    } catch (e) {\n      console.log(candidatePath, 'is not writable:', e.message);\n    }\n  }\n\n  console.error('Can not find a writable tmp directory, please report issue on https://github.com/giggio/chromedriver/issues/ with as much information as possible.');\n  process.exit(1);\n}\n\n\nfunction getRequestOptions(downloadPath) {\n  var options = url.parse(downloadUrl);\n  var proxyUrl = options.protocol === 'https:'\n    ? process.env.npm_config_https_proxy\n    : (process.env.npm_config_proxy || process.env.npm_config_http_proxy);\n  if (proxyUrl) {\n    options = url.parse(proxyUrl);\n    options.path = downloadPath;\n    options.headers = { Host: url.parse(downloadPath).host };\n    // Turn basic authorization into proxy-authorization.\n    if (options.auth) {\n      options.headers['Proxy-Authorization'] = 'Basic ' + new Buffer(options.auth).toString('base64');\n      delete options.auth;\n    }\n  } else {\n    options = url.parse(downloadPath);\n  }\n\n  options.rejectUnauthorized = !!process.env.npm_config_strict_ssl;\n\n  // Use certificate authority settings from npm\n  var ca = process.env.npm_config_ca;\n  if (!ca && process.env.npm_config_cafile) {\n    try {\n      ca = fs.readFileSync(process.env.npm_config_cafile, { encoding: 'utf8' })\n        .split(/\\n(?=-----BEGIN CERTIFICATE-----)/g);\n\n      // Comments at the beginning of the file result in the first\n      // item not containing a certificate - in this case the\n      // download will fail\n      if (ca.length > 0 && !/-----BEGIN CERTIFICATE-----/.test(ca[0])) {\n        ca.shift();\n      }\n\n    } catch (e) {\n      console.error('Could not read cafile', process.env.npm_config_cafile, e);\n    }\n  }\n\n  if (ca) {\n    console.log('Using npmconf ca');\n    options.agentOptions = {\n      ca: ca\n    };\n    options.ca = ca;\n  }\n\n  return options;\n}\n\nfunction getLatestVersion(requestOptions) {\n  var deferred = kew.defer();\n  var client = get(requestOptions, function (response) {\n    var body = '';\n    if (response.statusCode === 200) {\n      response.addListener('data', function (data) {\n        body += data;\n      });\n      response.addListener('end', function () {\n        try {\n          chromedriver_version = JSON.parse(body);\n        } catch (err) {\n          deferred.reject('Unable to parse response as JSON', err);\n        }\n        deferred.resolve(true);\n      });\n    } else {\n      client.abort();\n      deferred.reject('Error with ' + requestOptions.protocol + ' request: ' + util.inspect(response.headers));\n    }\n  });\n  return deferred.promise;\n}\n\nfunction requestBinary(requestOptions, filePath) {\n  var deferred = kew.defer();\n\n  var count = 0;\n  var notifiedCount = 0;\n  var outFile = fs.openSync(filePath, 'w');\n\n  var client = get(requestOptions, function (response) {\n    var status = response.statusCode;\n    console.log('Receiving...');\n\n    if (status === 200) {\n      response.addListener('data', function (data) {\n        fs.writeSync(outFile, data, 0, data.length, null);\n        count += data.length;\n        if ((count - notifiedCount) > 800000) {\n          console.log('Received ' + Math.floor(count / 1024) + 'K...');\n          notifiedCount = count;\n        }\n      });\n\n      response.addListener('end', function () {\n        console.log('Received ' + Math.floor(count / 1024) + 'K total.');\n        fs.closeSync(outFile);\n        deferred.resolve(true);\n      });\n\n    } else {\n      client.abort();\n      deferred.reject('Error with http request: ' + util.inspect(response.headers));\n    }\n  });\n\n  return deferred.promise;\n}\n\n\nfunction get(requestOptions, callback, redirects) {\n  redirects = redirects || 0;\n  var protocol = requestOptions.protocol === 'https:' ? https : http;\n  var client = protocol.get(requestOptions, function (response) {\n    var status = response.statusCode;\n    if ((status === 302 || status === 301 || status === 307) && redirects < 5) {\n      console.log('Redirect to %s', response.headers.location);\n      redirects++;\n      return get(getRequestOptions(response.headers.location), callback, redirects);\n    }\n    callback(response);\n  });\n  return client;\n}\n\n\nfunction extractDownload(filePath, tmpPath) {\n  var deferred = kew.defer();\n\n  console.log('Extracting zip contents');\n  try {\n    var zip = new AdmZip(filePath);\n    zip.extractAllTo(tmpPath, true);\n    deferred.resolve(true);\n  } catch (err) {\n    deferred.reject('Error extracting archive ' + err.stack);\n  }\n  return deferred.promise;\n}\n\n\nfunction copyIntoPlace(tmpPath, targetPath) {\n  rimraf(targetPath);\n  console.log(\"Copying to target path\", targetPath);\n  fs.mkdirSync(targetPath);\n\n  // Look for the extracted directory, so we can rename it.\n  var files = fs.readdirSync(tmpPath);\n  var promises = files.map(function (name) {\n    var deferred = kew.defer();\n\n    var file = path.join(tmpPath, name);\n    var reader = fs.createReadStream(file);\n\n    var targetFile = path.join(targetPath, name);\n    var writer = fs.createWriteStream(targetFile);\n    writer.on(\"close\", function () {\n      deferred.resolve(true);\n    });\n\n    reader.pipe(writer);\n    return deferred.promise;\n  });\n\n  return kew.all(promises);\n}\n\n\n\nfunction fixFilePermissions() {\n  // Check that the binary is user-executable and fix it if it isn't (problems with unzip library)\n  if (process.platform != 'win32') {\n    var stat = fs.statSync(helper.path);\n    // 64 == 0100 (no octal literal in strict mode)\n    if (!(stat.mode & 64)) {\n      console.log('Fixing file permissions');\n      fs.chmodSync(helper.path, '755');\n    }\n  }\n}\n"]}