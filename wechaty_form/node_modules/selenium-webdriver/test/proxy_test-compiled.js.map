{"version":3,"sources":["proxy_test.js"],"names":[],"mappings":"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","file":"proxy_test-compiled.js","sourcesContent":["// Licensed to the Software Freedom Conservancy (SFC) under one\n// or more contributor license agreements.  See the NOTICE file\n// distributed with this work for additional information\n// regarding copyright ownership.  The SFC licenses this file\n// to you under the Apache License, Version 2.0 (the\n// \"License\"); you may not use this file except in compliance\n// with the License.  You may obtain a copy of the License at\n//\n//   http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing,\n// software distributed under the License is distributed on an\n// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n// KIND, either express or implied.  See the License for the\n// specific language governing permissions and limitations\n// under the License.\n\n'use strict';\n\nvar http = require('http'),\n    url = require('url');\n\nvar Browser = require('..').Browser,\n    promise = require('..').promise,\n    firefox = require('../firefox'),\n    proxy = require('../proxy'),\n    assert = require('../testing/assert'),\n    test = require('../lib/test'),\n    Server = require('../lib/test/httpserver').Server,\n    Pages = test.Pages;\n\ntest.suite(function(env) {\n  function writeResponse(res, body, encoding, contentType) {\n    res.writeHead(200, {\n      'Content-Length': Buffer.byteLength(body, encoding),\n      'Content-Type': contentType\n    });\n    res.end(body);\n  }\n\n  function writePacFile(res) {\n    writeResponse(res, [\n      'function FindProxyForURL(url, host) {',\n      '  if (shExpMatch(url, \"' + goodbyeServer.url('*') + '\")) {',\n      '    return \"DIRECT\";',\n      '  }',\n      '  return \"PROXY ' + proxyServer.host() + '\";',\n      '}'\n    ].join('\\n'), 'ascii', 'application/x-javascript-config');\n  }\n\n  var proxyServer = new Server(function(req, res) {\n    var pathname = url.parse(req.url).pathname;\n    if (pathname === '/proxy.pac') {\n      return writePacFile(res);\n    }\n\n    writeResponse(res, [\n      '<!DOCTYPE html>',\n      '<title>Proxy page</title>',\n      '<h3>This is the proxy landing page</h3>'\n    ].join(''), 'utf8', 'text/html; charset=UTF-8');\n  });\n\n  var helloServer = new Server(function(req, res) {\n    writeResponse(res, [\n      '<!DOCTYPE html>',\n      '<title>Hello</title>',\n      '<h3>Hello, world!</h3>'\n    ].join(''), 'utf8', 'text/html; charset=UTF-8');\n  });\n\n  var goodbyeServer = new Server(function(req, res) {\n    writeResponse(res, [\n      '<!DOCTYPE html>',\n      '<title>Goodbye</title>',\n      '<h3>Goodbye, world!</h3>'\n    ].join(''), 'utf8', 'text/html; charset=UTF-8');\n  });\n\n  // Cannot pass start directly to mocha's before, as mocha will interpret the optional\n  // port parameter as an async callback parameter.\n  function mkStartFunc(server) {\n    return function() {\n      return server.start();\n    };\n  }\n\n  test.before(mkStartFunc(proxyServer));\n  test.before(mkStartFunc(helloServer));\n  test.before(mkStartFunc(goodbyeServer));\n\n  test.after(proxyServer.stop.bind(proxyServer));\n  test.after(helloServer.stop.bind(helloServer));\n  test.after(goodbyeServer.stop.bind(goodbyeServer));\n\n  var driver;\n  test.beforeEach(function() { driver = null; });\n  test.afterEach(function() { return driver && driver.quit(); });\n\n  function createDriver(proxy) {\n    // For Firefox we need to explicitly enable proxies for localhost by\n    // clearing the network.proxy.no_proxies_on preference.\n    let profile = new firefox.Profile();\n    profile.setPreference('network.proxy.no_proxies_on', '');\n\n    return driver = env.builder()\n        .setFirefoxOptions(new firefox.Options().setProfile(profile))\n        .setProxy(proxy)\n        .build();\n  }\n\n  // Proxy support not implemented.\n  test.ignore(env.browsers(Browser.IE, Browser.OPERA, Browser.SAFARI)).\n  describe('manual proxy settings', function() {\n    // phantomjs 1.9.1 in webdriver mode does not appear to respect proxy\n    // settings.\n    test.ignore(env.browsers(Browser.PHANTOM_JS)).\n    it('can configure HTTP proxy host', function*() {\n      yield createDriver(proxy.manual({\n        http: proxyServer.host()\n      }));\n\n      yield driver.get(helloServer.url());\n      yield assert(driver.getTitle()).equalTo('Proxy page');\n      yield assert(driver.findElement({tagName: 'h3'}).getText()).\n          equalTo('This is the proxy landing page');\n    });\n\n    // PhantomJS does not support bypassing the proxy for individual hosts.\n    // geckodriver does not support the bypass option, this must be configured\n    // through profile preferences.\n    test.ignore(env.browsers(\n        Browser.FIREFOX,\n        'legacy-' + Browser.FIREFOX,\n        Browser.PHANTOM_JS)).\n    it('can bypass proxy for specific hosts', function*() {\n      yield createDriver(proxy.manual({\n        http: proxyServer.host(),\n        bypass: helloServer.host()\n      }));\n\n      yield driver.get(helloServer.url());\n      yield assert(driver.getTitle()).equalTo('Hello');\n      yield assert(driver.findElement({tagName: 'h3'}).getText()).\n          equalTo('Hello, world!');\n\n      yield driver.get(goodbyeServer.url());\n      yield assert(driver.getTitle()).equalTo('Proxy page');\n      yield assert(driver.findElement({tagName: 'h3'}).getText()).\n          equalTo('This is the proxy landing page');\n    });\n\n    // TODO: test ftp and https proxies.\n  });\n\n  // PhantomJS does not support PAC file proxy configuration.\n  // Safari does not support proxies.\n  test.ignore(env.browsers(\n      Browser.IE, Browser.OPERA, Browser.PHANTOM_JS, Browser.SAFARI)).\n  describe('pac proxy settings', function() {\n    test.it('can configure proxy through PAC file', function*() {\n      yield createDriver(proxy.pac(proxyServer.url('/proxy.pac')));\n\n      yield driver.get(helloServer.url());\n      yield assert(driver.getTitle()).equalTo('Proxy page');\n      yield assert(driver.findElement({tagName: 'h3'}).getText()).\n          equalTo('This is the proxy landing page');\n\n      yield driver.get(goodbyeServer.url());\n      yield assert(driver.getTitle()).equalTo('Goodbye');\n      yield assert(driver.findElement({tagName: 'h3'}).getText()).\n          equalTo('Goodbye, world!');\n    });\n  });\n\n  // TODO: figure out how to test direct and system proxy settings.\n  describe.skip('direct proxy settings', function() {});\n  describe.skip('system proxy settings', function() {});\n});\n"]}