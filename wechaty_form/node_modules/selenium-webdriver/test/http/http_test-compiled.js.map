{"version":3,"sources":["http_test.js"],"names":[],"mappings":"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","file":"http_test-compiled.js","sourcesContent":["// Licensed to the Software Freedom Conservancy (SFC) under one\n// or more contributor license agreements.  See the NOTICE file\n// distributed with this work for additional information\n// regarding copyright ownership.  The SFC licenses this file\n// to you under the Apache License, Version 2.0 (the\n// \"License\"); you may not use this file except in compliance\n// with the License.  You may obtain a copy of the License at\n//\n//   http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing,\n// software distributed under the License is distributed on an\n// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n// KIND, either express or implied.  See the License for the\n// specific language governing permissions and limitations\n// under the License.\n\n'use strict';\n\nvar assert = require('assert'),\n    http = require('http'),\n    url = require('url');\n\nvar HttpClient = require('../../http').HttpClient,\n    HttpRequest = require('../../lib/http').Request,\n    HttpResponse = require('../../lib/http').Response,\n    Server = require('../../lib/test/httpserver').Server;\n\ndescribe('HttpClient', function() {\n  this.timeout(4 * 1000);\n\n  var server = new Server(function(req, res) {\n    let parsedUrl = url.parse(req.url);\n\n    if (req.method == 'GET' && req.url == '/echo') {\n      res.writeHead(200, req.headers);\n      res.end();\n\n    } else if (req.method == 'GET' && req.url == '/redirect') {\n      res.writeHead(303, {'Location': server.url('/hello')});\n      res.end();\n\n    } else if (req.method == 'GET' && req.url == '/hello') {\n      res.writeHead(200, {'content-type': 'text/plain'});\n      res.end('hello, world!');\n\n    } else if (req.method == 'GET' && req.url == '/badredirect') {\n      res.writeHead(303, {});\n      res.end();\n\n    } else if (req.method == 'GET' && req.url == '/protected') {\n      var denyAccess = function() {\n        res.writeHead(401, {'WWW-Authenticate': 'Basic realm=\"test\"'});\n        res.end('Access denied');\n      };\n\n      var basicAuthRegExp = /^\\s*basic\\s+([a-z0-9\\-\\._~\\+\\/]+)=*\\s*$/i\n      var auth = req.headers.authorization;\n      var match = basicAuthRegExp.exec(auth || '');\n      if (!match) {\n        denyAccess();\n        return;\n      }\n\n      var userNameAndPass = new Buffer(match[1], 'base64').toString();\n      var parts = userNameAndPass.split(':', 2);\n      if (parts[0] !== 'genie' && parts[1] !== 'bottle') {\n        denyAccess();\n        return;\n      }\n\n      res.writeHead(200, {'content-type': 'text/plain'});\n      res.end('Access granted!');\n\n    } else if (req.method == 'GET'\n        && parsedUrl.pathname\n        && parsedUrl.pathname.endsWith('/proxy')) {\n      let headers = Object.assign({}, req.headers);\n      headers['x-proxy-request-uri'] = req.url;\n      res.writeHead(200, headers);\n      res.end();\n\n    } else if (req.method == 'GET'\n        && parsedUrl.pathname\n        && parsedUrl.pathname.endsWith('/proxy/redirect')) {\n      let path = `/proxy${parsedUrl.search || ''}${parsedUrl.hash || ''}`;\n      res.writeHead(303, {'Location': path});\n      res.end();\n\n    } else {\n      res.writeHead(404, {});\n      res.end();\n    }\n  });\n\n  before(function() {\n    return server.start();\n  });\n\n  after(function() {\n    return server.stop();\n  });\n\n  it('can send a basic HTTP request', function() {\n    var request = new HttpRequest('GET', '/echo');\n    request.headers.set('Foo', 'Bar');\n\n    var agent = new http.Agent();\n    agent.maxSockets = 1;  // Only making 1 request.\n\n    var client = new HttpClient(server.url(), agent);\n    return client.send(request).then(function(response) {\n      assert.equal(200, response.status);\n      assert.equal(response.headers.get('content-length'), '0');\n      assert.equal(response.headers.get('connection'), 'keep-alive');\n      assert.equal(response.headers.get('host'), server.host());\n\n      assert.equal(request.headers.get('Foo'), 'Bar');\n      assert.equal(\n          request.headers.get('Accept'), 'application/json; charset=utf-8');\n    });\n  });\n\n  it('can use basic auth', function() {\n    var parsed = url.parse(server.url());\n    parsed.auth = 'genie:bottle';\n\n    var client = new HttpClient(url.format(parsed));\n    var request = new HttpRequest('GET', '/protected');\n    return client.send(request).then(function(response) {\n      assert.equal(200, response.status);\n      assert.equal(response.headers.get('content-type'), 'text/plain');\n      assert.equal(response.body, 'Access granted!');\n    });\n  });\n\n  it('fails requests missing required basic auth', function() {\n    var client = new HttpClient(server.url());\n    var request = new HttpRequest('GET', '/protected');\n    return client.send(request).then(function(response) {\n      assert.equal(401, response.status);\n      assert.equal(response.body, 'Access denied');\n    });\n  });\n\n  it('automatically follows redirects', function() {\n    var request = new HttpRequest('GET', '/redirect');\n    var client = new HttpClient(server.url());\n    return client.send(request).then(function(response) {\n      assert.equal(200, response.status);\n      assert.equal(response.headers.get('content-type'), 'text/plain');\n      assert.equal(response.body, 'hello, world!');\n    });\n  });\n\n  it('handles malformed redirect responses', function() {\n    var request = new HttpRequest('GET', '/badredirect');\n    var client = new HttpClient(server.url());\n    return client.send(request).then(assert.fail, function(err) {\n      assert.ok(/Failed to parse \"Location\"/.test(err.message),\n          'Not the expected error: ' + err.message);\n    });\n  });\n\n  describe('with proxy', function() {\n    it('sends request to proxy with absolute URI', function() {\n      var request = new HttpRequest('GET', '/proxy');\n      var client = new HttpClient(\n          'http://another.server.com', undefined, server.url());\n      return client.send(request).then(function(response) {\n        assert.equal(200, response.status);\n        assert.equal(response.headers.get('host'), 'another.server.com');\n        assert.equal(\n            response.headers.get('x-proxy-request-uri'),\n            'http://another.server.com/proxy');\n      });\n    });\n\n    it('uses proxy when following redirects', function() {\n      var request = new HttpRequest('GET', '/proxy/redirect');\n      var client = new HttpClient(\n          'http://another.server.com', undefined, server.url());\n      return client.send(request).then(function(response) {\n        assert.equal(200, response.status);\n        assert.equal(response.headers.get('host'), 'another.server.com');\n        assert.equal(\n            response.headers.get('x-proxy-request-uri'),\n            'http://another.server.com/proxy');\n      });\n    });\n\n    it('includes search and hash in redirect URI', function() {\n      var request = new HttpRequest('GET', '/proxy/redirect?foo#bar');\n      var client = new HttpClient(\n          'http://another.server.com', undefined, server.url());\n      return client.send(request).then(function(response) {\n        assert.equal(200, response.status);\n        assert.equal(response.headers.get('host'), 'another.server.com');\n        assert.equal(\n            response.headers.get('x-proxy-request-uri'),\n            'http://another.server.com/proxy?foo#bar');\n      });\n    });\n  });\n});\n"]}