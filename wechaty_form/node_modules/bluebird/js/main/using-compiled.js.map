{"version":3,"sources":["using.js"],"names":[],"mappings":"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","file":"using-compiled.js","sourcesContent":["\"use strict\";\nmodule.exports = function (Promise, apiRejection, tryConvertToPromise,\n    createContext) {\n    var TypeError = require(\"./errors.js\").TypeError;\n    var inherits = require(\"./util.js\").inherits;\n    var PromiseInspection = Promise.PromiseInspection;\n\n    function inspectionMapper(inspections) {\n        var len = inspections.length;\n        for (var i = 0; i < len; ++i) {\n            var inspection = inspections[i];\n            if (inspection.isRejected()) {\n                return Promise.reject(inspection.error());\n            }\n            inspections[i] = inspection._settledValue;\n        }\n        return inspections;\n    }\n\n    function thrower(e) {\n        setTimeout(function(){throw e;}, 0);\n    }\n\n    function castPreservingDisposable(thenable) {\n        var maybePromise = tryConvertToPromise(thenable);\n        if (maybePromise !== thenable &&\n            typeof thenable._isDisposable === \"function\" &&\n            typeof thenable._getDisposer === \"function\" &&\n            thenable._isDisposable()) {\n            maybePromise._setDisposable(thenable._getDisposer());\n        }\n        return maybePromise;\n    }\n    function dispose(resources, inspection) {\n        var i = 0;\n        var len = resources.length;\n        var ret = Promise.defer();\n        function iterator() {\n            if (i >= len) return ret.resolve();\n            var maybePromise = castPreservingDisposable(resources[i++]);\n            if (maybePromise instanceof Promise &&\n                maybePromise._isDisposable()) {\n                try {\n                    maybePromise = tryConvertToPromise(\n                        maybePromise._getDisposer().tryDispose(inspection),\n                        resources.promise);\n                } catch (e) {\n                    return thrower(e);\n                }\n                if (maybePromise instanceof Promise) {\n                    return maybePromise._then(iterator, thrower,\n                                              null, null, null);\n                }\n            }\n            iterator();\n        }\n        iterator();\n        return ret.promise;\n    }\n\n    function disposerSuccess(value) {\n        var inspection = new PromiseInspection();\n        inspection._settledValue = value;\n        inspection._bitField = 268435456;\n        return dispose(this, inspection).thenReturn(value);\n    }\n\n    function disposerFail(reason) {\n        var inspection = new PromiseInspection();\n        inspection._settledValue = reason;\n        inspection._bitField = 134217728;\n        return dispose(this, inspection).thenThrow(reason);\n    }\n\n    function Disposer(data, promise, context) {\n        this._data = data;\n        this._promise = promise;\n        this._context = context;\n    }\n\n    Disposer.prototype.data = function () {\n        return this._data;\n    };\n\n    Disposer.prototype.promise = function () {\n        return this._promise;\n    };\n\n    Disposer.prototype.resource = function () {\n        if (this.promise().isFulfilled()) {\n            return this.promise().value();\n        }\n        return null;\n    };\n\n    Disposer.prototype.tryDispose = function(inspection) {\n        var resource = this.resource();\n        var context = this._context;\n        if (context !== undefined) context._pushContext();\n        var ret = resource !== null\n            ? this.doDispose(resource, inspection) : null;\n        if (context !== undefined) context._popContext();\n        this._promise._unsetDisposable();\n        this._data = null;\n        return ret;\n    };\n\n    Disposer.isDisposer = function (d) {\n        return (d != null &&\n                typeof d.resource === \"function\" &&\n                typeof d.tryDispose === \"function\");\n    };\n\n    function FunctionDisposer(fn, promise, context) {\n        this.constructor$(fn, promise, context);\n    }\n    inherits(FunctionDisposer, Disposer);\n\n    FunctionDisposer.prototype.doDispose = function (resource, inspection) {\n        var fn = this.data();\n        return fn.call(resource, resource, inspection);\n    };\n\n    function maybeUnwrapDisposer(value) {\n        if (Disposer.isDisposer(value)) {\n            this.resources[this.index]._setDisposable(value);\n            return value.promise();\n        }\n        return value;\n    }\n\n    Promise.using = function () {\n        var len = arguments.length;\n        if (len < 2) return apiRejection(\n                        \"you must pass at least 2 arguments to Promise.using\");\n        var fn = arguments[len - 1];\n        if (typeof fn !== \"function\") return apiRejection(\"fn must be a function\\u000a\\u000a    See http://goo.gl/916lJJ\\u000a\");\n\n        var input;\n        var spreadArgs = true;\n        if (len === 2 && Array.isArray(arguments[0])) {\n            input = arguments[0];\n            len = input.length;\n            spreadArgs = false;\n        } else {\n            input = arguments;\n            len--;\n        }\n        var resources = new Array(len);\n        for (var i = 0; i < len; ++i) {\n            var resource = input[i];\n            if (Disposer.isDisposer(resource)) {\n                var disposer = resource;\n                resource = resource.promise();\n                resource._setDisposable(disposer);\n            } else {\n                var maybePromise = tryConvertToPromise(resource);\n                if (maybePromise instanceof Promise) {\n                    resource =\n                        maybePromise._then(maybeUnwrapDisposer, null, null, {\n                            resources: resources,\n                            index: i\n                    }, undefined);\n                }\n            }\n            resources[i] = resource;\n        }\n\n        var promise = Promise.settle(resources)\n            .then(inspectionMapper)\n            .then(function(vals) {\n                promise._pushContext();\n                var ret;\n                try {\n                    ret = spreadArgs\n                        ? fn.apply(undefined, vals) : fn.call(undefined,  vals);\n                } finally {\n                    promise._popContext();\n                }\n                return ret;\n            })\n            ._then(\n                disposerSuccess, disposerFail, undefined, resources, undefined);\n        resources.promise = promise;\n        return promise;\n    };\n\n    Promise.prototype._setDisposable = function (disposer) {\n        this._bitField = this._bitField | 262144;\n        this._disposer = disposer;\n    };\n\n    Promise.prototype._isDisposable = function () {\n        return (this._bitField & 262144) > 0;\n    };\n\n    Promise.prototype._getDisposer = function () {\n        return this._disposer;\n    };\n\n    Promise.prototype._unsetDisposable = function () {\n        this._bitField = this._bitField & (~262144);\n        this._disposer = undefined;\n    };\n\n    Promise.prototype.disposer = function (fn) {\n        if (typeof fn === \"function\") {\n            return new FunctionDisposer(fn, this, createContext());\n        }\n        throw new TypeError();\n    };\n\n};\n"]}