{"version":3,"sources":["authenticate.js"],"names":[],"mappings":"AAAA,IAAI,eAAe,QAAQ,SAAR,EAAmB,YAAtC;AAAA,IACI,iBAAiB,QAAQ,SAAR,EAAmB,cADxC;AAAA,IAEI,aAAa,QAAQ,cAAR,EAAwB,UAFzC;;AAIA,IAAI,eAAe,UAAS,IAAT,EAAe,QAAf,EAAyB,QAAzB,EAAmC,OAAnC,EAA4C,QAA5C,EAAsD;AACvE;AACA,MAAG,KAAK,YAAL,IAAqB,KAAK,YAAL,CAAkB,WAAlB,EAAxB,EAAyD,OAAO,SAAS,IAAI,UAAJ,CAAe,wBAAf,CAAT,CAAP;;AAEzD;AACA;AACA,MAAI,SAAS,QAAQ,MAAR,GAAiB,QAAQ,MAAzB,GAAkC,KAAK,YAApD;AACA,WAAS,KAAK,UAAL,GAAkB,KAAK,UAAvB,GAAoC,MAA7C;AACA,WAAS,QAAQ,MAAR,GAAiB,QAAQ,MAAzB,GAAkC,MAA3C;AACA,WAAS,QAAQ,UAAR,GAAqB,QAAQ,UAA7B,GAA0C,MAAnD;;AAEA;AACA,MAAI,YAAY,UAAS,GAAT,EAAc,MAAd,EAAsB;AACpC,QAAG,KAAK,SAAL,CAAe,eAAf,EAAgC,MAAhC,GAAyC,CAA5C,EAA+C;AAC7C,WAAK,IAAL,CAAU,eAAV,EAA2B,GAA3B,EAAgC,MAAhC;AACD;;AAED;AACA,mBAAe,QAAf,EAAyB,GAAzB,EAA8B,MAA9B;AACD,GAPD;;AASA;AACA,MAAI,gBAAgB,QAAQ,aAAR,IAAyB,EAA7C;AACA,kBAAgB,cAAc,WAAd,EAAhB;;AAEA;AACA,MAAG,iBAAiB,YAApB,EAAkC;AAChC,SAAK,CAAL,CAAO,QAAP,CAAgB,IAAhB,CAAqB,SAArB,EAAgC,MAAhC,EAAwC,QAAxC,EAAkD,QAAlD,EAA4D,UAAS,GAAT,EAAc;AACxE,UAAG,GAAH,EAAQ,OAAO,eAAe,QAAf,EAAyB,GAAzB,EAA8B,KAA9B,CAAP;AACR,gBAAU,IAAV,EAAgB,IAAhB;AACD,KAHD;AAID,GALD,MAKO,IAAG,iBAAiB,OAApB,EAA6B;AAClC,SAAK,CAAL,CAAO,QAAP,CAAgB,IAAhB,CAAqB,OAArB,EAA8B,MAA9B,EAAsC,QAAtC,EAAgD,QAAhD,EAA0D,UAAS,GAAT,EAAc;AACtE,UAAG,GAAH,EAAQ,OAAO,eAAe,QAAf,EAAyB,GAAzB,EAA8B,KAA9B,CAAP;AACR,gBAAU,IAAV,EAAgB,IAAhB;AACD,KAHD;AAID,GALM,MAKA,IAAG,iBAAiB,cAApB,EAAoC;AACzC,SAAK,CAAL,CAAO,QAAP,CAAgB,IAAhB,CAAqB,MAArB,EAA6B,MAA7B,EAAqC,QAArC,EAA+C,QAA/C,EAAyD,UAAS,GAAT,EAAc;AACrE,UAAG,GAAH,EAAQ,OAAO,eAAe,QAAf,EAAyB,GAAzB,EAA8B,KAA9B,CAAP;AACR,gBAAU,IAAV,EAAgB,IAAhB;AACD,KAHD;AAID,GALM,MAKA,IAAG,iBAAiB,aAApB,EAAmC;AACxC,SAAK,CAAL,CAAO,QAAP,CAAgB,IAAhB,CAAqB,aAArB,EAAoC,MAApC,EAA4C,QAA5C,EAAsD,QAAtD,EAAgE,UAAS,GAAT,EAAc;AAC5E,UAAG,GAAH,EAAQ,OAAO,eAAe,QAAf,EAAyB,GAAzB,EAA8B,KAA9B,CAAP;AACR,gBAAU,IAAV,EAAgB,IAAhB;AACD,KAHD;AAID,GALM,MAKA,IAAG,iBAAiB,QAApB,EAA8B;AACnC,QAAG,QAAQ,QAAR,IAAoB,OAAvB,EAAgC;AAC9B,WAAK,CAAL,CAAO,QAAP,CAAgB,IAAhB,CAAqB,MAArB,EAA6B,MAA7B,EAAqC,QAArC,EAA+C,QAA/C,EAAyD,OAAzD,EAAkE,UAAS,GAAT,EAAc;AAC9E,YAAG,GAAH,EAAQ,OAAO,eAAe,QAAf,EAAyB,GAAzB,EAA8B,KAA9B,CAAP;AACR,kBAAU,IAAV,EAAgB,IAAhB;AACD,OAHD;AAID,KALD,MAKO;AACL,WAAK,CAAL,CAAO,QAAP,CAAgB,IAAhB,CAAqB,QAArB,EAA+B,MAA/B,EAAuC,QAAvC,EAAiD,QAAjD,EAA2D,OAA3D,EAAoE,UAAS,GAAT,EAAc;AAChF,YAAG,GAAH,EAAQ,OAAO,eAAe,QAAf,EAAyB,GAAzB,EAA8B,KAA9B,CAAP;AACR,kBAAU,IAAV,EAAgB,IAAhB;AACD,OAHD;AAID;AACF,GAZM,MAYA,IAAG,iBAAiB,SAApB,EAA+B;AACpC,SAAK,CAAL,CAAO,QAAP,CAAgB,IAAhB,CAAqB,SAArB,EAAgC,MAAhC,EAAwC,QAAxC,EAAkD,QAAlD,EAA4D,UAAS,GAAT,EAAc;AACxE,UAAG,GAAH,EAAQ,OAAO,eAAe,QAAf,EAAyB,GAAzB,EAA8B,KAA9B,CAAP;AACR,gBAAU,IAAV,EAAgB,IAAhB;AACD,KAHD;AAID,GALM,MAKA;AACL,mBAAe,QAAf,EAAyB,WAAW,MAAX,CAAkB,EAAC,SAAS,EAAE,2CAAF,EAA+C,QAAQ,aAAvD,CAAV,EAAiF,QAAO,IAAxF,EAAlB,CAAzB;AACD;AACF,CAlED;;AAoEA,OAAO,OAAP,GAAiB,UAAS,IAAT,EAAe,QAAf,EAAyB,QAAzB,EAAmC,OAAnC,EAA4C,QAA5C,EAAsD;AACrE,MAAG,OAAO,OAAP,IAAkB,UAArB,EAAiC,WAAW,OAAX,EAAoB,UAAU,EAA9B;AACjC;AACA,YAAU,aAAa,OAAb,CAAV;;AAEA;AACA,MAAG,CAAC,QAAQ,aAAZ,EAA2B;AACzB,YAAQ,aAAR,GAAwB,SAAxB;AACD,GAFD,MAEO,IAAG,QAAQ,aAAR,IAAyB,QAAzB,IACL,QAAQ,aAAR,IAAyB,SADpB,IAEL,QAAQ,aAAR,IAAyB,YAFpB,IAGL,QAAQ,aAAR,IAAyB,cAHpB,IAIL,QAAQ,aAAR,IAAyB,aAJpB,IAKL,QAAQ,aAAR,IAAyB,OALvB,EAKgC;AACnC,WAAO,eAAe,QAAf,EAAyB,WAAW,MAAX,CAAkB,EAAC,SAAS,oGAAV,EAAgH,QAAO,IAAvH,EAAlB,CAAzB,CAAP;AACH;;AAED;AACA,MAAG,OAAO,QAAP,IAAmB,UAAtB,EAAkC,OAAO,aAAa,IAAb,EAAmB,QAAnB,EAA6B,QAA7B,EAAuC,OAAvC,EAAgD,UAAS,GAAT,EAAc,CAAd,EAAiB;AACxG;AACA,QAAG,OAAO,IAAI,OAAX,IAAsB,IAAI,OAAJ,CAAY,OAAZ,CAAoB,WAApB,KAAoC,CAAC,CAA9D,EAAiE,IAAI,IAAJ,GAAW,EAAX;AACjE;AACA,QAAG,GAAH,EAAQ,OAAO,SAAS,GAAT,EAAc,CAAd,CAAP;AACR,aAAS,IAAT,EAAe,CAAf;AACD,GANwC,CAAP;;AAQlC;AACA,SAAO,IAAI,KAAK,CAAL,CAAO,cAAX,CAA0B,UAAS,OAAT,EAAkB,MAAlB,EAA0B;AACzD,iBAAa,IAAb,EAAmB,QAAnB,EAA6B,QAA7B,EAAuC,OAAvC,EAAgD,UAAS,GAAT,EAAc,CAAd,EAAiB;AAC/D;AACA,UAAG,OAAO,IAAI,OAAX,IAAsB,IAAI,OAAJ,CAAY,OAAZ,CAAoB,WAApB,KAAoC,CAAC,CAA9D,EAAiE,IAAI,IAAJ,GAAW,EAAX;AACjE;AACA,UAAG,GAAH,EAAQ,OAAO,OAAO,GAAP,CAAP;AACR,cAAQ,CAAR;AACD,KAND;AAOD,GARM,CAAP;AASD,CApCD","file":"authenticate-compiled.js","sourcesContent":["var shallowClone = require('./utils').shallowClone\n  , handleCallback = require('./utils').handleCallback\n  , MongoError = require('mongodb-core').MongoError;\n\nvar authenticate = function(self, username, password, options, callback) {\n  // Did the user destroy the topology\n  if(self.serverConfig && self.serverConfig.isDestroyed()) return callback(new MongoError('topology was destroyed'));\n\n  // the default db to authenticate against is 'self'\n  // if authententicate is called from a retry context, it may be another one, like admin\n  var authdb = options.dbName ? options.dbName : self.databaseName;\n  authdb = self.authSource ? self.authSource : authdb;\n  authdb = options.authdb ? options.authdb : authdb;\n  authdb = options.authSource ? options.authSource : authdb;\n\n  // Callback\n  var _callback = function(err, result) {\n    if(self.listeners('authenticated').length > 0) {\n      self.emit('authenticated', err, result);\n    }\n\n    // Return to caller\n    handleCallback(callback, err, result);\n  }\n\n  // authMechanism\n  var authMechanism = options.authMechanism || '';\n  authMechanism = authMechanism.toUpperCase();\n\n  // If classic auth delegate to auth command\n  if(authMechanism == 'MONGODB-CR') {\n    self.s.topology.auth('mongocr', authdb, username, password, function(err) {\n      if(err) return handleCallback(callback, err, false);\n      _callback(null, true);\n    });\n  } else if(authMechanism == 'PLAIN') {\n    self.s.topology.auth('plain', authdb, username, password, function(err) {\n      if(err) return handleCallback(callback, err, false);\n      _callback(null, true);\n    });\n  } else if(authMechanism == 'MONGODB-X509') {\n    self.s.topology.auth('x509', authdb, username, password, function(err) {\n      if(err) return handleCallback(callback, err, false);\n      _callback(null, true);\n    });\n  } else if(authMechanism == 'SCRAM-SHA-1') {\n    self.s.topology.auth('scram-sha-1', authdb, username, password, function(err) {\n      if(err) return handleCallback(callback, err, false);\n      _callback(null, true);\n    });\n  } else if(authMechanism == 'GSSAPI') {\n    if(process.platform == 'win32') {\n      self.s.topology.auth('sspi', authdb, username, password, options, function(err) {\n        if(err) return handleCallback(callback, err, false);\n        _callback(null, true);\n      });\n    } else {\n      self.s.topology.auth('gssapi', authdb, username, password, options, function(err) {\n        if(err) return handleCallback(callback, err, false);\n        _callback(null, true);\n      });\n    }\n  } else if(authMechanism == 'DEFAULT') {\n    self.s.topology.auth('default', authdb, username, password, function(err) {\n      if(err) return handleCallback(callback, err, false);\n      _callback(null, true);\n    });\n  } else {\n    handleCallback(callback, MongoError.create({message: f(\"authentication mechanism %s not supported\", options.authMechanism), driver:true}));\n  }\n}\n\nmodule.exports = function(self, username, password, options, callback) {\n  if(typeof options == 'function') callback = options, options = {};\n  // Shallow copy the options\n  options = shallowClone(options);\n\n  // Set default mechanism\n  if(!options.authMechanism) {\n    options.authMechanism = 'DEFAULT';\n  } else if(options.authMechanism != 'GSSAPI'\n    && options.authMechanism != 'DEFAULT'\n    && options.authMechanism != 'MONGODB-CR'\n    && options.authMechanism != 'MONGODB-X509'\n    && options.authMechanism != 'SCRAM-SHA-1'\n    && options.authMechanism != 'PLAIN') {\n      return handleCallback(callback, MongoError.create({message: \"only DEFAULT, GSSAPI, PLAIN, MONGODB-X509, SCRAM-SHA-1 or MONGODB-CR is supported by authMechanism\", driver:true}));\n  }\n\n  // If we have a callback fallback\n  if(typeof callback == 'function') return authenticate(self, username, password, options, function(err, r) {\n    // Support failed auth method\n    if(err && err.message && err.message.indexOf('saslStart') != -1) err.code = 59;\n    // Reject error\n    if(err) return callback(err, r);\n    callback(null, r);\n  });\n\n  // Return a promise\n  return new self.s.promiseLibrary(function(resolve, reject) {\n    authenticate(self, username, password, options, function(err, r) {\n      // Support failed auth method\n      if(err && err.message && err.message.indexOf('saslStart') != -1) err.code = 59;\n      // Reject error\n      if(err) return reject(err);\n      resolve(r);\n    });\n  });\n};\n"]}