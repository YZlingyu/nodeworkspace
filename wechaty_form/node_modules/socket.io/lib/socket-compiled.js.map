{"version":3,"sources":["socket.js"],"names":[],"mappings":"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","file":"socket-compiled.js","sourcesContent":["\n/**\n * Module dependencies.\n */\n\nvar Emitter = require('events').EventEmitter;\nvar parser = require('socket.io-parser');\nvar url = require('url');\nvar debug = require('debug')('socket.io:socket');\nvar hasBin = require('has-binary');\nvar assign = require('object-assign');\n\n/**\n * Module exports.\n */\n\nmodule.exports = exports = Socket;\n\n/**\n * Blacklisted events.\n *\n * @api public\n */\n\nexports.events = [\n  'error',\n  'connect',\n  'disconnect',\n  'disconnecting',\n  'newListener',\n  'removeListener'\n];\n\n/**\n * Flags.\n *\n * @api private\n */\n\nvar flags = [\n  'json',\n  'volatile',\n  'broadcast'\n];\n\n/**\n * `EventEmitter#emit` reference.\n */\n\nvar emit = Emitter.prototype.emit;\n\n/**\n * Interface to a `Client` for a given `Namespace`.\n *\n * @param {Namespace} nsp\n * @param {Client} client\n * @api public\n */\n\nfunction Socket(nsp, client, query){\n  this.nsp = nsp;\n  this.server = nsp.server;\n  this.adapter = this.nsp.adapter;\n  this.id = nsp.name !== '/' ? nsp.name + '#' + client.id : client.id;\n  this.client = client;\n  this.conn = client.conn;\n  this.rooms = {};\n  this.acks = {};\n  this.connected = true;\n  this.disconnected = false;\n  this.handshake = this.buildHandshake(query);\n  this.fns = [];\n}\n\n/**\n * Inherits from `EventEmitter`.\n */\n\nSocket.prototype.__proto__ = Emitter.prototype;\n\n/**\n * Apply flags from `Socket`.\n */\n\nflags.forEach(function(flag){\n  Object.defineProperty(Socket.prototype, flag, {\n    get: function() {\n      this.flags = this.flags || {};\n      this.flags[flag] = true;\n      return this;\n    }\n  });\n});\n\n/**\n * `request` engine.io shortcut.\n *\n * @api public\n */\n\nObject.defineProperty(Socket.prototype, 'request', {\n  get: function() {\n    return this.conn.request;\n  }\n});\n\n/**\n * Builds the `handshake` BC object\n *\n * @api private\n */\n\nSocket.prototype.buildHandshake = function(query){\n  var self = this;\n  function buildQuery(){\n    var requestQuery = url.parse(self.request.url, true).query;\n    //if socket-specific query exist, replace query strings in requestQuery\n    return assign({}, query, requestQuery);\n  }\n  return {\n    headers: this.request.headers,\n    time: (new Date) + '',\n    address: this.conn.remoteAddress,\n    xdomain: !!this.request.headers.origin,\n    secure: !!this.request.connection.encrypted,\n    issued: +(new Date),\n    url: this.request.url,\n    query: buildQuery()\n  };\n};\n\n/**\n * Emits to this client.\n *\n * @return {Socket} self\n * @api public\n */\n\nSocket.prototype.emit = function(ev){\n  if (~exports.events.indexOf(ev)) {\n    emit.apply(this, arguments);\n  } else {\n    var args = Array.prototype.slice.call(arguments);\n    var packet = {};\n    packet.type = hasBin(args) ? parser.BINARY_EVENT : parser.EVENT;\n    packet.data = args;\n    var flags = this.flags || {};\n\n    // access last argument to see if it's an ACK callback\n    if ('function' == typeof args[args.length - 1]) {\n      if (this._rooms || flags.broadcast) {\n        throw new Error('Callbacks are not supported when broadcasting');\n      }\n\n      debug('emitting packet with ack id %d', this.nsp.ids);\n      this.acks[this.nsp.ids] = args.pop();\n      packet.id = this.nsp.ids++;\n    }\n\n    if (this._rooms || flags.broadcast) {\n      this.adapter.broadcast(packet, {\n        except: [this.id],\n        rooms: this._rooms,\n        flags: flags\n      });\n    } else {\n      // dispatch packet\n      this.packet(packet, {\n        volatile: flags.volatile,\n        compress: flags.compress\n      });\n    }\n\n    // reset flags\n    delete this._rooms;\n    delete this.flags;\n  }\n  return this;\n};\n\n/**\n * Targets a room when broadcasting.\n *\n * @param {String} name\n * @return {Socket} self\n * @api public\n */\n\nSocket.prototype.to =\nSocket.prototype.in = function(name){\n  this._rooms = this._rooms || [];\n  if (!~this._rooms.indexOf(name)) this._rooms.push(name);\n  return this;\n};\n\n/**\n * Sends a `message` event.\n *\n * @return {Socket} self\n * @api public\n */\n\nSocket.prototype.send =\nSocket.prototype.write = function(){\n  var args = Array.prototype.slice.call(arguments);\n  args.unshift('message');\n  this.emit.apply(this, args);\n  return this;\n};\n\n/**\n * Writes a packet.\n *\n * @param {Object} packet object\n * @param {Object} opts options\n * @api private\n */\n\nSocket.prototype.packet = function(packet, opts){\n  packet.nsp = this.nsp.name;\n  opts = opts || {};\n  opts.compress = false !== opts.compress;\n  this.client.packet(packet, opts);\n};\n\n/**\n * Joins a room.\n *\n * @param {String} room\n * @param {Function} fn optional, callback\n * @return {Socket} self\n * @api private\n */\n\nSocket.prototype.join = function(room, fn){\n  debug('joining room %s', room);\n  var self = this;\n  if (this.rooms.hasOwnProperty(room)) {\n    fn && fn(null);\n    return this;\n  }\n  this.adapter.add(this.id, room, function(err){\n    if (err) return fn && fn(err);\n    debug('joined room %s', room);\n    self.rooms[room] = room;\n    fn && fn(null);\n  });\n  return this;\n};\n\n/**\n * Leaves a room.\n *\n * @param {String} room\n * @param {Function} fn optional, callback\n * @return {Socket} self\n * @api private\n */\n\nSocket.prototype.leave = function(room, fn){\n  debug('leave room %s', room);\n  var self = this;\n  this.adapter.del(this.id, room, function(err){\n    if (err) return fn && fn(err);\n    debug('left room %s', room);\n    delete self.rooms[room];\n    fn && fn(null);\n  });\n  return this;\n};\n\n/**\n * Leave all rooms.\n *\n * @api private\n */\n\nSocket.prototype.leaveAll = function(){\n  this.adapter.delAll(this.id);\n  this.rooms = {};\n};\n\n/**\n * Called by `Namespace` upon successful\n * middleware execution (ie: authorization).\n * Socket is added to namespace array before\n * call to join, so adapters can access it.\n *\n * @api private\n */\n\nSocket.prototype.onconnect = function(){\n  debug('socket connected - writing packet');\n  this.nsp.connected[this.id] = this;\n  this.join(this.id);\n  this.packet({ type: parser.CONNECT });\n};\n\n/**\n * Called with each packet. Called by `Client`.\n *\n * @param {Object} packet\n * @api private\n */\n\nSocket.prototype.onpacket = function(packet){\n  debug('got packet %j', packet);\n  switch (packet.type) {\n    case parser.EVENT:\n      this.onevent(packet);\n      break;\n\n    case parser.BINARY_EVENT:\n      this.onevent(packet);\n      break;\n\n    case parser.ACK:\n      this.onack(packet);\n      break;\n\n    case parser.BINARY_ACK:\n      this.onack(packet);\n      break;\n\n    case parser.DISCONNECT:\n      this.ondisconnect();\n      break;\n\n    case parser.ERROR:\n      this.emit('error', packet.data);\n  }\n};\n\n/**\n * Called upon event packet.\n *\n * @param {Object} packet object\n * @api private\n */\n\nSocket.prototype.onevent = function(packet){\n  var args = packet.data || [];\n  debug('emitting event %j', args);\n\n  if (null != packet.id) {\n    debug('attaching ack callback to event');\n    args.push(this.ack(packet.id));\n  }\n\n  this.dispatch(args);\n};\n\n/**\n * Produces an ack callback to emit with an event.\n *\n * @param {Number} id packet id\n * @api private\n */\n\nSocket.prototype.ack = function(id){\n  var self = this;\n  var sent = false;\n  return function(){\n    // prevent double callbacks\n    if (sent) return;\n    var args = Array.prototype.slice.call(arguments);\n    debug('sending ack %j', args);\n\n    var type = hasBin(args) ? parser.BINARY_ACK : parser.ACK;\n    self.packet({\n      id: id,\n      type: type,\n      data: args\n    });\n\n    sent = true;\n  };\n};\n\n/**\n * Called upon ack packet.\n *\n * @api private\n */\n\nSocket.prototype.onack = function(packet){\n  var ack = this.acks[packet.id];\n  if ('function' == typeof ack) {\n    debug('calling ack %s with %j', packet.id, packet.data);\n    ack.apply(this, packet.data);\n    delete this.acks[packet.id];\n  } else {\n    debug('bad ack %s', packet.id);\n  }\n};\n\n/**\n * Called upon client disconnect packet.\n *\n * @api private\n */\n\nSocket.prototype.ondisconnect = function(){\n  debug('got disconnect packet');\n  this.onclose('client namespace disconnect');\n};\n\n/**\n * Handles a client error.\n *\n * @api private\n */\n\nSocket.prototype.onerror = function(err){\n  if (this.listeners('error').length) {\n    this.emit('error', err);\n  } else {\n    console.error('Missing error handler on `socket`.');\n    console.error(err.stack);\n  }\n};\n\n/**\n * Called upon closing. Called by `Client`.\n *\n * @param {String} reason\n * @throw {Error} optional error object\n * @api private\n */\n\nSocket.prototype.onclose = function(reason){\n  if (!this.connected) return this;\n  debug('closing socket - reason %s', reason);\n  this.emit('disconnecting', reason);\n  this.leaveAll();\n  this.nsp.remove(this);\n  this.client.remove(this);\n  this.connected = false;\n  this.disconnected = true;\n  delete this.nsp.connected[this.id];\n  this.emit('disconnect', reason);\n};\n\n/**\n * Produces an `error` packet.\n *\n * @param {Object} err error object\n * @api private\n */\n\nSocket.prototype.error = function(err){\n  this.packet({ type: parser.ERROR, data: err });\n};\n\n/**\n * Disconnects this client.\n *\n * @param {Boolean} close if `true`, closes the underlying connection\n * @return {Socket} self\n * @api public\n */\n\nSocket.prototype.disconnect = function(close){\n  if (!this.connected) return this;\n  if (close) {\n    this.client.disconnect();\n  } else {\n    this.packet({ type: parser.DISCONNECT });\n    this.onclose('server namespace disconnect');\n  }\n  return this;\n};\n\n/**\n * Sets the compress flag.\n *\n * @param {Boolean} compress if `true`, compresses the sending data\n * @return {Socket} self\n * @api public\n */\n\nSocket.prototype.compress = function(compress){\n  this.flags = this.flags || {};\n  this.flags.compress = compress;\n  return this;\n};\n\n/**\n * Dispatch incoming event to socket listeners.\n *\n * @param {Array} event that will get emitted\n * @api private\n */\n\nSocket.prototype.dispatch = function(event){\n  debug('dispatching an event %j', event);\n  var self = this;\n  this.run(event, function(err){\n    process.nextTick(function(){\n      if (err) {\n        return self.error(err.data || err.message);\n      }\n      emit.apply(self, event);\n    });\n  });\n}\n\n/**\n * Sets up socket middleware.\n *\n * @param {Function} middleware function (event, next)\n * @return {Socket} self\n * @api public\n */\n\nSocket.prototype.use = function(fn){\n  this.fns.push(fn);\n  return this;\n};\n\n/**\n * Executes the middleware for an incoming event.\n *\n * @param {Array} event that will get emitted\n * @param {Function} last fn call in the middleware\n * @api private\n */\nSocket.prototype.run = function(event, fn){\n  var fns = this.fns.slice(0);\n  if (!fns.length) return fn(null);\n\n  function run(i){\n    fns[i](event, function(err){\n      // upon error, short-circuit\n      if (err) return fn(err);\n\n      // if no middleware left, summon callback\n      if (!fns[i + 1]) return fn(null);\n\n      // go on to next\n      run(i + 1);\n    });\n  }\n\n  run(0);\n};\n"]}