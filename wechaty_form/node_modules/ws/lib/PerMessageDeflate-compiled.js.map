{"version":3,"sources":["PerMessageDeflate.js"],"names":[],"mappings":"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","file":"PerMessageDeflate-compiled.js","sourcesContent":["'use strict';\n\nconst safeBuffer = require('safe-buffer');\nconst zlib = require('zlib');\n\nconst bufferUtil = require('./BufferUtil');\n\nconst Buffer = safeBuffer.Buffer;\n\nconst AVAILABLE_WINDOW_BITS = [8, 9, 10, 11, 12, 13, 14, 15];\nconst TRAILER = Buffer.from([0x00, 0x00, 0xff, 0xff]);\nconst EMPTY_BLOCK = Buffer.from([0x00]);\nconst DEFAULT_WINDOW_BITS = 15;\nconst DEFAULT_MEM_LEVEL = 8;\n\n/**\n * Per-message Deflate implementation.\n */\nclass PerMessageDeflate {\n  constructor (options, isServer, maxPayload) {\n    this._options = options || {};\n    this._isServer = !!isServer;\n    this._inflate = null;\n    this._deflate = null;\n    this.params = null;\n    this._maxPayload = maxPayload || 0;\n    this.threshold = this._options.threshold === undefined ? 1024 : this._options.threshold;\n  }\n\n  static get extensionName () {\n    return 'permessage-deflate';\n  }\n\n  /**\n   * Create extension parameters offer.\n   *\n   * @return {Object} Extension parameters\n   * @public\n   */\n  offer () {\n    const params = {};\n\n    if (this._options.serverNoContextTakeover) {\n      params.server_no_context_takeover = true;\n    }\n    if (this._options.clientNoContextTakeover) {\n      params.client_no_context_takeover = true;\n    }\n    if (this._options.serverMaxWindowBits) {\n      params.server_max_window_bits = this._options.serverMaxWindowBits;\n    }\n    if (this._options.clientMaxWindowBits) {\n      params.client_max_window_bits = this._options.clientMaxWindowBits;\n    } else if (this._options.clientMaxWindowBits == null) {\n      params.client_max_window_bits = true;\n    }\n\n    return params;\n  }\n\n  /**\n   * Accept extension offer.\n   *\n   * @param {Array} paramsList Extension parameters\n   * @return {Object} Accepted configuration\n   * @public\n   */\n  accept (paramsList) {\n    paramsList = this.normalizeParams(paramsList);\n\n    var params;\n    if (this._isServer) {\n      params = this.acceptAsServer(paramsList);\n    } else {\n      params = this.acceptAsClient(paramsList);\n    }\n\n    this.params = params;\n    return params;\n  }\n\n  /**\n   * Releases all resources used by the extension.\n   *\n   * @public\n   */\n  cleanup () {\n    if (this._inflate) {\n      if (this._inflate.writeInProgress) {\n        this._inflate.pendingClose = true;\n      } else {\n        this._inflate.close();\n        this._inflate = null;\n      }\n    }\n    if (this._deflate) {\n      if (this._deflate.writeInProgress) {\n        this._deflate.pendingClose = true;\n      } else {\n        this._deflate.close();\n        this._deflate = null;\n      }\n    }\n  }\n\n  /**\n   * Accept extension offer from client.\n   *\n   * @param {Array} paramsList Extension parameters\n   * @return {Object} Accepted configuration\n   * @private\n   */\n  acceptAsServer (paramsList) {\n    const accepted = {};\n    const result = paramsList.some((params) => {\n      if ((\n        this._options.serverNoContextTakeover === false &&\n        params.server_no_context_takeover\n      ) || (\n        this._options.serverMaxWindowBits === false &&\n        params.server_max_window_bits\n      ) || (\n        typeof this._options.serverMaxWindowBits === 'number' &&\n        typeof params.server_max_window_bits === 'number' &&\n        this._options.serverMaxWindowBits > params.server_max_window_bits\n      ) || (\n        typeof this._options.clientMaxWindowBits === 'number' &&\n        !params.client_max_window_bits\n      )) {\n        return;\n      }\n\n      if (\n        this._options.serverNoContextTakeover ||\n        params.server_no_context_takeover\n      ) {\n        accepted.server_no_context_takeover = true;\n      }\n      if (this._options.clientNoContextTakeover) {\n        accepted.client_no_context_takeover = true;\n      }\n      if (\n        this._options.clientNoContextTakeover !== false &&\n        params.client_no_context_takeover\n      ) {\n        accepted.client_no_context_takeover = true;\n      }\n      if (typeof this._options.serverMaxWindowBits === 'number') {\n        accepted.server_max_window_bits = this._options.serverMaxWindowBits;\n      } else if (typeof params.server_max_window_bits === 'number') {\n        accepted.server_max_window_bits = params.server_max_window_bits;\n      }\n      if (typeof this._options.clientMaxWindowBits === 'number') {\n        accepted.client_max_window_bits = this._options.clientMaxWindowBits;\n      } else if (\n        this._options.clientMaxWindowBits !== false &&\n        typeof params.client_max_window_bits === 'number'\n      ) {\n        accepted.client_max_window_bits = params.client_max_window_bits;\n      }\n      return true;\n    });\n\n    if (!result) throw new Error(`Doesn't support the offered configuration`);\n\n    return accepted;\n  }\n\n  /**\n   * Accept extension response from server.\n   *\n   * @param {Array} paramsList Extension parameters\n   * @return {Object} Accepted configuration\n   * @private\n   */\n  acceptAsClient (paramsList) {\n    const params = paramsList[0];\n\n    if (this._options.clientNoContextTakeover != null) {\n      if (\n        this._options.clientNoContextTakeover === false &&\n        params.client_no_context_takeover\n      ) {\n        throw new Error('Invalid value for \"client_no_context_takeover\"');\n      }\n    }\n    if (this._options.clientMaxWindowBits != null) {\n      if (\n        this._options.clientMaxWindowBits === false &&\n        params.client_max_window_bits\n      ) {\n        throw new Error('Invalid value for \"client_max_window_bits\"');\n      }\n      if (\n        typeof this._options.clientMaxWindowBits === 'number' && (\n        !params.client_max_window_bits ||\n        params.client_max_window_bits > this._options.clientMaxWindowBits\n      )) {\n        throw new Error('Invalid value for \"client_max_window_bits\"');\n      }\n    }\n\n    return params;\n  }\n\n  /**\n   * Normalize extensions parameters.\n   *\n   * @param {Array} paramsList Extension parameters\n   * @return {Array} Normalized extensions parameters\n   * @private\n   */\n  normalizeParams (paramsList) {\n    return paramsList.map((params) => {\n      Object.keys(params).forEach((key) => {\n        var value = params[key];\n        if (value.length > 1) {\n          throw new Error(`Multiple extension parameters for ${key}`);\n        }\n\n        value = value[0];\n\n        switch (key) {\n          case 'server_no_context_takeover':\n          case 'client_no_context_takeover':\n            if (value !== true) {\n              throw new Error(`invalid extension parameter value for ${key} (${value})`);\n            }\n            params[key] = true;\n            break;\n          case 'server_max_window_bits':\n          case 'client_max_window_bits':\n            if (typeof value === 'string') {\n              value = parseInt(value, 10);\n              if (!~AVAILABLE_WINDOW_BITS.indexOf(value)) {\n                throw new Error(`invalid extension parameter value for ${key} (${value})`);\n              }\n            }\n            if (!this._isServer && value === true) {\n              throw new Error(`Missing extension parameter value for ${key}`);\n            }\n            params[key] = value;\n            break;\n          default:\n            throw new Error(`Not defined extension parameter (${key})`);\n        }\n      });\n      return params;\n    });\n  }\n\n  /**\n   * Decompress data.\n   *\n   * @param {Buffer} data Compressed data\n   * @param {Boolean} fin Specifies whether or not this is the last fragment\n   * @param {Function} callback Callback\n   * @public\n   */\n  decompress (data, fin, callback) {\n    const endpoint = this._isServer ? 'client' : 'server';\n\n    if (!this._inflate) {\n      const maxWindowBits = this.params[`${endpoint}_max_window_bits`];\n      this._inflate = zlib.createInflateRaw({\n        windowBits: typeof maxWindowBits === 'number' ? maxWindowBits : DEFAULT_WINDOW_BITS\n      });\n    }\n    this._inflate.writeInProgress = true;\n\n    var totalLength = 0;\n    const buffers = [];\n    var err;\n\n    const onData = (data) => {\n      totalLength += data.length;\n      if (this._maxPayload < 1 || totalLength <= this._maxPayload) {\n        return buffers.push(data);\n      }\n\n      err = new Error('max payload size exceeded');\n      err.closeCode = 1009;\n      this._inflate.reset();\n    };\n\n    const onError = (err) => {\n      cleanup();\n      callback(err);\n    };\n\n    const cleanup = () => {\n      if (!this._inflate) return;\n\n      this._inflate.removeListener('error', onError);\n      this._inflate.removeListener('data', onData);\n      this._inflate.writeInProgress = false;\n\n      if (\n        (fin && this.params[`${endpoint}_no_context_takeover`]) ||\n        this._inflate.pendingClose\n      ) {\n        this._inflate.close();\n        this._inflate = null;\n      }\n    };\n\n    this._inflate.on('error', onError).on('data', onData);\n    this._inflate.write(data);\n    if (fin) this._inflate.write(TRAILER);\n\n    this._inflate.flush(() => {\n      cleanup();\n      if (err) callback(err);\n      else callback(null, bufferUtil.concat(buffers, totalLength));\n    });\n  }\n\n  /**\n   * Compress data.\n   *\n   * @param {Buffer} data Data to compress\n   * @param {Boolean} fin Specifies whether or not this is the last fragment\n   * @param {Function} callback Callback\n   * @public\n   */\n  compress (data, fin, callback) {\n    if (!data || data.length === 0) {\n      process.nextTick(callback, null, EMPTY_BLOCK);\n      return;\n    }\n\n    const endpoint = this._isServer ? 'server' : 'client';\n\n    if (!this._deflate) {\n      const maxWindowBits = this.params[`${endpoint}_max_window_bits`];\n      this._deflate = zlib.createDeflateRaw({\n        flush: zlib.Z_SYNC_FLUSH,\n        windowBits: typeof maxWindowBits === 'number' ? maxWindowBits : DEFAULT_WINDOW_BITS,\n        memLevel: this._options.memLevel || DEFAULT_MEM_LEVEL\n      });\n    }\n    this._deflate.writeInProgress = true;\n\n    var totalLength = 0;\n    const buffers = [];\n\n    const onData = (data) => {\n      totalLength += data.length;\n      buffers.push(data);\n    };\n\n    const onError = (err) => {\n      cleanup();\n      callback(err);\n    };\n\n    const cleanup = () => {\n      if (!this._deflate) return;\n\n      this._deflate.removeListener('error', onError);\n      this._deflate.removeListener('data', onData);\n      this._deflate.writeInProgress = false;\n\n      if (\n        (fin && this.params[`${endpoint}_no_context_takeover`]) ||\n        this._deflate.pendingClose\n      ) {\n        this._deflate.close();\n        this._deflate = null;\n      }\n    };\n\n    this._deflate.on('error', onError).on('data', onData);\n    this._deflate.write(data);\n    this._deflate.flush(zlib.Z_SYNC_FLUSH, () => {\n      cleanup();\n      var data = bufferUtil.concat(buffers, totalLength);\n      if (fin) data = data.slice(0, data.length - 4);\n      callback(null, data);\n    });\n  }\n}\n\nmodule.exports = PerMessageDeflate;\n"]}